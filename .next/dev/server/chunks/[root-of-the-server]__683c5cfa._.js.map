{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/documind/types.ts"],"sourcesContent":["// ============================================\r\n// DOCUMIND ENGINE - TYPE DEFINITIONS\r\n// Version 1.0.0\r\n// ============================================\r\n\r\n// ============================================\r\n// INPUT TYPES\r\n// ============================================\r\n\r\nexport interface ParseRequest {\r\n  // One of these is required\r\n  file?: File | Buffer\r\n  url?: string\r\n  base64?: string\r\n\r\n  // Options\r\n  options?: ParseOptions\r\n\r\n  // Caller identification\r\n  app_id: string\r\n  request_id?: string\r\n  webhook_url?: string\r\n}\r\n\r\nexport interface ParseOptions {\r\n  ocr_enabled?: boolean // Default: true\r\n  ocr_language?: string // Default: 'en'\r\n  extract_tables?: boolean // Default: true\r\n  extract_forms?: boolean // Default: true\r\n  extract_images?: boolean // Default: false\r\n  max_pages?: number // Default: unlimited\r\n  password?: string // For encrypted PDFs\r\n  priority?: \"low\" | \"normal\" | \"high\" // Queue priority\r\n}\r\n\r\nexport interface FileMetadata {\r\n  file_id: string\r\n  original_name: string\r\n  mime_type: string\r\n  size_bytes: number\r\n  storage_url: string\r\n  uploaded_at: string\r\n}\r\n\r\n// ============================================\r\n// OUTPUT TYPES\r\n// ============================================\r\n\r\nexport interface ParsedDocument {\r\n  document_id: string\r\n  status: DocumentStatus\r\n  metadata: DocumentMetadata\r\n  fingerprints: DocumentFingerprints\r\n  pages: ParsedPage[]\r\n  layout: DocumentLayout\r\n  form_fields: FormField[]\r\n  processing: ProcessingInfo\r\n}\r\n\r\nexport type DocumentStatus = \"pending\" | \"processing\" | \"complete\" | \"partial\" | \"failed\"\r\n\r\nexport interface DocumentMetadata {\r\n  title: string | null\r\n  author: string | null\r\n  subject: string | null\r\n  creator: string | null\r\n  producer: string | null\r\n  creation_date: string | null\r\n  modification_date: string | null\r\n  page_count: number\r\n  pdf_version: string | null\r\n  is_encrypted: boolean\r\n  is_scanned: boolean\r\n  detected_language: string\r\n  detected_type: DocumentType\r\n}\r\n\r\nexport type DocumentType =\r\n  | \"form\"\r\n  | \"contract\"\r\n  | \"tender\"\r\n  | \"boq\"\r\n  | \"specification\"\r\n  | \"letter\"\r\n  | \"report\"\r\n  | \"invoice\"\r\n  | \"certificate\"\r\n  | \"unknown\"\r\n\r\nexport interface DocumentFingerprints {\r\n  structure_hash: string\r\n  layout_hash: string\r\n  form_hash: string | null\r\n  table_hash: string | null\r\n  content_hash: string\r\n}\r\n\r\nexport interface ProcessingInfo {\r\n  duration_ms: number\r\n  ocr_used: boolean\r\n  ocr_engine: string | null\r\n  ocr_confidence: number | null\r\n  warnings: string[]\r\n  pages_processed: number\r\n  pages_skipped: number\r\n}\r\n\r\n// ============================================\r\n// PAGE TYPES\r\n// ============================================\r\n\r\nexport interface ParsedPage {\r\n  page_number: number\r\n  width: number\r\n  height: number\r\n  rotation: number\r\n  content: PageContent\r\n  is_scanned: boolean\r\n  ocr_confidence: number | null\r\n}\r\n\r\nexport interface PageContent {\r\n  full_text: string\r\n  text_blocks: TextBlock[]\r\n  lines: LineElement[]\r\n  rectangles: RectElement[]\r\n  images: ImageElement[]\r\n}\r\n\r\nexport interface TextBlock {\r\n  id: string\r\n  text: string\r\n  position: BoundingBox\r\n  position_normalized: NormalizedBox\r\n  font: FontInfo\r\n  block_type: TextBlockType\r\n  line_index: number\r\n  paragraph_index: number\r\n  confidence: number | null\r\n  words: WordInfo[] | null\r\n}\r\n\r\nexport type TextBlockType =\r\n  | \"heading_1\"\r\n  | \"heading_2\"\r\n  | \"heading_3\"\r\n  | \"paragraph\"\r\n  | \"label\"\r\n  | \"value\"\r\n  | \"table_header\"\r\n  | \"table_cell\"\r\n  | \"list_item\"\r\n  | \"footer\"\r\n  | \"header\"\r\n  | \"page_number\"\r\n  | \"unknown\"\r\n\r\nexport interface BoundingBox {\r\n  x: number\r\n  y: number\r\n  width: number\r\n  height: number\r\n}\r\n\r\nexport interface NormalizedBox {\r\n  x: number // 0-1 (left to right)\r\n  y: number // 0-1 (top to bottom)\r\n  width: number // 0-1\r\n  height: number // 0-1\r\n}\r\n\r\nexport interface FontInfo {\r\n  name: string\r\n  family: string | null\r\n  size: number\r\n  weight: \"normal\" | \"bold\"\r\n  style: \"normal\" | \"italic\"\r\n  color: string\r\n}\r\n\r\nexport interface WordInfo {\r\n  text: string\r\n  position: BoundingBox\r\n  confidence: number\r\n}\r\n\r\nexport interface LineElement {\r\n  id: string\r\n  type: \"horizontal\" | \"vertical\" | \"diagonal\"\r\n  start: { x: number; y: number }\r\n  end: { x: number; y: number }\r\n  thickness: number\r\n  color: string\r\n  style: \"solid\" | \"dashed\" | \"dotted\"\r\n  is_form_line: boolean\r\n  associated_label_id: string | null\r\n}\r\n\r\nexport interface RectElement {\r\n  id: string\r\n  position: BoundingBox\r\n  fill_color: string | null\r\n  stroke_color: string | null\r\n  stroke_width: number\r\n  rect_type: RectType\r\n}\r\n\r\nexport type RectType = \"checkbox\" | \"text_box\" | \"table_cell\" | \"border\" | \"highlight\" | \"unknown\"\r\n\r\nexport interface ImageElement {\r\n  id: string\r\n  position: BoundingBox\r\n  position_normalized: NormalizedBox\r\n  width_px: number\r\n  height_px: number\r\n  format: string\r\n  data_url?: string\r\n}\r\n\r\n// ============================================\r\n// LAYOUT TYPES\r\n// ============================================\r\n\r\nexport interface DocumentLayout {\r\n  document_type: DocumentType\r\n  title: TextBlock | null\r\n  sections: DocumentSection[]\r\n  table_regions: TableRegion[]\r\n  form_regions: FormRegion[]\r\n  reading_order: string[]\r\n}\r\n\r\nexport interface DocumentSection {\r\n  id: string\r\n  title: string\r\n  level: number\r\n  page_start: number\r\n  page_end: number\r\n  block_ids: string[]\r\n  subsections: DocumentSection[]\r\n}\r\n\r\nexport interface TableRegion {\r\n  id: string\r\n  page: number\r\n  position: BoundingBox\r\n  position_normalized: NormalizedBox\r\n  row_count_estimate: number\r\n  column_count_estimate: number\r\n  has_header: boolean\r\n  extraction_status: \"pending\" | \"complete\"\r\n  table_data: any | null\r\n}\r\n\r\nexport interface FormRegion {\r\n  id: string\r\n  page: number\r\n  position: BoundingBox\r\n  position_normalized: NormalizedBox\r\n  detected_fields: DetectedField[]\r\n}\r\n\r\nexport interface DetectedField {\r\n  id: string\r\n  label: {\r\n    text: string\r\n    block_id: string\r\n    position: BoundingBox\r\n    position_normalized: NormalizedBox\r\n  }\r\n  input: {\r\n    type: InputType\r\n    position: BoundingBox\r\n    position_normalized: NormalizedBox\r\n    native_field_id: string | null\r\n  }\r\n  detection_method: DetectionMethod\r\n  confidence: number\r\n  suggested_type: FieldDataType\r\n}\r\n\r\nexport type InputType = \"text_line\" | \"text_box\" | \"checkbox\" | \"radio\" | \"signature\" | \"date\" | \"native_field\"\r\n\r\nexport type DetectionMethod =\r\n  | \"pdf_native\"\r\n  | \"line_detection\"\r\n  | \"box_detection\"\r\n  | \"pattern_matching\"\r\n  | \"ai_vision\"\r\n  | \"template_match\"\r\n\r\nexport type FieldDataType =\r\n  | \"text\"\r\n  | \"number\"\r\n  | \"currency\"\r\n  | \"date\"\r\n  | \"email\"\r\n  | \"phone\"\r\n  | \"checkbox\"\r\n  | \"signature\"\r\n  | \"address\"\r\n  | \"name\"\r\n  | \"company\"\r\n  | \"id_number\"\r\n  | \"unknown\"\r\n\r\n// ============================================\r\n// FORM FIELD TYPES (Native PDF Fields)\r\n// ============================================\r\n\r\nexport interface FormField {\r\n  id: string\r\n  name: string\r\n  type: FormFieldType\r\n  page: number\r\n  position: BoundingBox\r\n  position_normalized: NormalizedBox\r\n  value: string | boolean | string[] | null\r\n  default_value: string | boolean | string[] | null\r\n  is_required: boolean\r\n  is_readonly: boolean\r\n  max_length: number | null\r\n  options: FormFieldOption[]\r\n  font: FontInfo | null\r\n  text_alignment: \"left\" | \"center\" | \"right\"\r\n  format: string | null\r\n}\r\n\r\nexport type FormFieldType = \"text\" | \"textarea\" | \"checkbox\" | \"radio\" | \"select\" | \"signature\" | \"date\" | \"button\"\r\n\r\nexport interface FormFieldOption {\r\n  value: string\r\n  label: string\r\n  is_default: boolean\r\n}\r\n\r\n// ============================================\r\n// TEMPLATE TYPES\r\n// ============================================\r\n\r\nexport interface DocumentTemplate {\r\n  id: string\r\n  name: string\r\n  code: string | null\r\n  category: string\r\n  subcategory: string | null\r\n  fingerprint_structure: string\r\n  fingerprint_layout: string | null\r\n  match_threshold: number\r\n  field_mappings: TemplateFieldMapping[]\r\n  page_count: number | null\r\n  description: string | null\r\n  version: string | null\r\n  usage_count: number\r\n  accuracy_score: number | null\r\n  is_system: boolean\r\n  is_public: boolean\r\n  created_at: string\r\n  updated_at: string\r\n}\r\n\r\nexport interface TemplateFieldMapping {\r\n  field_id: string\r\n  field_name: string\r\n  label_pattern: string\r\n  page: number\r\n  position_normalized: NormalizedBox\r\n  data_type: FieldDataType\r\n  is_required: boolean\r\n  validation_regex?: string\r\n  profile_mapping?: string // Maps to company profile field\r\n}\r\n\r\nexport interface TemplateMatch {\r\n  template_id: string\r\n  template_name: string\r\n  template_code: string | null\r\n  match_score: number\r\n  matched_fields: number\r\n  total_fields: number\r\n  field_matches: TemplateFieldMatch[]\r\n}\r\n\r\nexport interface TemplateFieldMatch {\r\n  template_field_id: string\r\n  template_field_name: string\r\n  detected_field_id: string | null\r\n  match_confidence: number\r\n}\r\n\r\n// ============================================\r\n// JOB/QUEUE TYPES\r\n// ============================================\r\n\r\nexport interface ProcessingJob {\r\n  id: string\r\n  document_id: string | null\r\n  file_url: string\r\n  options: ParseOptions\r\n  app_id: string\r\n  request_id: string | null\r\n  webhook_url: string | null\r\n  priority: \"low\" | \"normal\" | \"high\"\r\n  status: JobStatus\r\n  current_stage: ProcessingStage | null\r\n  progress_percent: number\r\n  progress_message: string | null\r\n  attempt: number\r\n  max_attempts: number\r\n  last_error: string | null\r\n  created_at: string\r\n  started_at: string | null\r\n  completed_at: string | null\r\n}\r\n\r\nexport type JobStatus = \"queued\" | \"processing\" | \"complete\" | \"failed\" | \"cancelled\"\r\n\r\nexport type ProcessingStage =\r\n  | \"uploading\"\r\n  | \"validating\"\r\n  | \"parsing\"\r\n  | \"ocr\"\r\n  | \"analyzing_layout\"\r\n  | \"detecting_fields\"\r\n  | \"fingerprinting\"\r\n  | \"matching_templates\"\r\n  | \"finalizing\"\r\n\r\n// ============================================\r\n// ERROR TYPES\r\n// ============================================\r\n\r\nexport interface DocuMindError {\r\n  code: ErrorCode\r\n  message: string\r\n  details?: Record<string, any>\r\n  recoverable: boolean\r\n}\r\n\r\nexport type ErrorCode =\r\n  // File errors\r\n  | \"FILE_TOO_LARGE\"\r\n  | \"UNSUPPORTED_FORMAT\"\r\n  | \"CORRUPTED_FILE\"\r\n  | \"PASSWORD_PROTECTED\"\r\n  | \"INVALID_PASSWORD\"\r\n  // Processing errors\r\n  | \"PARSE_FAILED\"\r\n  | \"OCR_FAILED\"\r\n  | \"TIMEOUT\"\r\n  | \"OUT_OF_MEMORY\"\r\n  // Service errors\r\n  | \"SERVICE_UNAVAILABLE\"\r\n  | \"RATE_LIMITED\"\r\n  | \"QUOTA_EXCEEDED\"\r\n  // Validation errors\r\n  | \"INVALID_REQUEST\"\r\n  | \"MISSING_REQUIRED_FIELD\"\r\n  | \"INVALID_OPTIONS\"\r\n  // Not found errors\r\n  | \"DOCUMENT_NOT_FOUND\"\r\n  | \"TEMPLATE_NOT_FOUND\"\r\n  | \"JOB_NOT_FOUND\"\r\n\r\n// ============================================\r\n// API RESPONSE TYPES\r\n// ============================================\r\n\r\nexport interface ApiResponse<T> {\r\n  success: boolean\r\n  data?: T\r\n  error?: DocuMindError\r\n  meta?: {\r\n    request_id: string\r\n    processing_time_ms: number\r\n  }\r\n}\r\n\r\nexport interface PaginatedResponse<T> {\r\n  items: T[]\r\n  total: number\r\n  limit: number\r\n  offset: number\r\n  has_more: boolean\r\n}\r\n\r\n// ============================================\r\n// INTEGRATION CONTRACTS (for other engines)\r\n// ============================================\r\n\r\n// What DocuMind provides to FormFlow\r\nexport interface FormFlowContract {\r\n  document_id: string\r\n  pages: Array<{\r\n    page_number: number\r\n    width: number\r\n    height: number\r\n  }>\r\n  detected_fields: DetectedField[]\r\n  form_fields: FormField[]\r\n  template_match: TemplateMatch | null\r\n}\r\n\r\n// What DocuMind provides to TableSense\r\nexport interface TableSenseContract {\r\n  document_id: string\r\n  table_regions: TableRegion[]\r\n  page_dimensions: Array<{\r\n    page_number: number\r\n    width: number\r\n    height: number\r\n  }>\r\n}\r\n\r\n// What DocuMind provides to ThinkEngine\r\nexport interface ThinkEngineContract {\r\n  document_id: string\r\n  full_text: string\r\n  sections: DocumentSection[]\r\n  metadata: DocumentMetadata\r\n  detected_type: DocumentType\r\n}\r\n"],"names":[],"mappings":"AAAA,+CAA+C;AAC/C,qCAAqC;AACrC,gBAAgB;AAChB,+CAA+C;AAE/C,+CAA+C;AAC/C,cAAc;AACd,+CAA+C"}},
    {"offset": {"line": 53, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/documind/errors.ts"],"sourcesContent":["// ============================================\r\n// DOCUMIND ENGINE - ERROR HANDLING\r\n// ============================================\r\n\r\nimport type { DocuMindError, ErrorCode } from \"./types\"\r\n\r\n// Error factory functions\r\nexport function createError(\r\n  code: ErrorCode,\r\n  message: string,\r\n  details?: Record<string, any>,\r\n  recoverable = false,\r\n): DocuMindError {\r\n  return {\r\n    code,\r\n    message,\r\n    details,\r\n    recoverable,\r\n  }\r\n}\r\n\r\n// Pre-defined errors\r\nexport const Errors = {\r\n  // File errors\r\n  fileTooLarge: (maxSize: number, actualSize: number) =>\r\n    createError(\r\n      \"FILE_TOO_LARGE\",\r\n      `File size ${actualSize} bytes exceeds maximum ${maxSize} bytes`,\r\n      { max_size: maxSize, actual_size: actualSize },\r\n      false,\r\n    ),\r\n\r\n  unsupportedFormat: (format: string) =>\r\n    createError(\"UNSUPPORTED_FORMAT\", `File format '${format}' is not supported`, { format }, false),\r\n\r\n  corruptedFile: (reason?: string) =>\r\n    createError(\"CORRUPTED_FILE\", reason || \"The file appears to be corrupted or invalid\", { reason }, false),\r\n\r\n  passwordProtected: () =>\r\n    createError(\"PASSWORD_PROTECTED\", \"The PDF is password protected. Please provide the password.\", undefined, true),\r\n\r\n  invalidPassword: () => createError(\"INVALID_PASSWORD\", \"The provided password is incorrect\", undefined, true),\r\n\r\n  // Processing errors\r\n  parseFailed: (stage: string, reason: string) =>\r\n    createError(\"PARSE_FAILED\", `Failed to parse document at stage '${stage}': ${reason}`, { stage, reason }, false),\r\n\r\n  ocrFailed: (reason: string) => createError(\"OCR_FAILED\", `OCR processing failed: ${reason}`, { reason }, true),\r\n\r\n  timeout: (stage: string, timeoutMs: number) =>\r\n    createError(\r\n      \"TIMEOUT\",\r\n      `Processing timed out at stage '${stage}' after ${timeoutMs}ms`,\r\n      { stage, timeout_ms: timeoutMs },\r\n      true,\r\n    ),\r\n\r\n  outOfMemory: () =>\r\n    createError(\"OUT_OF_MEMORY\", \"Document is too complex to process. Try reducing page count.\", undefined, false),\r\n\r\n  // Service errors\r\n  serviceUnavailable: (service: string) =>\r\n    createError(\"SERVICE_UNAVAILABLE\", `Service '${service}' is currently unavailable`, { service }, true),\r\n\r\n  rateLimited: (retryAfter: number) =>\r\n    createError(\r\n      \"RATE_LIMITED\",\r\n      `Rate limit exceeded. Please retry after ${retryAfter} seconds`,\r\n      { retry_after: retryAfter },\r\n      true,\r\n    ),\r\n\r\n  quotaExceeded: (quota: string) =>\r\n    createError(\"QUOTA_EXCEEDED\", `Quota '${quota}' has been exceeded`, { quota }, false),\r\n\r\n  // Validation errors\r\n  invalidRequest: (reason: string) => createError(\"INVALID_REQUEST\", `Invalid request: ${reason}`, { reason }, false),\r\n\r\n  missingRequiredField: (field: string) =>\r\n    createError(\"MISSING_REQUIRED_FIELD\", `Required field '${field}' is missing`, { field }, false),\r\n\r\n  invalidOptions: (option: string, reason: string) =>\r\n    createError(\"INVALID_OPTIONS\", `Invalid option '${option}': ${reason}`, { option, reason }, false),\r\n\r\n  // Not found errors\r\n  documentNotFound: (documentId: string) =>\r\n    createError(\"DOCUMENT_NOT_FOUND\", `Document '${documentId}' not found`, { document_id: documentId }, false),\r\n\r\n  templateNotFound: (templateId: string) =>\r\n    createError(\"TEMPLATE_NOT_FOUND\", `Template '${templateId}' not found`, { template_id: templateId }, false),\r\n\r\n  jobNotFound: (jobId: string) => createError(\"JOB_NOT_FOUND\", `Job '${jobId}' not found`, { job_id: jobId }, false),\r\n}\r\n\r\n// Error logging\r\nexport interface ErrorLogEntry {\r\n  document_id?: string\r\n  job_id?: string\r\n  app_id: string\r\n  request_id?: string\r\n  error_code: ErrorCode\r\n  error_message: string\r\n  stack_trace?: string\r\n  processing_stage?: string\r\n  file_info?: {\r\n    filename?: string\r\n    mime_type?: string\r\n    size?: number\r\n  }\r\n  occurred_at: string\r\n}\r\n\r\nexport function formatErrorLog(\r\n  error: DocuMindError,\r\n  context: {\r\n    document_id?: string\r\n    job_id?: string\r\n    app_id: string\r\n    request_id?: string\r\n    processing_stage?: string\r\n    file_info?: Record<string, any>\r\n  },\r\n): ErrorLogEntry {\r\n  return {\r\n    document_id: context.document_id,\r\n    job_id: context.job_id,\r\n    app_id: context.app_id,\r\n    request_id: context.request_id,\r\n    error_code: error.code,\r\n    error_message: error.message,\r\n    processing_stage: context.processing_stage,\r\n    file_info: context.file_info,\r\n    occurred_at: new Date().toISOString(),\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,+CAA+C;AAC/C,mCAAmC;AACnC,+CAA+C;;;;;;;;;AAKxC,SAAS,YACd,IAAe,EACf,OAAe,EACf,OAA6B,EAC7B,cAAc,KAAK;IAEnB,OAAO;QACL;QACA;QACA;QACA;IACF;AACF;AAGO,MAAM,SAAS;IACpB,cAAc;IACd,cAAc,CAAC,SAAiB,aAC9B,YACE,kBACA,CAAC,UAAU,EAAE,WAAW,uBAAuB,EAAE,QAAQ,MAAM,CAAC,EAChE;YAAE,UAAU;YAAS,aAAa;QAAW,GAC7C;IAGJ,mBAAmB,CAAC,SAClB,YAAY,sBAAsB,CAAC,aAAa,EAAE,OAAO,kBAAkB,CAAC,EAAE;YAAE;QAAO,GAAG;IAE5F,eAAe,CAAC,SACd,YAAY,kBAAkB,UAAU,+CAA+C;YAAE;QAAO,GAAG;IAErG,mBAAmB,IACjB,YAAY,sBAAsB,+DAA+D,WAAW;IAE9G,iBAAiB,IAAM,YAAY,oBAAoB,sCAAsC,WAAW;IAExG,oBAAoB;IACpB,aAAa,CAAC,OAAe,SAC3B,YAAY,gBAAgB,CAAC,mCAAmC,EAAE,MAAM,GAAG,EAAE,QAAQ,EAAE;YAAE;YAAO;QAAO,GAAG;IAE5G,WAAW,CAAC,SAAmB,YAAY,cAAc,CAAC,uBAAuB,EAAE,QAAQ,EAAE;YAAE;QAAO,GAAG;IAEzG,SAAS,CAAC,OAAe,YACvB,YACE,WACA,CAAC,+BAA+B,EAAE,MAAM,QAAQ,EAAE,UAAU,EAAE,CAAC,EAC/D;YAAE;YAAO,YAAY;QAAU,GAC/B;IAGJ,aAAa,IACX,YAAY,iBAAiB,gEAAgE,WAAW;IAE1G,iBAAiB;IACjB,oBAAoB,CAAC,UACnB,YAAY,uBAAuB,CAAC,SAAS,EAAE,QAAQ,0BAA0B,CAAC,EAAE;YAAE;QAAQ,GAAG;IAEnG,aAAa,CAAC,aACZ,YACE,gBACA,CAAC,wCAAwC,EAAE,WAAW,QAAQ,CAAC,EAC/D;YAAE,aAAa;QAAW,GAC1B;IAGJ,eAAe,CAAC,QACd,YAAY,kBAAkB,CAAC,OAAO,EAAE,MAAM,mBAAmB,CAAC,EAAE;YAAE;QAAM,GAAG;IAEjF,oBAAoB;IACpB,gBAAgB,CAAC,SAAmB,YAAY,mBAAmB,CAAC,iBAAiB,EAAE,QAAQ,EAAE;YAAE;QAAO,GAAG;IAE7G,sBAAsB,CAAC,QACrB,YAAY,0BAA0B,CAAC,gBAAgB,EAAE,MAAM,YAAY,CAAC,EAAE;YAAE;QAAM,GAAG;IAE3F,gBAAgB,CAAC,QAAgB,SAC/B,YAAY,mBAAmB,CAAC,gBAAgB,EAAE,OAAO,GAAG,EAAE,QAAQ,EAAE;YAAE;YAAQ;QAAO,GAAG;IAE9F,mBAAmB;IACnB,kBAAkB,CAAC,aACjB,YAAY,sBAAsB,CAAC,UAAU,EAAE,WAAW,WAAW,CAAC,EAAE;YAAE,aAAa;QAAW,GAAG;IAEvG,kBAAkB,CAAC,aACjB,YAAY,sBAAsB,CAAC,UAAU,EAAE,WAAW,WAAW,CAAC,EAAE;YAAE,aAAa;QAAW,GAAG;IAEvG,aAAa,CAAC,QAAkB,YAAY,iBAAiB,CAAC,KAAK,EAAE,MAAM,WAAW,CAAC,EAAE;YAAE,QAAQ;QAAM,GAAG;AAC9G;AAoBO,SAAS,eACd,KAAoB,EACpB,OAOC;IAED,OAAO;QACL,aAAa,QAAQ,WAAW;QAChC,QAAQ,QAAQ,MAAM;QACtB,QAAQ,QAAQ,MAAM;QACtB,YAAY,QAAQ,UAAU;QAC9B,YAAY,MAAM,IAAI;QACtB,eAAe,MAAM,OAAO;QAC5B,kBAAkB,QAAQ,gBAAgB;QAC1C,WAAW,QAAQ,SAAS;QAC5B,aAAa,IAAI,OAAO,WAAW;IACrC;AACF"}},
    {"offset": {"line": 148, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/documind/constants.ts"],"sourcesContent":["// ============================================\r\n// DOCUMIND ENGINE - CONSTANTS\r\n// ============================================\r\n\r\n// File size limits\r\nexport const MAX_FILE_SIZE = 50 * 1024 * 1024 // 50MB\r\nexport const MAX_PAGES = 500\r\nexport const MAX_FILE_SIZE_FOR_SYNC = 10 * 1024 * 1024 // 10MB - larger files go async\r\n\r\n// Supported MIME types\r\nexport const SUPPORTED_MIME_TYPES = [\r\n  \"application/pdf\",\r\n  \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\", // .docx\r\n  \"application/msword\", // .doc\r\n  \"image/png\",\r\n  \"image/jpeg\",\r\n  \"image/tiff\",\r\n  \"image/webp\",\r\n] as const\r\n\r\nexport type SupportedMimeType = (typeof SUPPORTED_MIME_TYPES)[number]\r\n\r\n// File extensions mapping\r\nexport const MIME_TO_EXTENSION: Record<SupportedMimeType, string> = {\r\n  \"application/pdf\": \".pdf\",\r\n  \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\": \".docx\",\r\n  \"application/msword\": \".doc\",\r\n  \"image/png\": \".png\",\r\n  \"image/jpeg\": \".jpg\",\r\n  \"image/tiff\": \".tiff\",\r\n  \"image/webp\": \".webp\",\r\n}\r\n\r\n// Processing timeouts (ms)\r\nexport const TIMEOUTS = {\r\n  parse: 60000, // 60 seconds\r\n  ocr_per_page: 10000, // 10 seconds per page\r\n  layout_analysis: 30000, // 30 seconds\r\n  total: 300000, // 5 minutes total\r\n}\r\n\r\n// Cache TTLs (seconds)\r\nexport const CACHE_TTL = {\r\n  parsed_document: 86400, // 24 hours\r\n  template_list: 3600, // 1 hour\r\n  fingerprint_match: 86400, // 24 hours\r\n}\r\n\r\n// OCR settings\r\nexport const OCR_CONFIG = {\r\n  default_language: \"eng\",\r\n  confidence_threshold: 0.6, // Below this, mark as low confidence\r\n  min_text_density: 0.01, // Below this, consider page as image/scanned\r\n}\r\n\r\n// Field detection settings\r\nexport const FIELD_DETECTION = {\r\n  min_line_length: 20, // Minimum pixels for a line to be considered\r\n  max_label_distance: 50, // Max pixels between label and field\r\n  min_confidence: 0.5, // Minimum confidence to include a field\r\n}\r\n\r\n// PDF coordinate system\r\nexport const PDF_POINTS_PER_INCH = 72\r\n\r\n// Common SA tender form codes\r\nexport const SA_TENDER_FORMS = {\r\n  SBD1: \"Invitation to Bid\",\r\n  SBD2: \"Tax Clearance Certificate Requirements\",\r\n  SBD3_1: \"Pricing Schedule - Firm Prices\",\r\n  SBD3_2: \"Pricing Schedule - Non-Firm Prices\",\r\n  SBD3_3: \"Pricing Schedule - Professional Services\",\r\n  SBD4: \"Declaration of Interest\",\r\n  SBD5: \"National Industrial Participation Programme\",\r\n  SBD6_1: \"Preference Points Claim Form - Procurement\",\r\n  SBD6_2: \"Declaration for Local Production and Content\",\r\n  SBD7_1: \"Contract Form - Purchase of Goods\",\r\n  SBD7_2: \"Contract Form - Lease of Goods\",\r\n  SBD7_3: \"Contract Form - Rendering of Services\",\r\n  SBD8: \"Declaration of Bidders Past SCM Practices\",\r\n  SBD9: \"Certificate of Independent Bid Determination\",\r\n  MBD1: \"Municipal Invitation to Bid\",\r\n  MBD2: \"Tax Clearance Requirements\",\r\n  MBD4: \"Declaration of Interest\",\r\n  MBD5: \"Declaration for Procurement\",\r\n  MBD6_1: \"Preference Points Claim Form\",\r\n  MBD7_1: \"Contract Form - Purchase\",\r\n  MBD8: \"Declaration of Bidders Past SCM Practices\",\r\n  MBD9: \"Certificate of Independent Bid Determination\",\r\n  CSD: \"Central Supplier Database\",\r\n  CIDB: \"Construction Industry Development Board\",\r\n} as const\r\n\r\n// Document type detection patterns\r\nexport const DOCUMENT_TYPE_PATTERNS = {\r\n  tender: [/tender/i, /bid/i, /rfq/i, /request for quotation/i, /invitation to/i, /procurement/i],\r\n  boq: [/bill of quantities/i, /boq/i, /schedule of quantities/i, /pricing schedule/i],\r\n  contract: [/contract/i, /agreement/i, /terms and conditions/i],\r\n  specification: [/specification/i, /technical requirements/i, /scope of work/i],\r\n  certificate: [/certificate/i, /certification/i, /clearance/i],\r\n  invoice: [/invoice/i, /tax invoice/i, /receipt/i],\r\n  form: [/form/i, /application/i, /declaration/i],\r\n}\r\n\r\n// Rate limits per tier\r\nexport const RATE_LIMITS = {\r\n  free: {\r\n    requests_per_minute: 10,\r\n    requests_per_day: 100,\r\n    max_pages_per_request: 50,\r\n  },\r\n  basic: {\r\n    requests_per_minute: 30,\r\n    requests_per_day: 500,\r\n    max_pages_per_request: 100,\r\n  },\r\n  professional: {\r\n    requests_per_minute: 60,\r\n    requests_per_day: 2000,\r\n    max_pages_per_request: 300,\r\n  },\r\n  enterprise: {\r\n    requests_per_minute: 200,\r\n    requests_per_day: 10000,\r\n    max_pages_per_request: 500,\r\n  },\r\n}\r\n\r\n// API version\r\nexport const API_VERSION = \"v1\"\r\n"],"names":[],"mappings":"AAAA,+CAA+C;AAC/C,8BAA8B;AAC9B,+CAA+C;AAE/C,mBAAmB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACZ,MAAM,gBAAgB,KAAK,OAAO,KAAK,OAAO;;AAC9C,MAAM,YAAY;AAClB,MAAM,yBAAyB,KAAK,OAAO,KAAK,+BAA+B;;AAG/E,MAAM,uBAAuB;IAClC;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAKM,MAAM,oBAAuD;IAClE,mBAAmB;IACnB,2EAA2E;IAC3E,sBAAsB;IACtB,aAAa;IACb,cAAc;IACd,cAAc;IACd,cAAc;AAChB;AAGO,MAAM,WAAW;IACtB,OAAO;IACP,cAAc;IACd,iBAAiB;IACjB,OAAO;AACT;AAGO,MAAM,YAAY;IACvB,iBAAiB;IACjB,eAAe;IACf,mBAAmB;AACrB;AAGO,MAAM,aAAa;IACxB,kBAAkB;IAClB,sBAAsB;IACtB,kBAAkB;AACpB;AAGO,MAAM,kBAAkB;IAC7B,iBAAiB;IACjB,oBAAoB;IACpB,gBAAgB;AAClB;AAGO,MAAM,sBAAsB;AAG5B,MAAM,kBAAkB;IAC7B,MAAM;IACN,MAAM;IACN,QAAQ;IACR,QAAQ;IACR,QAAQ;IACR,MAAM;IACN,MAAM;IACN,QAAQ;IACR,QAAQ;IACR,QAAQ;IACR,QAAQ;IACR,QAAQ;IACR,MAAM;IACN,MAAM;IACN,MAAM;IACN,MAAM;IACN,MAAM;IACN,MAAM;IACN,QAAQ;IACR,QAAQ;IACR,MAAM;IACN,MAAM;IACN,KAAK;IACL,MAAM;AACR;AAGO,MAAM,yBAAyB;IACpC,QAAQ;QAAC;QAAW;QAAQ;QAAQ;QAA0B;QAAkB;KAAe;IAC/F,KAAK;QAAC;QAAuB;QAAQ;QAA2B;KAAoB;IACpF,UAAU;QAAC;QAAa;QAAc;KAAwB;IAC9D,eAAe;QAAC;QAAkB;QAA2B;KAAiB;IAC9E,aAAa;QAAC;QAAgB;QAAkB;KAAa;IAC7D,SAAS;QAAC;QAAY;QAAgB;KAAW;IACjD,MAAM;QAAC;QAAS;QAAgB;KAAe;AACjD;AAGO,MAAM,cAAc;IACzB,MAAM;QACJ,qBAAqB;QACrB,kBAAkB;QAClB,uBAAuB;IACzB;IACA,OAAO;QACL,qBAAqB;QACrB,kBAAkB;QAClB,uBAAuB;IACzB;IACA,cAAc;QACZ,qBAAqB;QACrB,kBAAkB;QAClB,uBAAuB;IACzB;IACA,YAAY;QACV,qBAAqB;QACrB,kBAAkB;QAClB,uBAAuB;IACzB;AACF;AAGO,MAAM,cAAc"}},
    {"offset": {"line": 321, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/documind/utils/position-mapper.ts"],"sourcesContent":["// ============================================\r\n// DOCUMIND ENGINE - POSITION MAPPER\r\n// Handles coordinate system conversions\r\n// ============================================\r\n\r\nimport type { BoundingBox, NormalizedBox } from \"../types\"\r\n\r\n/**\r\n * PDF coordinate system: Origin at bottom-left, measured in points (72 pts = 1 inch)\r\n * Browser/Canvas coordinate system: Origin at top-left, measured in pixels\r\n * Normalized coordinate system: Origin at top-left, values 0-1 (percentage of page)\r\n */\r\n\r\nexport interface PageDimensions {\r\n  width: number\r\n  height: number\r\n}\r\n\r\n/**\r\n * Convert PDF coordinates to normalized (0-1) coordinates\r\n * PDF origin is bottom-left, normalized origin is top-left\r\n */\r\nexport function pdfToNormalized(box: BoundingBox, page: PageDimensions): NormalizedBox {\r\n  return {\r\n    x: box.x / page.width,\r\n    // Flip Y axis: PDF bottom-left to normalized top-left\r\n    y: 1 - (box.y + box.height) / page.height,\r\n    width: box.width / page.width,\r\n    height: box.height / page.height,\r\n  }\r\n}\r\n\r\n/**\r\n * Convert normalized coordinates back to PDF coordinates\r\n */\r\nexport function normalizedToPdf(box: NormalizedBox, page: PageDimensions): BoundingBox {\r\n  return {\r\n    x: box.x * page.width,\r\n    // Flip Y axis back: normalized top-left to PDF bottom-left\r\n    y: page.height - (box.y + box.height) * page.height,\r\n    width: box.width * page.width,\r\n    height: box.height * page.height,\r\n  }\r\n}\r\n\r\n/**\r\n * Convert PDF coordinates to pixel coordinates for canvas rendering\r\n */\r\nexport function pdfToPixel(box: BoundingBox, page: PageDimensions, scale = 1): BoundingBox {\r\n  return {\r\n    x: box.x * scale,\r\n    // Flip Y axis for canvas (top-left origin)\r\n    y: (page.height - box.y - box.height) * scale,\r\n    width: box.width * scale,\r\n    height: box.height * scale,\r\n  }\r\n}\r\n\r\n/**\r\n * Convert pixel coordinates (from canvas) to PDF coordinates\r\n */\r\nexport function pixelToPdf(box: BoundingBox, page: PageDimensions, scale = 1): BoundingBox {\r\n  return {\r\n    x: box.x / scale,\r\n    // Flip Y axis back to PDF\r\n    y: page.height - box.y / scale - box.height / scale,\r\n    width: box.width / scale,\r\n    height: box.height / scale,\r\n  }\r\n}\r\n\r\n/**\r\n * Convert normalized coordinates to pixel coordinates\r\n */\r\nexport function normalizedToPixel(box: NormalizedBox, page: PageDimensions, scale = 1): BoundingBox {\r\n  return {\r\n    x: box.x * page.width * scale,\r\n    y: box.y * page.height * scale,\r\n    width: box.width * page.width * scale,\r\n    height: box.height * page.height * scale,\r\n  }\r\n}\r\n\r\n/**\r\n * Convert pixel coordinates to normalized coordinates\r\n */\r\nexport function pixelToNormalized(box: BoundingBox, page: PageDimensions, scale = 1): NormalizedBox {\r\n  return {\r\n    x: box.x / scale / page.width,\r\n    y: box.y / scale / page.height,\r\n    width: box.width / scale / page.width,\r\n    height: box.height / scale / page.height,\r\n  }\r\n}\r\n\r\n/**\r\n * Check if two boxes overlap\r\n */\r\nexport function boxesOverlap(a: BoundingBox, b: BoundingBox): boolean {\r\n  return !(a.x + a.width < b.x || b.x + b.width < a.x || a.y + a.height < b.y || b.y + b.height < a.y)\r\n}\r\n\r\n/**\r\n * Check if box A contains box B\r\n */\r\nexport function boxContains(container: BoundingBox, inner: BoundingBox): boolean {\r\n  return (\r\n    inner.x >= container.x &&\r\n    inner.y >= container.y &&\r\n    inner.x + inner.width <= container.x + container.width &&\r\n    inner.y + inner.height <= container.y + container.height\r\n  )\r\n}\r\n\r\n/**\r\n * Calculate distance between two boxes (edge to edge)\r\n */\r\nexport function boxDistance(a: BoundingBox, b: BoundingBox): number {\r\n  const dx = Math.max(0, Math.max(a.x, b.x) - Math.min(a.x + a.width, b.x + b.width))\r\n  const dy = Math.max(0, Math.max(a.y, b.y) - Math.min(a.y + a.height, b.y + b.height))\r\n  return Math.sqrt(dx * dx + dy * dy)\r\n}\r\n\r\n/**\r\n * Get center point of a box\r\n */\r\nexport function boxCenter(box: BoundingBox): { x: number; y: number } {\r\n  return {\r\n    x: box.x + box.width / 2,\r\n    y: box.y + box.height / 2,\r\n  }\r\n}\r\n\r\n/**\r\n * Merge multiple boxes into one bounding box\r\n */\r\nexport function mergeBoxes(boxes: BoundingBox[]): BoundingBox {\r\n  if (boxes.length === 0) {\r\n    return { x: 0, y: 0, width: 0, height: 0 }\r\n  }\r\n\r\n  const minX = Math.min(...boxes.map((b) => b.x))\r\n  const minY = Math.min(...boxes.map((b) => b.y))\r\n  const maxX = Math.max(...boxes.map((b) => b.x + b.width))\r\n  const maxY = Math.max(...boxes.map((b) => b.y + b.height))\r\n\r\n  return {\r\n    x: minX,\r\n    y: minY,\r\n    width: maxX - minX,\r\n    height: maxY - minY,\r\n  }\r\n}\r\n\r\n/**\r\n * Expand a box by a given margin\r\n */\r\nexport function expandBox(box: BoundingBox, margin: number): BoundingBox {\r\n  return {\r\n    x: box.x - margin,\r\n    y: box.y - margin,\r\n    width: box.width + margin * 2,\r\n    height: box.height + margin * 2,\r\n  }\r\n}\r\n\r\n/**\r\n * Check if a point is inside a box\r\n */\r\nexport function pointInBox(point: { x: number; y: number }, box: BoundingBox): boolean {\r\n  return point.x >= box.x && point.x <= box.x + box.width && point.y >= box.y && point.y <= box.y + box.height\r\n}\r\n\r\n/**\r\n * Calculate intersection over union (IoU) for two boxes\r\n * Used for comparing detected fields with template fields\r\n */\r\nexport function calculateIoU(a: BoundingBox, b: BoundingBox): number {\r\n  const intersectX = Math.max(a.x, b.x)\r\n  const intersectY = Math.max(a.y, b.y)\r\n  const intersectW = Math.min(a.x + a.width, b.x + b.width) - intersectX\r\n  const intersectH = Math.min(a.y + a.height, b.y + b.height) - intersectY\r\n\r\n  if (intersectW <= 0 || intersectH <= 0) {\r\n    return 0\r\n  }\r\n\r\n  const intersectionArea = intersectW * intersectH\r\n  const aArea = a.width * a.height\r\n  const bArea = b.width * b.height\r\n  const unionArea = aArea + bArea - intersectionArea\r\n\r\n  return intersectionArea / unionArea\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 473, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/documind/modules/pdf-parser.ts"],"sourcesContent":["// ============================================\r\n// DOCUMIND ENGINE - PDF PARSER MODULE\r\n// Uses unpdf for text extraction (server-compatible)\r\n// Uses pdf-lib for form field extraction\r\n// ============================================\r\n\r\nimport type {\r\n  ParsedPage,\r\n  TextBlock,\r\n  FormField,\r\n  FormFieldType,\r\n  FormFieldOption,\r\n  FontInfo,\r\n  BoundingBox,\r\n  TextBlockType,\r\n  DocumentMetadata,\r\n  DocumentType,\r\n} from \"../types\"\r\nimport { pdfToNormalized } from \"../utils/position-mapper\"\r\nimport { DOCUMENT_TYPE_PATTERNS, OCR_CONFIG } from \"../constants\"\r\n\r\nlet PDFDocumentModule: typeof import(\"pdf-lib\").PDFDocument | null = null\r\n\r\nasync function getPdfLib() {\r\n  if (!PDFDocumentModule) {\r\n    const pdfLib = await import(\"pdf-lib\")\r\n    PDFDocumentModule = pdfLib.PDFDocument\r\n  }\r\n  return PDFDocumentModule\r\n}\r\n\r\nexport interface PDFParseResult {\r\n  metadata: DocumentMetadata\r\n  pages: ParsedPage[]\r\n  formFields: FormField[]\r\n  rawText: string\r\n  isScanned: boolean\r\n}\r\n\r\nexport interface PDFParseOptions {\r\n  extractImages?: boolean\r\n  maxPages?: number\r\n  password?: string\r\n}\r\n\r\n/**\r\n * Main PDF parsing function\r\n * Now uses unpdf for server-compatible text extraction\r\n */\r\nexport async function parsePDF(data: ArrayBuffer | Uint8Array, options: PDFParseOptions = {}): Promise<PDFParseResult> {\r\n  const { maxPages } = options\r\n\r\n  let uint8Data: Uint8Array\r\n  if (data instanceof ArrayBuffer) {\r\n    uint8Data = new Uint8Array(data)\r\n  } else if (data instanceof Uint8Array) {\r\n    uint8Data = data\r\n  } else {\r\n    // Handle Buffer or other array-like objects\r\n    uint8Data = new Uint8Array(data as ArrayBufferLike)\r\n  }\r\n\r\n  const header = String.fromCharCode(...uint8Data.slice(0, 8))\r\n  console.log(\"[v0] PDF header check:\", header.substring(0, 5), \"Length:\", uint8Data.length)\r\n\r\n  if (!header.startsWith(\"%PDF-\")) {\r\n    throw new Error(`Invalid PDF: Expected %PDF- header but got: ${header.substring(0, 10)}`)\r\n  }\r\n\r\n  const PDFDocument = await getPdfLib()\r\n  const pdfDoc = await PDFDocument.load(uint8Data, { ignoreEncryption: true })\r\n  const pageCount = pdfDoc.getPageCount()\r\n\r\n  console.log(\"[v0] PDF loaded with pdf-lib, pages:\", pageCount)\r\n\r\n  // Determine page range\r\n  const pagesToProcess = maxPages ? Math.min(pageCount, maxPages) : pageCount\r\n\r\n  let fullText = \"\"\r\n  let pageTexts: string[] = []\r\n\r\n  try {\r\n    const { getDocumentProxy, extractText } = await import(\"unpdf\")\r\n\r\n    // Create a copy of the data for unpdf\r\n    const pdfData = uint8Data.slice()\r\n    const pdf = await getDocumentProxy(pdfData)\r\n\r\n    const mergedResult = await extractText(pdf, { mergePages: true })\r\n    fullText = typeof mergedResult.text === \"string\" ? mergedResult.text : (mergedResult.text as string[]).join(\"\\n\\n\")\r\n\r\n    const perPageResult = await extractText(pdf, { mergePages: false })\r\n    pageTexts = Array.isArray(perPageResult.text) ? perPageResult.text : [perPageResult.text as string]\r\n\r\n    console.log(\"[v0] Text extracted via unpdf, length:\", fullText.length)\r\n  } catch (unpdfError) {\r\n    console.log(\"[v0] unpdf extraction failed, using basic extraction:\", unpdfError)\r\n    // Fallback: just use empty text - documents will be marked as scanned\r\n    pageTexts = new Array(pagesToProcess).fill(\"\")\r\n    fullText = \"\"\r\n  }\r\n\r\n  // Build pages\r\n  const pages: ParsedPage[] = []\r\n  let totalTextLength = 0\r\n\r\n  for (let i = 0; i < pagesToProcess; i++) {\r\n    const pageText = pageTexts[i] || \"\"\r\n    const page = pdfDoc.getPage(i)\r\n    const { width, height } = page.getSize()\r\n\r\n    const parsedPage = createParsedPage(pageText, i + 1, width, height)\r\n    pages.push(parsedPage)\r\n    totalTextLength += pageText.length\r\n  }\r\n\r\n  // Detect if document is scanned (low text density)\r\n  const avgTextPerPage = totalTextLength / pagesToProcess\r\n  const isScanned = avgTextPerPage < OCR_CONFIG.min_text_density * 1000\r\n\r\n  // Extract form fields using pdf-lib\r\n  const formFields = await extractFormFields(uint8Data)\r\n\r\n  // Extract metadata using pdf-lib\r\n  const metadata = await extractMetadataFromPdfLib(pdfDoc, pageCount, isScanned, fullText)\r\n\r\n  return {\r\n    metadata,\r\n    pages,\r\n    formFields,\r\n    rawText: fullText,\r\n    isScanned,\r\n  }\r\n}\r\n\r\n/**\r\n * Create a parsed page from text content\r\n * Simplified page creation without pdfjs position data\r\n */\r\nfunction createParsedPage(pageText: string, pageNumber: number, width: number, height: number): ParsedPage {\r\n  const textBlocks = createTextBlocks(pageText, pageNumber, width, height)\r\n  const isScanned = pageText.length < OCR_CONFIG.min_text_density * 1000\r\n\r\n  return {\r\n    page_number: pageNumber,\r\n    width,\r\n    height,\r\n    rotation: 0,\r\n    content: {\r\n      full_text: pageText,\r\n      text_blocks: textBlocks,\r\n      lines: [], // Line detection requires visual analysis - will be enhanced later\r\n      rectangles: [], // Rectangle detection requires visual analysis\r\n      images: [],\r\n    },\r\n    is_scanned: isScanned,\r\n    ocr_confidence: null,\r\n  }\r\n}\r\n\r\n/**\r\n * Create text blocks from page text\r\n * Creates logical text blocks from extracted text\r\n */\r\nfunction createTextBlocks(pageText: string, pageNumber: number, pageWidth: number, pageHeight: number): TextBlock[] {\r\n  const blocks: TextBlock[] = []\r\n  const lines = pageText.split(\"\\n\").filter((line) => line.trim())\r\n\r\n  let yPosition = pageHeight - 50 // Start from top\r\n  const lineHeight = 14\r\n\r\n  lines.forEach((line, index) => {\r\n    const trimmedLine = line.trim()\r\n    if (!trimmedLine) return\r\n\r\n    // Estimate position based on line index\r\n    const position: BoundingBox = {\r\n      x: 50,\r\n      y: yPosition,\r\n      width: Math.min(trimmedLine.length * 7, pageWidth - 100),\r\n      height: lineHeight,\r\n    }\r\n\r\n    // Classify the block type\r\n    const blockType = classifyTextBlockFromContent(trimmedLine)\r\n    const font = estimateFontFromBlockType(blockType)\r\n\r\n    blocks.push({\r\n      id: `tb-${pageNumber}-${index}`,\r\n      text: trimmedLine,\r\n      position,\r\n      position_normalized: pdfToNormalized(position, { width: pageWidth, height: pageHeight }),\r\n      font,\r\n      block_type: blockType,\r\n      line_index: index,\r\n      paragraph_index: Math.floor(index / 5),\r\n      confidence: 0.8, // Estimated confidence\r\n      words: null,\r\n    })\r\n\r\n    yPosition -= lineHeight * 1.5\r\n  })\r\n\r\n  return blocks\r\n}\r\n\r\n/**\r\n * Classify text block type from content\r\n */\r\nfunction classifyTextBlockFromContent(text: string): TextBlockType {\r\n  const trimmed = text.trim()\r\n\r\n  // Check for headings (all caps, short, or numbered sections)\r\n  if (trimmed === trimmed.toUpperCase() && trimmed.length < 100 && trimmed.length > 2) {\r\n    return \"heading_1\"\r\n  }\r\n\r\n  // Check for section numbers like \"1.\", \"1.1\", \"Section 1\"\r\n  if (/^(\\d+\\.?\\d*\\.?\\d*|\\w+\\s+\\d+)[.:]\\s/.test(trimmed)) {\r\n    if (trimmed.length < 80) return \"heading_2\"\r\n  }\r\n\r\n  // Check for labels (ends with colon)\r\n  if (trimmed.endsWith(\":\") && trimmed.length < 50) {\r\n    return \"label\"\r\n  }\r\n\r\n  // Check for list items\r\n  if (/^[\\u2022\\u2023\\u25E6\\u2043\\u2219â€¢\\-*]\\s/.test(trimmed)) {\r\n    return \"list_item\"\r\n  }\r\n  if (/^\\d+[.)]\\s/.test(trimmed)) {\r\n    return \"list_item\"\r\n  }\r\n\r\n  // Check for page numbers\r\n  if (/^(Page\\s*)?\\d+(\\s*of\\s*\\d+)?$/i.test(trimmed)) {\r\n    return \"page_number\"\r\n  }\r\n\r\n  return \"paragraph\"\r\n}\r\n\r\n/**\r\n * Estimate font info from block type\r\n */\r\nfunction estimateFontFromBlockType(blockType: TextBlockType): FontInfo {\r\n  const baseFontSize = 12\r\n\r\n  switch (blockType) {\r\n    case \"heading_1\":\r\n      return {\r\n        name: \"Helvetica-Bold\",\r\n        family: \"Helvetica\",\r\n        size: 18,\r\n        weight: \"bold\",\r\n        style: \"normal\",\r\n        color: \"#000000\",\r\n      }\r\n    case \"heading_2\":\r\n      return {\r\n        name: \"Helvetica-Bold\",\r\n        family: \"Helvetica\",\r\n        size: 14,\r\n        weight: \"bold\",\r\n        style: \"normal\",\r\n        color: \"#000000\",\r\n      }\r\n    case \"heading_3\":\r\n      return {\r\n        name: \"Helvetica-Bold\",\r\n        family: \"Helvetica\",\r\n        size: 12,\r\n        weight: \"bold\",\r\n        style: \"normal\",\r\n        color: \"#000000\",\r\n      }\r\n    case \"label\":\r\n      return {\r\n        name: \"Helvetica-Bold\",\r\n        family: \"Helvetica\",\r\n        size: 11,\r\n        weight: \"bold\",\r\n        style: \"normal\",\r\n        color: \"#000000\",\r\n      }\r\n    default:\r\n      return {\r\n        name: \"Helvetica\",\r\n        family: \"Helvetica\",\r\n        size: baseFontSize,\r\n        weight: \"normal\",\r\n        style: \"normal\",\r\n        color: \"#000000\",\r\n      }\r\n  }\r\n}\r\n\r\n/**\r\n * Extract metadata using pdf-lib\r\n * Now accepts pre-loaded pdfDoc instead of raw data\r\n */\r\nasync function extractMetadataFromPdfLib(\r\n  pdfDoc: import(\"pdf-lib\").PDFDocument,\r\n  pageCount: number,\r\n  isScanned: boolean,\r\n  fullText: string,\r\n): Promise<DocumentMetadata> {\r\n  try {\r\n    return {\r\n      title: pdfDoc.getTitle() || null,\r\n      author: pdfDoc.getAuthor() || null,\r\n      subject: pdfDoc.getSubject() || null,\r\n      creator: pdfDoc.getCreator() || null,\r\n      producer: pdfDoc.getProducer() || null,\r\n      creation_date: pdfDoc.getCreationDate()?.toISOString() || null,\r\n      modification_date: pdfDoc.getModificationDate()?.toISOString() || null,\r\n      page_count: pageCount,\r\n      pdf_version: null,\r\n      is_encrypted: false,\r\n      is_scanned: isScanned,\r\n      detected_language: \"en\",\r\n      detected_type: detectDocumentType(fullText),\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error extracting metadata:\", error)\r\n    return {\r\n      title: null,\r\n      author: null,\r\n      subject: null,\r\n      creator: null,\r\n      producer: null,\r\n      creation_date: null,\r\n      modification_date: null,\r\n      page_count: pageCount,\r\n      pdf_version: null,\r\n      is_encrypted: false,\r\n      is_scanned: isScanned,\r\n      detected_language: \"en\",\r\n      detected_type: detectDocumentType(fullText),\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Extract form fields using pdf-lib\r\n */\r\nasync function extractFormFields(data: Uint8Array): Promise<FormField[]> {\r\n  try {\r\n    const PDFDocument = await getPdfLib()\r\n    const pdfDoc = await PDFDocument.load(data, { ignoreEncryption: true })\r\n    const form = pdfDoc.getForm()\r\n    const fields = form.getFields()\r\n    const formFields: FormField[] = []\r\n\r\n    for (const field of fields) {\r\n      const widgets = field.acroField.getWidgets()\r\n      if (widgets.length === 0) continue\r\n\r\n      const widget = widgets[0]\r\n      const rect = widget.getRectangle()\r\n      const page = pdfDoc.getPages().findIndex((p: any) => {\r\n        const pageRef = p.ref\r\n        const widgetPage = widget.P()\r\n        return widgetPage && pageRef.toString() === widgetPage.toString()\r\n      })\r\n\r\n      const pageObj = pdfDoc.getPage(Math.max(0, page))\r\n      const { width: pageWidth, height: pageHeight } = pageObj.getSize()\r\n\r\n      const position: BoundingBox = {\r\n        x: rect.x,\r\n        y: rect.y,\r\n        width: rect.width,\r\n        height: rect.height,\r\n      }\r\n\r\n      const fieldType = getFieldType(field)\r\n      const fieldValue = getFieldValue(field, fieldType)\r\n      const options = getFieldOptions(field, fieldType)\r\n\r\n      formFields.push({\r\n        id: field.getName(),\r\n        name: field.getName(),\r\n        type: fieldType,\r\n        page: Math.max(1, page + 1),\r\n        position,\r\n        position_normalized: pdfToNormalized(position, {\r\n          width: pageWidth,\r\n          height: pageHeight,\r\n        }),\r\n        value: fieldValue,\r\n        default_value: null,\r\n        is_required: field.isRequired(),\r\n        is_readonly: field.isReadOnly(),\r\n        max_length: null,\r\n        options,\r\n        font: null,\r\n        text_alignment: \"left\",\r\n        format: null,\r\n      })\r\n    }\r\n\r\n    return formFields\r\n  } catch (error) {\r\n    console.error(\"Error extracting form fields:\", error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Determine field type from pdf-lib field\r\n */\r\nfunction getFieldType(field: any): FormFieldType {\r\n  const constructor = field.constructor.name\r\n\r\n  switch (constructor) {\r\n    case \"PDFTextField\":\r\n      return \"text\"\r\n    case \"PDFCheckBox\":\r\n      return \"checkbox\"\r\n    case \"PDFRadioGroup\":\r\n      return \"radio\"\r\n    case \"PDFDropdown\":\r\n      return \"select\"\r\n    case \"PDFSignature\":\r\n      return \"signature\"\r\n    case \"PDFButton\":\r\n      return \"button\"\r\n    default:\r\n      return \"text\"\r\n  }\r\n}\r\n\r\n/**\r\n * Get field value based on type\r\n */\r\nfunction getFieldValue(field: any, type: FormFieldType): string | boolean | string[] | null {\r\n  try {\r\n    switch (type) {\r\n      case \"checkbox\":\r\n        return field.isChecked()\r\n      case \"radio\":\r\n        return field.getSelected() || null\r\n      case \"select\":\r\n        return field.getSelected() || []\r\n      case \"text\":\r\n        return field.getText() || null\r\n      default:\r\n        return null\r\n    }\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\n/**\r\n * Get field options for select/radio\r\n */\r\nfunction getFieldOptions(field: any, type: FormFieldType): FormFieldOption[] {\r\n  if (type !== \"select\" && type !== \"radio\") return []\r\n\r\n  try {\r\n    const options = field.getOptions?.() || []\r\n    return options.map((opt: string, idx: number) => ({\r\n      value: opt,\r\n      label: opt,\r\n      is_default: idx === 0,\r\n    }))\r\n  } catch {\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Detect document type from content\r\n */\r\nfunction detectDocumentType(text: string): DocumentType {\r\n  const lowerText = text.toLowerCase()\r\n\r\n  for (const [type, patterns] of Object.entries(DOCUMENT_TYPE_PATTERNS)) {\r\n    for (const pattern of patterns) {\r\n      if (pattern.test(lowerText)) {\r\n        return type as DocumentType\r\n      }\r\n    }\r\n  }\r\n\r\n  return \"unknown\"\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 883, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/documind/modules/layout-analyzer.ts"],"sourcesContent":["// ============================================\r\n// DOCUMIND ENGINE - LAYOUT ANALYZER MODULE\r\n// Analyzes document structure and detects regions\r\n// ============================================\r\n\r\nimport type {\r\n  ParsedPage,\r\n  TextBlock,\r\n  LineElement,\r\n  RectElement,\r\n  DocumentLayout,\r\n  DocumentSection,\r\n  TableRegion,\r\n  FormRegion,\r\n  DetectedField,\r\n  DocumentType,\r\n  InputType,\r\n  DetectionMethod,\r\n  FieldDataType,\r\n  BoundingBox,\r\n} from \"../types\"\r\nimport { boxDistance, boxesOverlap, mergeBoxes, pdfToNormalized } from \"../utils/position-mapper\"\r\nimport { FIELD_DETECTION } from \"../constants\"\r\n\r\nexport interface LayoutAnalysisResult {\r\n  layout: DocumentLayout\r\n  detectedFields: DetectedField[]\r\n  tableRegions: TableRegion[]\r\n}\r\n\r\n/**\r\n * Main layout analysis function\r\n */\r\nexport function analyzeLayout(pages: ParsedPage[], documentType: DocumentType): LayoutAnalysisResult {\r\n  // Extract sections from headings\r\n  const sections = extractSections(pages)\r\n\r\n  // Find title\r\n  const title = findDocumentTitle(pages)\r\n\r\n  // Detect table regions\r\n  const tableRegions = detectTableRegions(pages)\r\n\r\n  // Detect form regions and fields\r\n  const { formRegions, detectedFields } = detectFormRegions(pages)\r\n\r\n  // Build reading order\r\n  const readingOrder = buildReadingOrder(pages)\r\n\r\n  return {\r\n    layout: {\r\n      document_type: documentType,\r\n      title,\r\n      sections,\r\n      table_regions: tableRegions,\r\n      form_regions: formRegions,\r\n      reading_order: readingOrder,\r\n    },\r\n    detectedFields,\r\n    tableRegions,\r\n  }\r\n}\r\n\r\n/**\r\n * Extract document sections from headings\r\n */\r\nfunction extractSections(pages: ParsedPage[]): DocumentSection[] {\r\n  const sections: DocumentSection[] = []\r\n  let currentSection: DocumentSection | null = null\r\n  let sectionId = 0\r\n\r\n  pages.forEach((page) => {\r\n    page.content.text_blocks.forEach((block) => {\r\n      if (block.block_type.startsWith(\"heading\")) {\r\n        const level = Number.parseInt(block.block_type.split(\"_\")[1]) || 1\r\n\r\n        const newSection: DocumentSection = {\r\n          id: `section-${sectionId++}`,\r\n          title: block.text,\r\n          level,\r\n          page_start: page.page_number,\r\n          page_end: page.page_number,\r\n          block_ids: [block.id],\r\n          subsections: [],\r\n        }\r\n\r\n        if (level === 1) {\r\n          // Top-level section\r\n          if (currentSection) {\r\n            sections.push(currentSection)\r\n          }\r\n          currentSection = newSection\r\n        } else if (currentSection) {\r\n          // Subsection\r\n          if (level === 2) {\r\n            currentSection.subsections.push(newSection)\r\n          } else if (level === 3 && currentSection.subsections.length > 0) {\r\n            const lastSubsection = currentSection.subsections[currentSection.subsections.length - 1]\r\n            lastSubsection.subsections.push(newSection)\r\n          }\r\n        } else {\r\n          currentSection = newSection\r\n        }\r\n      } else if (currentSection) {\r\n        // Add content blocks to current section\r\n        currentSection.block_ids.push(block.id)\r\n        currentSection.page_end = page.page_number\r\n      }\r\n    })\r\n  })\r\n\r\n  if (currentSection) {\r\n    sections.push(currentSection)\r\n  }\r\n\r\n  return sections\r\n}\r\n\r\n/**\r\n * Find document title (first prominent heading or first large text)\r\n */\r\nfunction findDocumentTitle(pages: ParsedPage[]): TextBlock | null {\r\n  if (pages.length === 0) return null\r\n\r\n  const firstPage = pages[0]\r\n\r\n  // Look for heading_1\r\n  const h1 = firstPage.content.text_blocks.find((b) => b.block_type === \"heading_1\")\r\n  if (h1) return h1\r\n\r\n  // Look for largest text in top half of page\r\n  const topHalfBlocks = firstPage.content.text_blocks.filter((b) => b.position_normalized.y < 0.5)\r\n\r\n  if (topHalfBlocks.length === 0) return null\r\n\r\n  return topHalfBlocks.reduce((largest, block) => (block.font.size > largest.font.size ? block : largest))\r\n}\r\n\r\n/**\r\n * Detect table regions\r\n */\r\nfunction detectTableRegions(pages: ParsedPage[]): TableRegion[] {\r\n  const tableRegions: TableRegion[] = []\r\n  let tableId = 0\r\n\r\n  pages.forEach((page) => {\r\n    const pageDimensions = { width: page.width, height: page.height }\r\n\r\n    // Method 1: Find grid patterns from lines\r\n    const gridRegions = findGridPatterns(page.content.lines, pageDimensions)\r\n\r\n    // Method 2: Find aligned text patterns (columns of data)\r\n    const textTableRegions = findTextTablePatterns(page.content.text_blocks, pageDimensions)\r\n\r\n    // Merge detected regions\r\n    const mergedRegions = mergeOverlappingRegions([...gridRegions, ...textTableRegions])\r\n\r\n    mergedRegions.forEach((region) => {\r\n      tableRegions.push({\r\n        id: `table-${tableId++}`,\r\n        page: page.page_number,\r\n        position: region.position,\r\n        position_normalized: pdfToNormalized(region.position, pageDimensions),\r\n        row_count_estimate: region.rows,\r\n        column_count_estimate: region.cols,\r\n        has_header: region.hasHeader,\r\n        extraction_status: \"pending\",\r\n        table_data: null,\r\n      })\r\n    })\r\n  })\r\n\r\n  return tableRegions\r\n}\r\n\r\n/**\r\n * Find grid patterns from horizontal and vertical lines\r\n */\r\nfunction findGridPatterns(\r\n  lines: LineElement[],\r\n  pageDimensions: { width: number; height: number },\r\n): Array<{\r\n  position: BoundingBox\r\n  rows: number\r\n  cols: number\r\n  hasHeader: boolean\r\n}> {\r\n  const horizontalLines = lines.filter((l) => l.type === \"horizontal\")\r\n  const verticalLines = lines.filter((l) => l.type === \"vertical\")\r\n\r\n  if (horizontalLines.length < 2 || verticalLines.length < 2) {\r\n    return []\r\n  }\r\n\r\n  // Group lines by proximity\r\n  const hGroups = groupLinesByPosition(horizontalLines, \"y\")\r\n  const vGroups = groupLinesByPosition(verticalLines, \"x\")\r\n\r\n  const grids: Array<{\r\n    position: BoundingBox\r\n    rows: number\r\n    cols: number\r\n    hasHeader: boolean\r\n  }> = []\r\n\r\n  // Find intersecting line groups that form grids\r\n  if (hGroups.length >= 2 && vGroups.length >= 2) {\r\n    const minX = Math.min(...verticalLines.map((l) => l.start.x))\r\n    const maxX = Math.max(...verticalLines.map((l) => l.start.x))\r\n    const minY = Math.min(...horizontalLines.map((l) => l.start.y))\r\n    const maxY = Math.max(...horizontalLines.map((l) => l.start.y))\r\n\r\n    grids.push({\r\n      position: {\r\n        x: minX,\r\n        y: minY,\r\n        width: maxX - minX,\r\n        height: maxY - minY,\r\n      },\r\n      rows: hGroups.length - 1,\r\n      cols: vGroups.length - 1,\r\n      hasHeader: true, // Assume first row is header\r\n    })\r\n  }\r\n\r\n  return grids\r\n}\r\n\r\n/**\r\n * Group lines by their position\r\n */\r\nfunction groupLinesByPosition(lines: LineElement[], axis: \"x\" | \"y\"): number[][] {\r\n  const tolerance = 5\r\n  const positions = lines.map((l) => l.start[axis])\r\n  const groups: number[][] = []\r\n\r\n  positions.sort((a, b) => a - b)\r\n\r\n  let currentGroup: number[] = []\r\n  let lastPos = Number.NEGATIVE_INFINITY\r\n\r\n  positions.forEach((pos) => {\r\n    if (pos - lastPos > tolerance) {\r\n      if (currentGroup.length > 0) {\r\n        groups.push(currentGroup)\r\n      }\r\n      currentGroup = [pos]\r\n    } else {\r\n      currentGroup.push(pos)\r\n    }\r\n    lastPos = pos\r\n  })\r\n\r\n  if (currentGroup.length > 0) {\r\n    groups.push(currentGroup)\r\n  }\r\n\r\n  return groups\r\n}\r\n\r\n/**\r\n * Find table patterns from aligned text blocks\r\n */\r\nfunction findTextTablePatterns(\r\n  blocks: TextBlock[],\r\n  pageDimensions: { width: number; height: number },\r\n): Array<{\r\n  position: BoundingBox\r\n  rows: number\r\n  cols: number\r\n  hasHeader: boolean\r\n}> {\r\n  // Group blocks by similar Y positions (rows)\r\n  const rowGroups = groupBlocksByRow(blocks)\r\n\r\n  // Find sequences of rows with similar column structure\r\n  const tables: Array<{\r\n    position: BoundingBox\r\n    rows: number\r\n    cols: number\r\n    hasHeader: boolean\r\n  }> = []\r\n\r\n  let tableStart = -1\r\n  let lastColCount = 0\r\n  let tableBlocks: TextBlock[] = []\r\n\r\n  rowGroups.forEach((row, idx) => {\r\n    const colCount = estimateColumnCount(row)\r\n\r\n    if (colCount >= 2) {\r\n      if (tableStart === -1) {\r\n        tableStart = idx\r\n        lastColCount = colCount\r\n        tableBlocks = [...row]\r\n      } else if (Math.abs(colCount - lastColCount) <= 1) {\r\n        tableBlocks.push(...row)\r\n      } else {\r\n        // End current table, start new\r\n        if (tableBlocks.length >= 4) {\r\n          tables.push(createTableFromBlocks(tableBlocks, lastColCount))\r\n        }\r\n        tableStart = idx\r\n        lastColCount = colCount\r\n        tableBlocks = [...row]\r\n      }\r\n    } else {\r\n      if (tableBlocks.length >= 4) {\r\n        tables.push(createTableFromBlocks(tableBlocks, lastColCount))\r\n      }\r\n      tableStart = -1\r\n      tableBlocks = []\r\n    }\r\n  })\r\n\r\n  if (tableBlocks.length >= 4) {\r\n    tables.push(createTableFromBlocks(tableBlocks, lastColCount))\r\n  }\r\n\r\n  return tables\r\n}\r\n\r\n/**\r\n * Group text blocks by row (similar Y position)\r\n */\r\nfunction groupBlocksByRow(blocks: TextBlock[]): TextBlock[][] {\r\n  const tolerance = 10\r\n  const sorted = [...blocks].sort((a, b) => b.position.y - a.position.y) // Top to bottom in PDF coords\r\n\r\n  const rows: TextBlock[][] = []\r\n  let currentRow: TextBlock[] = []\r\n  let lastY = Number.POSITIVE_INFINITY\r\n\r\n  sorted.forEach((block) => {\r\n    if (Math.abs(block.position.y - lastY) > tolerance) {\r\n      if (currentRow.length > 0) {\r\n        rows.push(currentRow.sort((a, b) => a.position.x - b.position.x))\r\n      }\r\n      currentRow = [block]\r\n    } else {\r\n      currentRow.push(block)\r\n    }\r\n    lastY = block.position.y\r\n  })\r\n\r\n  if (currentRow.length > 0) {\r\n    rows.push(currentRow.sort((a, b) => a.position.x - b.position.x))\r\n  }\r\n\r\n  return rows\r\n}\r\n\r\n/**\r\n * Estimate column count from a row of blocks\r\n */\r\nfunction estimateColumnCount(row: TextBlock[]): number {\r\n  if (row.length <= 1) return row.length\r\n\r\n  // Count significant gaps between blocks\r\n  const gaps: number[] = []\r\n  for (let i = 1; i < row.length; i++) {\r\n    const gap = row[i].position.x - (row[i - 1].position.x + row[i - 1].position.width)\r\n    gaps.push(gap)\r\n  }\r\n\r\n  // Average gap\r\n  const avgGap = gaps.reduce((a, b) => a + b, 0) / gaps.length\r\n\r\n  // Count gaps larger than average (column separators)\r\n  const significantGaps = gaps.filter((g) => g > avgGap * 1.5).length\r\n\r\n  return significantGaps + 1\r\n}\r\n\r\n/**\r\n * Create table region from blocks\r\n */\r\nfunction createTableFromBlocks(\r\n  blocks: TextBlock[],\r\n  cols: number,\r\n): {\r\n  position: BoundingBox\r\n  rows: number\r\n  cols: number\r\n  hasHeader: boolean\r\n} {\r\n  const position = mergeBoxes(blocks.map((b) => b.position))\r\n  const rowGroups = groupBlocksByRow(blocks)\r\n\r\n  return {\r\n    position,\r\n    rows: rowGroups.length,\r\n    cols,\r\n    hasHeader: true,\r\n  }\r\n}\r\n\r\n/**\r\n * Merge overlapping regions\r\n */\r\nfunction mergeOverlappingRegions(\r\n  regions: Array<{\r\n    position: BoundingBox\r\n    rows: number\r\n    cols: number\r\n    hasHeader: boolean\r\n  }>,\r\n): Array<{\r\n  position: BoundingBox\r\n  rows: number\r\n  cols: number\r\n  hasHeader: boolean\r\n}> {\r\n  if (regions.length <= 1) return regions\r\n\r\n  const merged: typeof regions = []\r\n\r\n  regions.forEach((region) => {\r\n    const overlapping = merged.findIndex((m) => boxesOverlap(m.position, region.position))\r\n\r\n    if (overlapping >= 0) {\r\n      // Merge with existing\r\n      merged[overlapping] = {\r\n        position: mergeBoxes([merged[overlapping].position, region.position]),\r\n        rows: Math.max(merged[overlapping].rows, region.rows),\r\n        cols: Math.max(merged[overlapping].cols, region.cols),\r\n        hasHeader: merged[overlapping].hasHeader || region.hasHeader,\r\n      }\r\n    } else {\r\n      merged.push(region)\r\n    }\r\n  })\r\n\r\n  return merged\r\n}\r\n\r\n/**\r\n * Detect form regions and fields\r\n */\r\nfunction detectFormRegions(pages: ParsedPage[]): {\r\n  formRegions: FormRegion[]\r\n  detectedFields: DetectedField[]\r\n} {\r\n  const formRegions: FormRegion[] = []\r\n  const detectedFields: DetectedField[] = []\r\n  let regionId = 0\r\n  let fieldId = 0\r\n\r\n  pages.forEach((page) => {\r\n    const pageDimensions = { width: page.width, height: page.height }\r\n\r\n    // Find labels (text ending with colon)\r\n    const labels = page.content.text_blocks.filter((b) => b.block_type === \"label\" || b.text.trim().endsWith(\":\"))\r\n\r\n    // Find form lines (horizontal lines that could be underlines)\r\n    const formLines = page.content.lines.filter((l) => l.is_form_line)\r\n\r\n    // Find text boxes (rectangles)\r\n    const textBoxes = page.content.rectangles.filter((r) => r.rect_type === \"text_box\")\r\n\r\n    // Find checkboxes\r\n    const checkboxes = page.content.rectangles.filter((r) => r.rect_type === \"checkbox\")\r\n\r\n    // Match labels to input areas\r\n    const pageFields: DetectedField[] = []\r\n\r\n    labels.forEach((label) => {\r\n      // Look for line to the right or below\r\n      const nearbyLine = findNearbyInputLine(label, formLines)\r\n      const nearbyBox = findNearbyInputBox(label, textBoxes)\r\n      const nearbyCheckbox = findNearbyCheckbox(label, checkboxes)\r\n\r\n      if (nearbyLine) {\r\n        pageFields.push(\r\n          createDetectedField(\r\n            `field-${fieldId++}`,\r\n            label,\r\n            {\r\n              type: \"text_line\",\r\n              position: lineToBox(nearbyLine),\r\n            },\r\n            pageDimensions,\r\n            \"line_detection\",\r\n          ),\r\n        )\r\n      } else if (nearbyBox) {\r\n        pageFields.push(\r\n          createDetectedField(\r\n            `field-${fieldId++}`,\r\n            label,\r\n            {\r\n              type: \"text_box\",\r\n              position: nearbyBox.position,\r\n            },\r\n            pageDimensions,\r\n            \"box_detection\",\r\n          ),\r\n        )\r\n      } else if (nearbyCheckbox) {\r\n        pageFields.push(\r\n          createDetectedField(\r\n            `field-${fieldId++}`,\r\n            label,\r\n            {\r\n              type: \"checkbox\",\r\n              position: nearbyCheckbox.position,\r\n            },\r\n            pageDimensions,\r\n            \"box_detection\",\r\n          ),\r\n        )\r\n      } else {\r\n        // Look for pattern-based detection (Label: _____)\r\n        const patternInput = detectPatternInput(label, page.content.text_blocks)\r\n        if (patternInput) {\r\n          pageFields.push(\r\n            createDetectedField(`field-${fieldId++}`, label, patternInput, pageDimensions, \"pattern_matching\"),\r\n          )\r\n        }\r\n      }\r\n    })\r\n\r\n    if (pageFields.length > 0) {\r\n      // Create form region encompassing all fields\r\n      const allPositions = pageFields.flatMap((f) => [f.label.position, f.input.position])\r\n      const regionPosition = mergeBoxes(allPositions)\r\n\r\n      formRegions.push({\r\n        id: `form-region-${regionId++}`,\r\n        page: page.page_number,\r\n        position: regionPosition,\r\n        position_normalized: pdfToNormalized(regionPosition, pageDimensions),\r\n        detected_fields: pageFields,\r\n      })\r\n\r\n      detectedFields.push(...pageFields)\r\n    }\r\n  })\r\n\r\n  return { formRegions, detectedFields }\r\n}\r\n\r\n/**\r\n * Find nearby input line for a label\r\n */\r\nfunction findNearbyInputLine(label: TextBlock, lines: LineElement[]): LineElement | null {\r\n  const maxDistance = FIELD_DETECTION.max_label_distance\r\n\r\n  // Look for line to the right (same line) or below\r\n  const candidates = lines.filter((line) => {\r\n    // Line should be to the right or below the label\r\n    const labelRight = label.position.x + label.position.width\r\n    const labelBottom = label.position.y\r\n\r\n    // Right of label\r\n    if (\r\n      line.start.x >= labelRight - 10 &&\r\n      line.start.x <= labelRight + maxDistance &&\r\n      Math.abs(line.start.y - label.position.y) < label.position.height\r\n    ) {\r\n      return true\r\n    }\r\n\r\n    // Below label\r\n    if (\r\n      line.start.y <= labelBottom &&\r\n      line.start.y >= labelBottom - maxDistance &&\r\n      Math.abs(line.start.x - label.position.x) < maxDistance\r\n    ) {\r\n      return true\r\n    }\r\n\r\n    return false\r\n  })\r\n\r\n  if (candidates.length === 0) return null\r\n\r\n  // Return closest\r\n  return candidates.reduce((closest, line) => {\r\n    const closestDist = boxDistance(label.position, lineToBox(closest))\r\n    const lineDist = boxDistance(label.position, lineToBox(line))\r\n    return lineDist < closestDist ? line : closest\r\n  })\r\n}\r\n\r\n/**\r\n * Find nearby input box for a label\r\n */\r\nfunction findNearbyInputBox(label: TextBlock, boxes: RectElement[]): RectElement | null {\r\n  const maxDistance = FIELD_DETECTION.max_label_distance\r\n\r\n  const candidates = boxes.filter((box) => {\r\n    const dist = boxDistance(label.position, box.position)\r\n    return dist < maxDistance\r\n  })\r\n\r\n  if (candidates.length === 0) return null\r\n\r\n  return candidates.reduce((closest, box) => {\r\n    const closestDist = boxDistance(label.position, closest.position)\r\n    const boxDist = boxDistance(label.position, box.position)\r\n    return boxDist < closestDist ? box : closest\r\n  })\r\n}\r\n\r\n/**\r\n * Find nearby checkbox for a label\r\n */\r\nfunction findNearbyCheckbox(label: TextBlock, checkboxes: RectElement[]): RectElement | null {\r\n  const maxDistance = FIELD_DETECTION.max_label_distance * 2 // Checkboxes can be further\r\n\r\n  const candidates = checkboxes.filter((cb) => {\r\n    const dist = boxDistance(label.position, cb.position)\r\n    return dist < maxDistance\r\n  })\r\n\r\n  if (candidates.length === 0) return null\r\n\r\n  return candidates.reduce((closest, cb) => {\r\n    const closestDist = boxDistance(label.position, closest.position)\r\n    const cbDist = boxDistance(label.position, cb.position)\r\n    return cbDist < closestDist ? cb : closest\r\n  })\r\n}\r\n\r\n/**\r\n * Detect input from text patterns (Label: _____)\r\n */\r\nfunction detectPatternInput(label: TextBlock, blocks: TextBlock[]): { type: InputType; position: BoundingBox } | null {\r\n  // Look for underscores or blank space after label\r\n  const labelText = label.text.trim()\r\n\r\n  // Check if there's a block with underscores nearby\r\n  const underscoreBlock = blocks.find((b) => {\r\n    if (b.id === label.id) return false\r\n    if (b.position.y !== label.position.y) return false\r\n\r\n    const afterLabel = b.position.x > label.position.x + label.position.width\r\n    const hasUnderscores = /_{3,}/.test(b.text)\r\n\r\n    return afterLabel && hasUnderscores\r\n  })\r\n\r\n  if (underscoreBlock) {\r\n    return {\r\n      type: \"text_line\",\r\n      position: underscoreBlock.position,\r\n    }\r\n  }\r\n\r\n  return null\r\n}\r\n\r\n/**\r\n * Create a detected field\r\n */\r\nfunction createDetectedField(\r\n  id: string,\r\n  label: TextBlock,\r\n  input: { type: InputType; position: BoundingBox },\r\n  pageDimensions: { width: number; height: number },\r\n  method: DetectionMethod,\r\n): DetectedField {\r\n  return {\r\n    id,\r\n    label: {\r\n      text: label.text.replace(/:$/, \"\").trim(),\r\n      block_id: label.id,\r\n      position: label.position,\r\n      position_normalized: pdfToNormalized(label.position, pageDimensions),\r\n    },\r\n    input: {\r\n      type: input.type,\r\n      position: input.position,\r\n      position_normalized: pdfToNormalized(input.position, pageDimensions),\r\n      native_field_id: null,\r\n    },\r\n    detection_method: method,\r\n    confidence: calculateConfidence(method, label, input),\r\n    suggested_type: suggestFieldType(label.text),\r\n  }\r\n}\r\n\r\n/**\r\n * Convert line element to bounding box\r\n */\r\nfunction lineToBox(line: LineElement): BoundingBox {\r\n  return {\r\n    x: Math.min(line.start.x, line.end.x),\r\n    y: Math.min(line.start.y, line.end.y),\r\n    width: Math.abs(line.end.x - line.start.x) || 2,\r\n    height: Math.abs(line.end.y - line.start.y) || line.thickness,\r\n  }\r\n}\r\n\r\n/**\r\n * Calculate detection confidence\r\n */\r\nfunction calculateConfidence(\r\n  method: DetectionMethod,\r\n  label: TextBlock,\r\n  input: { type: InputType; position: BoundingBox },\r\n): number {\r\n  let base = 0.5\r\n\r\n  // Method-based adjustment\r\n  switch (method) {\r\n    case \"pdf_native\":\r\n      base = 0.95\r\n      break\r\n    case \"line_detection\":\r\n      base = 0.8\r\n      break\r\n    case \"box_detection\":\r\n      base = 0.85\r\n      break\r\n    case \"pattern_matching\":\r\n      base = 0.7\r\n      break\r\n    case \"ai_vision\":\r\n      base = 0.75\r\n      break\r\n    case \"template_match\":\r\n      base = 0.9\r\n      break\r\n  }\r\n\r\n  // Distance penalty\r\n  const distance = boxDistance(label.position, input.position)\r\n  if (distance > 30) base -= 0.1\r\n  if (distance > 50) base -= 0.1\r\n\r\n  return Math.max(0.3, Math.min(1.0, base))\r\n}\r\n\r\n/**\r\n * Suggest field data type from label\r\n */\r\nfunction suggestFieldType(labelText: string): FieldDataType {\r\n  const lower = labelText.toLowerCase()\r\n\r\n  if (/email/i.test(lower)) return \"email\"\r\n  if (/phone|tel|mobile|cell/i.test(lower)) return \"phone\"\r\n  if (/date|dob|birth/i.test(lower)) return \"date\"\r\n  if (/amount|price|cost|value|total|r\\s?\\d/i.test(lower)) return \"currency\"\r\n  if (/number|no\\.?|#/i.test(lower)) return \"number\"\r\n  if (/signature/i.test(lower)) return \"signature\"\r\n  if (/address/i.test(lower)) return \"address\"\r\n  if (/name/i.test(lower)) return \"name\"\r\n  if (/company|business|organization/i.test(lower)) return \"company\"\r\n  if (/id|identity|registration|vat/i.test(lower)) return \"id_number\"\r\n\r\n  return \"text\"\r\n}\r\n\r\n/**\r\n * Build reading order from text blocks\r\n */\r\nfunction buildReadingOrder(pages: ParsedPage[]): string[] {\r\n  const order: string[] = []\r\n\r\n  pages.forEach((page) => {\r\n    // Sort blocks by position (top to bottom, left to right)\r\n    const sorted = [...page.content.text_blocks].sort((a, b) => {\r\n      // First by Y (top to bottom in normalized coords)\r\n      const yDiff = a.position_normalized.y - b.position_normalized.y\r\n      if (Math.abs(yDiff) > 0.02) return yDiff\r\n\r\n      // Then by X (left to right)\r\n      return a.position_normalized.x - b.position_normalized.x\r\n    })\r\n\r\n    sorted.forEach((block) => order.push(block.id))\r\n  })\r\n\r\n  return order\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1455, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/documind/modules/ocr-engine.ts"],"sourcesContent":["// ============================================\r\n// DOCUMIND ENGINE - OCR MODULE\r\n// Handles OCR for scanned documents\r\n// ============================================\r\n\r\nimport type { ParsedPage, TextBlock, WordInfo, BoundingBox, FontInfo } from \"../types\"\r\nimport { pdfToNormalized } from \"../utils/position-mapper\"\r\nimport { OCR_CONFIG } from \"../constants\"\r\n\r\nlet TesseractModule: typeof import(\"tesseract.js\") | null = null\r\n\r\nasync function getTesseract() {\r\n  if (!TesseractModule) {\r\n    TesseractModule = await import(\"tesseract.js\")\r\n  }\r\n  return (TesseractModule as any)\r\n}\r\n\r\nexport interface OCRResult {\r\n  pages: OCRPage[]\r\n  confidence: number\r\n  engine: \"tesseract\" | \"google_vision\"\r\n  processingTimeMs: number\r\n}\r\n\r\nexport interface OCRPage {\r\n  pageNumber: number\r\n  text: string\r\n  blocks: OCRBlock[]\r\n  confidence: number\r\n}\r\n\r\nexport interface OCRBlock {\r\n  text: string\r\n  confidence: number\r\n  bounds: BoundingBox\r\n  words: WordInfo[]\r\n}\r\n\r\n/**\r\n * Perform OCR on a page image\r\n */\r\nexport async function performOCR(\r\n  imageData: Buffer | string, // Can be buffer or base64\r\n  pageNumber: number,\r\n  pageDimensions: { width: number; height: number },\r\n  language: string = OCR_CONFIG.default_language,\r\n): Promise<OCRPage> {\r\n  const startTime = Date.now()\r\n\r\n  try {\r\n    const Tesseract = await getTesseract()\r\n\r\n    // Use Tesseract.js for OCR\r\n    const result = await Tesseract.recognize(imageData, language, {\r\n      logger: () => {}, // Suppress logs\r\n    })\r\n\r\n    const blocks: OCRBlock[] = []\r\n\r\n    // Process paragraphs/blocks\r\n    result.data.paragraphs?.forEach((para: any) => {\r\n      const words: WordInfo[] = []\r\n\r\n      para.words?.forEach((word: any) => {\r\n        words.push({\r\n          text: word.text,\r\n          position: {\r\n            x: word.bbox.x0,\r\n            y: pageDimensions.height - word.bbox.y1, // Convert to PDF coords\r\n            width: word.bbox.x1 - word.bbox.x0,\r\n            height: word.bbox.y1 - word.bbox.y0,\r\n          },\r\n          confidence: word.confidence / 100,\r\n        })\r\n      })\r\n\r\n      blocks.push({\r\n        text: para.text,\r\n        confidence: para.confidence / 100,\r\n        bounds: {\r\n          x: para.bbox.x0,\r\n          y: pageDimensions.height - para.bbox.y1,\r\n          width: para.bbox.x1 - para.bbox.x0,\r\n          height: para.bbox.y1 - para.bbox.y0,\r\n        },\r\n        words,\r\n      })\r\n    })\r\n\r\n    return {\r\n      pageNumber,\r\n      text: result.data.text,\r\n      blocks,\r\n      confidence: result.data.confidence / 100,\r\n    }\r\n  } catch (error) {\r\n    console.error(\"OCR failed:\", error)\r\n    return {\r\n      pageNumber,\r\n      text: \"\",\r\n      blocks: [],\r\n      confidence: 0,\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Convert OCR result to TextBlocks\r\n */\r\nexport function ocrToTextBlocks(ocrPage: OCRPage, pageDimensions: { width: number; height: number }): TextBlock[] {\r\n  const textBlocks: TextBlock[] = []\r\n  let lineIndex = 0\r\n  let paragraphIndex = 0\r\n\r\n  ocrPage.blocks.forEach((block, blockIdx) => {\r\n    // Split block into lines\r\n    const lines = block.text.split(\"\\n\").filter((l) => l.trim())\r\n\r\n    lines.forEach((lineText, lineIdx) => {\r\n      // Find words for this line\r\n      const lineWords = block.words.filter((w) => lineText.includes(w.text))\r\n\r\n      const position =\r\n        lineWords.length > 0\r\n          ? {\r\n              x: Math.min(...lineWords.map((w) => w.position.x)),\r\n              y: Math.min(...lineWords.map((w) => w.position.y)),\r\n              width:\r\n                Math.max(...lineWords.map((w) => w.position.x + w.position.width)) -\r\n                Math.min(...lineWords.map((w) => w.position.x)),\r\n              height: Math.max(...lineWords.map((w) => w.position.height)),\r\n            }\r\n          : block.bounds\r\n\r\n      textBlocks.push({\r\n        id: `ocr-${ocrPage.pageNumber}-${blockIdx}-${lineIdx}`,\r\n        text: lineText,\r\n        position,\r\n        position_normalized: pdfToNormalized(position, pageDimensions),\r\n        font: defaultOCRFont(),\r\n        block_type: classifyOCRBlock(lineText, position, pageDimensions),\r\n        line_index: lineIndex++,\r\n        paragraph_index: paragraphIndex,\r\n        confidence: block.confidence,\r\n        words: lineWords.length > 0 ? lineWords : null,\r\n      })\r\n    })\r\n\r\n    paragraphIndex++\r\n  })\r\n\r\n  return textBlocks\r\n}\r\n\r\n/**\r\n * Default font for OCR text (we can't detect actual font)\r\n */\r\nfunction defaultOCRFont(): FontInfo {\r\n  return {\r\n    name: \"unknown\",\r\n    family: null,\r\n    size: 12,\r\n    weight: \"normal\",\r\n    style: \"normal\",\r\n    color: \"#000000\",\r\n  }\r\n}\r\n\r\n/**\r\n * Classify OCR text block type\r\n */\r\nfunction classifyOCRBlock(\r\n  text: string,\r\n  position: BoundingBox,\r\n  pageDimensions: { width: number; height: number },\r\n): TextBlock[\"block_type\"] {\r\n  const normalizedY = position.y / pageDimensions.height\r\n\r\n  // Headers/footers by position\r\n  if (normalizedY > 0.9) return \"header\"\r\n  if (normalizedY < 0.1) return \"footer\"\r\n\r\n  // Page numbers\r\n  if (text.match(/^\\d+$/) && (normalizedY < 0.1 || normalizedY > 0.9)) {\r\n    return \"page_number\"\r\n  }\r\n\r\n  // Labels\r\n  if (text.trim().endsWith(\":\")) return \"label\"\r\n\r\n  // List items\r\n  if (text.match(/^[\\u2022\\u2023\\u25E6\\u2043\\u2219â€¢-]\\s/)) return \"list_item\"\r\n  if (text.match(/^\\d+[.)]\\s/)) return \"list_item\"\r\n\r\n  // All caps might be heading\r\n  if (text === text.toUpperCase() && text.length > 3 && text.length < 100) {\r\n    return \"heading_2\"\r\n  }\r\n\r\n  return \"paragraph\"\r\n}\r\n\r\n/**\r\n * Merge OCR results with existing parsed page\r\n */\r\nexport function mergeOCRWithPage(page: ParsedPage, ocrPage: OCRPage): ParsedPage {\r\n  const ocrBlocks = ocrToTextBlocks(ocrPage, {\r\n    width: page.width,\r\n    height: page.height,\r\n  })\r\n\r\n  return {\r\n    ...page,\r\n    content: {\r\n      ...page.content,\r\n      full_text: ocrPage.text,\r\n      text_blocks: ocrBlocks,\r\n    },\r\n    is_scanned: true,\r\n    ocr_confidence: ocrPage.confidence,\r\n  }\r\n}\r\n\r\n/**\r\n * Render PDF page to image for OCR\r\n * This function creates an image from a PDF page for OCR processing\r\n */\r\nexport async function renderPageToImage(\r\n  pdfPage: any, // pdfjsLib.PDFPageProxy\r\n  scale = 2.0,\r\n): Promise<Buffer> {\r\n  // This requires a canvas implementation\r\n  // In Node.js, we'd use node-canvas or similar\r\n  // For now, return a placeholder - actual implementation depends on environment\r\n\r\n  const viewport = pdfPage.getViewport({ scale })\r\n\r\n  // In browser, we could use canvas:\r\n  // const canvas = document.createElement('canvas')\r\n  // canvas.width = viewport.width\r\n  // canvas.height = viewport.height\r\n  // const context = canvas.getContext('2d')\r\n  // await pdfPage.render({ canvasContext: context, viewport }).promise\r\n  // return canvas.toDataURL('image/png')\r\n\r\n  // In Node.js with node-canvas:\r\n  // const { createCanvas } = require('canvas')\r\n  // const canvas = createCanvas(viewport.width, viewport.height)\r\n  // ...\r\n\r\n  throw new Error(\"Page rendering requires canvas implementation - use in browser or with node-canvas\")\r\n}\r\n\r\n/**\r\n * Check if a page needs OCR\r\n */\r\nexport function pageNeedsOCR(page: ParsedPage): boolean {\r\n  // If page has very little text, it's likely scanned\r\n  const textLength = page.content.full_text.length\r\n  const pageArea = page.width * page.height\r\n\r\n  // Less than 100 characters per 100,000 square points\r\n  const textDensity = textLength / (pageArea / 100000)\r\n\r\n  return textDensity < OCR_CONFIG.min_text_density || page.is_scanned\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1655, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/documind/utils/fingerprint.ts"],"sourcesContent":["// ============================================\r\n// DOCUMIND ENGINE - DOCUMENT FINGERPRINTING\r\n// Creates unique identifiers for template matching\r\n// ============================================\r\n\r\nimport crypto from \"crypto\"\r\nimport type { ParsedPage, FormField, TableRegion, DocumentFingerprints } from \"../types\"\r\n\r\n/**\r\n * Generate document fingerprints for template matching\r\n * Fingerprints are based on structure, not content\r\n */\r\nexport function generateFingerprints(\r\n  pages: ParsedPage[],\r\n  formFields: FormField[],\r\n  tableRegions: TableRegion[],\r\n  contentHash: string,\r\n): DocumentFingerprints {\r\n  return {\r\n    structure_hash: generateStructureHash(pages),\r\n    layout_hash: generateLayoutHash(pages),\r\n    form_hash: formFields.length > 0 ? generateFormHash(formFields) : null,\r\n    table_hash: tableRegions.length > 0 ? generateTableHash(tableRegions) : null,\r\n    content_hash: contentHash,\r\n  }\r\n}\r\n\r\n/**\r\n * Generate structure hash based on overall document structure\r\n * - Page count and dimensions\r\n * - Text block distribution per page\r\n * - Section structure\r\n */\r\nfunction generateStructureHash(pages: ParsedPage[]): string {\r\n  const features: string[] = []\r\n\r\n  // Page count\r\n  features.push(`pages:${pages.length}`)\r\n\r\n  // Page dimensions (normalized to common sizes)\r\n  pages.forEach((page, idx) => {\r\n    const sizeClass = classifyPageSize(page.width, page.height)\r\n    const orientation = page.width > page.height ? \"landscape\" : \"portrait\"\r\n    features.push(`p${idx}:${sizeClass}:${orientation}`)\r\n  })\r\n\r\n  // Text density per page (binned)\r\n  pages.forEach((page, idx) => {\r\n    const blockCount = page.content.text_blocks.length\r\n    const densityBin = Math.floor(blockCount / 10) * 10 // Bin by 10s\r\n    features.push(`p${idx}:blocks:${densityBin}`)\r\n  })\r\n\r\n  // Heading structure\r\n  pages.forEach((page, idx) => {\r\n    const headings = page.content.text_blocks.filter((b) => b.block_type.startsWith(\"heading\")).length\r\n    features.push(`p${idx}:headings:${headings}`)\r\n  })\r\n\r\n  return hashString(features.join(\"|\"))\r\n}\r\n\r\n/**\r\n * Generate layout hash based on visual layout\r\n * - Margins and whitespace\r\n * - Column structure\r\n * - Visual regions\r\n */\r\nfunction generateLayoutHash(pages: ParsedPage[]): string {\r\n  const features: string[] = []\r\n\r\n  pages.forEach((page, idx) => {\r\n    // Estimate margins from text block positions\r\n    const blocks = page.content.text_blocks\r\n    if (blocks.length === 0) {\r\n      features.push(`p${idx}:empty`)\r\n      return\r\n    }\r\n\r\n    const leftMargin = Math.min(...blocks.map((b) => b.position_normalized.x))\r\n    const rightMargin = 1 - Math.max(...blocks.map((b) => b.position_normalized.x + b.position_normalized.width))\r\n    const topMargin = Math.min(...blocks.map((b) => b.position_normalized.y))\r\n\r\n    // Bin margins (0-10%, 10-20%, etc.)\r\n    const leftBin = Math.floor(leftMargin * 10)\r\n    const rightBin = Math.floor(rightMargin * 10)\r\n    const topBin = Math.floor(topMargin * 10)\r\n\r\n    features.push(`p${idx}:margins:${leftBin}:${rightBin}:${topBin}`)\r\n\r\n    // Detect columns (simple heuristic based on x-position clustering)\r\n    const xPositions = blocks.map((b) => b.position_normalized.x)\r\n    const columnCount = estimateColumnCount(xPositions)\r\n    features.push(`p${idx}:cols:${columnCount}`)\r\n  })\r\n\r\n  return hashString(features.join(\"|\"))\r\n}\r\n\r\n/**\r\n * Generate form hash based on form field positions\r\n */\r\nfunction generateFormHash(fields: FormField[]): string {\r\n  const features: string[] = []\r\n\r\n  // Field count by type\r\n  const typeCounts: Record<string, number> = {}\r\n  fields.forEach((f) => {\r\n    typeCounts[f.type] = (typeCounts[f.type] || 0) + 1\r\n  })\r\n  Object.entries(typeCounts)\r\n    .sort()\r\n    .forEach(([type, count]) => {\r\n      features.push(`type:${type}:${count}`)\r\n    })\r\n\r\n  // Field positions (binned to grid)\r\n  fields.forEach((field, idx) => {\r\n    const xBin = Math.floor(field.position_normalized.x * 10)\r\n    const yBin = Math.floor(field.position_normalized.y * 10)\r\n    features.push(`f${idx}:${field.page}:${xBin}:${yBin}`)\r\n  })\r\n\r\n  return hashString(features.join(\"|\"))\r\n}\r\n\r\n/**\r\n * Generate table hash based on table structures\r\n */\r\nfunction generateTableHash(tables: TableRegion[]): string {\r\n  const features: string[] = []\r\n\r\n  // Table count\r\n  features.push(`count:${tables.length}`)\r\n\r\n  // Table structures\r\n  tables.forEach((table, idx) => {\r\n    features.push(`t${idx}:${table.page}:${table.row_count_estimate}x${table.column_count_estimate}`)\r\n    const xBin = Math.floor(table.position_normalized.x * 10)\r\n    const yBin = Math.floor(table.position_normalized.y * 10)\r\n    features.push(`t${idx}:pos:${xBin}:${yBin}`)\r\n  })\r\n\r\n  return hashString(features.join(\"|\"))\r\n}\r\n\r\n/**\r\n * Generate content hash (for detecting identical documents)\r\n */\r\nexport function generateContentHash(text: string): string {\r\n  return hashString(text.toLowerCase().replace(/\\s+/g, \" \").trim())\r\n}\r\n\r\n/**\r\n * Calculate similarity score between two fingerprints\r\n * Returns 0-1 where 1 is identical\r\n */\r\nexport function calculateFingerprintSimilarity(a: DocumentFingerprints, b: DocumentFingerprints): number {\r\n  let totalWeight = 0\r\n  let weightedScore = 0\r\n\r\n  // Structure hash - most important (weight: 40%)\r\n  if (a.structure_hash === b.structure_hash) {\r\n    weightedScore += 0.4\r\n  }\r\n  totalWeight += 0.4\r\n\r\n  // Layout hash (weight: 25%)\r\n  if (a.layout_hash === b.layout_hash) {\r\n    weightedScore += 0.25\r\n  }\r\n  totalWeight += 0.25\r\n\r\n  // Form hash (weight: 25%) - only if both have forms\r\n  if (a.form_hash && b.form_hash) {\r\n    if (a.form_hash === b.form_hash) {\r\n      weightedScore += 0.25\r\n    }\r\n    totalWeight += 0.25\r\n  }\r\n\r\n  // Table hash (weight: 10%) - only if both have tables\r\n  if (a.table_hash && b.table_hash) {\r\n    if (a.table_hash === b.table_hash) {\r\n      weightedScore += 0.1\r\n    }\r\n    totalWeight += 0.1\r\n  }\r\n\r\n  return weightedScore / totalWeight\r\n}\r\n\r\n// Helper functions\r\n\r\nfunction hashString(str: string): string {\r\n  return crypto.createHash(\"sha256\").update(str).digest(\"hex\").substring(0, 16)\r\n}\r\n\r\nfunction classifyPageSize(width: number, height: number): string {\r\n  // Common page sizes in points\r\n  const sizes = {\r\n    a4: { w: 595, h: 842 },\r\n    letter: { w: 612, h: 792 },\r\n    legal: { w: 612, h: 1008 },\r\n    a3: { w: 842, h: 1191 },\r\n  }\r\n\r\n  const tolerance = 20 // Points tolerance\r\n\r\n  for (const [name, size] of Object.entries(sizes)) {\r\n    if (\r\n      (Math.abs(width - size.w) < tolerance && Math.abs(height - size.h) < tolerance) ||\r\n      (Math.abs(width - size.h) < tolerance && Math.abs(height - size.w) < tolerance)\r\n    ) {\r\n      return name\r\n    }\r\n  }\r\n\r\n  return \"custom\"\r\n}\r\n\r\nfunction estimateColumnCount(xPositions: number[]): number {\r\n  if (xPositions.length === 0) return 0\r\n\r\n  // Simple clustering based on x-position gaps\r\n  const sorted = [...xPositions].sort((a, b) => a - b)\r\n  const gaps: number[] = []\r\n\r\n  for (let i = 1; i < sorted.length; i++) {\r\n    gaps.push(sorted[i] - sorted[i - 1])\r\n  }\r\n\r\n  // Count significant gaps (> 0.2 of page width)\r\n  const significantGaps = gaps.filter((g) => g > 0.2).length\r\n\r\n  return Math.min(significantGaps + 1, 4) // Cap at 4 columns\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1855, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/documind/utils/validation.ts"],"sourcesContent":["// ============================================\r\n// DOCUMIND ENGINE - INPUT VALIDATION\r\n// ============================================\r\n\r\nimport type { ParseRequest, ParseOptions, DocuMindError } from \"../types\"\r\nimport { Errors } from \"../errors\"\r\nimport { MAX_FILE_SIZE, MAX_PAGES, SUPPORTED_MIME_TYPES, type SupportedMimeType } from \"../constants\"\r\n\r\nexport interface ValidationResult {\r\n  valid: boolean\r\n  error?: DocuMindError\r\n}\r\n\r\n/**\r\n * Validate a parse request\r\n */\r\nexport function validateParseRequest(request: ParseRequest): ValidationResult {\r\n  // Must have at least one input source\r\n  if (!request.file && !request.url && !request.base64) {\r\n    return {\r\n      valid: false,\r\n      error: Errors.invalidRequest(\"Must provide one of: file, url, or base64\"),\r\n    }\r\n  }\r\n\r\n  // Only one input source allowed\r\n  const inputCount = [request.file, request.url, request.base64].filter(Boolean).length\r\n  if (inputCount > 1) {\r\n    return {\r\n      valid: false,\r\n      error: Errors.invalidRequest(\"Only one input source allowed (file, url, or base64)\"),\r\n    }\r\n  }\r\n\r\n  // Validate app_id\r\n  if (!request.app_id || request.app_id.trim() === \"\") {\r\n    return {\r\n      valid: false,\r\n      error: Errors.missingRequiredField(\"app_id\"),\r\n    }\r\n  }\r\n\r\n  // Validate options if provided\r\n  if (request.options) {\r\n    const optionsResult = validateParseOptions(request.options)\r\n    if (!optionsResult.valid) {\r\n      return optionsResult\r\n    }\r\n  }\r\n\r\n  // Validate webhook URL if provided\r\n  if (request.webhook_url) {\r\n    try {\r\n      new URL(request.webhook_url)\r\n    } catch {\r\n      return {\r\n        valid: false,\r\n        error: Errors.invalidOptions(\"webhook_url\", \"Invalid URL format\"),\r\n      }\r\n    }\r\n  }\r\n\r\n  return { valid: true }\r\n}\r\n\r\n/**\r\n * Validate parse options\r\n */\r\nexport function validateParseOptions(options: ParseOptions): ValidationResult {\r\n  // Validate max_pages\r\n  if (options.max_pages !== undefined) {\r\n    if (options.max_pages < 1 || options.max_pages > MAX_PAGES) {\r\n      return {\r\n        valid: false,\r\n        error: Errors.invalidOptions(\"max_pages\", `Must be between 1 and ${MAX_PAGES}`),\r\n      }\r\n    }\r\n  }\r\n\r\n  // Validate priority\r\n  if (options.priority !== undefined) {\r\n    if (![\"low\", \"normal\", \"high\"].includes(options.priority)) {\r\n      return {\r\n        valid: false,\r\n        error: Errors.invalidOptions(\"priority\", \"Must be 'low', 'normal', or 'high'\"),\r\n      }\r\n    }\r\n  }\r\n\r\n  // Validate OCR language\r\n  if (options.ocr_language !== undefined) {\r\n    const validLanguages = [\"en\", \"eng\", \"afr\", \"zul\", \"xho\", \"sot\", \"tsn\"]\r\n    if (!validLanguages.includes(options.ocr_language)) {\r\n      return {\r\n        valid: false,\r\n        error: Errors.invalidOptions(\"ocr_language\", `Supported languages: ${validLanguages.join(\", \")}`),\r\n      }\r\n    }\r\n  }\r\n\r\n  return { valid: true }\r\n}\r\n\r\n/**\r\n * Validate file metadata\r\n */\r\nexport function validateFile(mimeType: string, size: number): ValidationResult {\r\n  // Check file size\r\n  if (size > MAX_FILE_SIZE) {\r\n    return {\r\n      valid: false,\r\n      error: Errors.fileTooLarge(MAX_FILE_SIZE, size),\r\n    }\r\n  }\r\n\r\n  // Check MIME type\r\n  if (!SUPPORTED_MIME_TYPES.includes(mimeType as SupportedMimeType)) {\r\n    return {\r\n      valid: false,\r\n      error: Errors.unsupportedFormat(mimeType),\r\n    }\r\n  }\r\n\r\n  return { valid: true }\r\n}\r\n\r\n/**\r\n * Detect MIME type from file header (magic bytes)\r\n */\r\nexport function detectMimeType(buffer: Buffer): string | null {\r\n  // Check first bytes for magic numbers\r\n  const header = buffer.slice(0, 8)\r\n\r\n  // PDF: %PDF\r\n  if (header[0] === 0x25 && header[1] === 0x50 && header[2] === 0x44 && header[3] === 0x46) {\r\n    return \"application/pdf\"\r\n  }\r\n\r\n  // PNG: 89 50 4E 47\r\n  if (header[0] === 0x89 && header[1] === 0x50 && header[2] === 0x4e && header[3] === 0x47) {\r\n    return \"image/png\"\r\n  }\r\n\r\n  // JPEG: FF D8 FF\r\n  if (header[0] === 0xff && header[1] === 0xd8 && header[2] === 0xff) {\r\n    return \"image/jpeg\"\r\n  }\r\n\r\n  // TIFF: 49 49 2A 00 (little-endian) or 4D 4D 00 2A (big-endian)\r\n  if (\r\n    (header[0] === 0x49 && header[1] === 0x49 && header[2] === 0x2a && header[3] === 0x00) ||\r\n    (header[0] === 0x4d && header[1] === 0x4d && header[2] === 0x00 && header[3] === 0x2a)\r\n  ) {\r\n    return \"image/tiff\"\r\n  }\r\n\r\n  // DOCX: PK (ZIP archive) - need additional check\r\n  if (header[0] === 0x50 && header[1] === 0x4b) {\r\n    // Could be docx, xlsx, etc. - needs content inspection\r\n    return \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\"\r\n  }\r\n\r\n  // DOC: D0 CF 11 E0 (OLE compound)\r\n  if (header[0] === 0xd0 && header[1] === 0xcf && header[2] === 0x11 && header[3] === 0xe0) {\r\n    return \"application/msword\"\r\n  }\r\n\r\n  return null\r\n}\r\n\r\n/**\r\n * Sanitize filename for storage\r\n */\r\nexport function sanitizeFilename(filename: string): string {\r\n  // Remove path separators and dangerous characters\r\n  return filename\r\n    .replace(/[/\\\\:*?\"<>|]/g, \"_\")\r\n    .replace(/\\.\\./g, \"_\")\r\n    .replace(/^\\./, \"_\")\r\n    .substring(0, 255)\r\n}\r\n\r\n/**\r\n * Generate a unique document ID\r\n */\r\nexport function generateDocumentId(): string {\r\n  return crypto.randomUUID()\r\n}\r\n\r\n/**\r\n * Validate UUID format\r\n */\r\nexport function isValidUUID(str: string): boolean {\r\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i\r\n  return uuidRegex.test(str)\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2036, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/documind/index.ts"],"sourcesContent":["// ============================================\r\n// DOCUMIND ENGINE - MAIN ENTRY POINT\r\n// ============================================\r\n\r\nexport * from \"./types\"\r\nexport * from \"./errors\"\r\nexport * from \"./constants\"\r\n\r\n// Modules\r\nexport { parsePDF, type PDFParseResult, type PDFParseOptions } from \"./modules/pdf-parser\"\r\nexport { analyzeLayout, type LayoutAnalysisResult } from \"./modules/layout-analyzer\"\r\nexport { performOCR, mergeOCRWithPage, pageNeedsOCR, type OCRResult, type OCRPage } from \"./modules/ocr-engine\"\r\n\r\n// Utils\r\nexport * from \"./utils/position-mapper\"\r\nexport * from \"./utils/fingerprint\"\r\nexport * from \"./utils/validation\"\r\n\r\n// Main processing function\r\nimport { parsePDF } from \"./modules/pdf-parser\"\r\nimport { analyzeLayout } from \"./modules/layout-analyzer\"\r\nimport { pageNeedsOCR } from \"./modules/ocr-engine\"\r\nimport { generateFingerprints, generateContentHash } from \"./utils/fingerprint\"\r\nimport { validateFile } from \"./utils/validation\"\r\nimport { Errors } from \"./errors\"\r\nimport type { ParsedDocument, ParseOptions, DocuMindError, ProcessingInfo } from \"./types\"\r\n\r\nexport interface ProcessDocumentResult {\r\n  success: boolean\r\n  document?: ParsedDocument\r\n  error?: DocuMindError\r\n}\r\n\r\n/**\r\n * Main document processing function\r\n * Orchestrates parsing, OCR, layout analysis, and fingerprinting\r\n */\r\nexport async function processDocument(\r\n  data: ArrayBuffer | Uint8Array,\r\n  mimeType: string,\r\n  options: ParseOptions = {},\r\n): Promise<ProcessDocumentResult> {\r\n  const startTime = Date.now()\r\n  const warnings: string[] = []\r\n\r\n  try {\r\n    // Validate file\r\n    const fileValidation = validateFile(mimeType, data.byteLength)\r\n    if (!fileValidation.valid) {\r\n      return { success: false, error: fileValidation.error }\r\n    }\r\n\r\n    // Currently only supporting PDF\r\n    if (mimeType !== \"application/pdf\") {\r\n      return {\r\n        success: false,\r\n        error: Errors.unsupportedFormat(mimeType),\r\n      }\r\n    }\r\n\r\n    // Parse PDF\r\n    const parseResult = await parsePDF(data, {\r\n      extractImages: options.extract_images,\r\n      maxPages: options.max_pages,\r\n      password: options.password,\r\n    })\r\n\r\n    const pages = parseResult.pages\r\n    let ocrUsed = false\r\n    const ocrConfidence: number | null = null\r\n\r\n    // Perform OCR on scanned pages if enabled\r\n    if (options.ocr_enabled !== false) {\r\n      for (let i = 0; i < pages.length; i++) {\r\n        if (pageNeedsOCR(pages[i])) {\r\n          warnings.push(`Page ${i + 1} appears to be scanned, OCR required`)\r\n          // Note: Full OCR implementation would render page to image first\r\n          // For now, mark as needing OCR\r\n          ocrUsed = true\r\n        }\r\n      }\r\n    }\r\n\r\n    // Analyze layout\r\n    const layoutResult = analyzeLayout(pages, parseResult.metadata.detected_type)\r\n\r\n    // Generate fingerprints\r\n    const contentHash = generateContentHash(parseResult.rawText)\r\n    const fingerprints = generateFingerprints(pages, parseResult.formFields, layoutResult.tableRegions, contentHash)\r\n\r\n    // Build processing info\r\n    const processingInfo: ProcessingInfo = {\r\n      duration_ms: Date.now() - startTime,\r\n      ocr_used: ocrUsed,\r\n      ocr_engine: ocrUsed ? \"tesseract\" : null,\r\n      ocr_confidence: ocrConfidence,\r\n      warnings,\r\n      pages_processed: pages.length,\r\n      pages_skipped: (options.max_pages || 0) > 0 ? Math.max(0, parseResult.metadata.page_count - pages.length) : 0,\r\n    }\r\n\r\n    // Build final document\r\n    const document: ParsedDocument = {\r\n      document_id: crypto.randomUUID(),\r\n      status: warnings.length > 0 ? \"partial\" : \"complete\",\r\n      metadata: parseResult.metadata,\r\n      fingerprints,\r\n      pages,\r\n      layout: layoutResult.layout,\r\n      form_fields: parseResult.formFields,\r\n      processing: processingInfo,\r\n    }\r\n\r\n    return { success: true, document }\r\n  } catch (error) {\r\n    console.error(\"Document processing error:\", error)\r\n    return {\r\n      success: false,\r\n      error: Errors.parseFailed(\"unknown\", error instanceof Error ? error.message : \"Unknown error\"),\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,+CAA+C;AAC/C,qCAAqC;AACrC,+CAA+C;;;;;AAE/C;AACA;AACA;AAEA,UAAU;AACV;AACA;AACA;AAEA,QAAQ;AACR;AACA;AACA;;;;;;;;;;;;;;;;AAqBO,eAAe,gBACpB,IAA8B,EAC9B,QAAgB,EAChB,UAAwB,CAAC,CAAC;IAE1B,MAAM,YAAY,KAAK,GAAG;IAC1B,MAAM,WAAqB,EAAE;IAE7B,IAAI;QACF,gBAAgB;QAChB,MAAM,iBAAiB,IAAA,mKAAY,EAAC,UAAU,KAAK,UAAU;QAC7D,IAAI,CAAC,eAAe,KAAK,EAAE;YACzB,OAAO;gBAAE,SAAS;gBAAO,OAAO,eAAe,KAAK;YAAC;QACvD;QAEA,gCAAgC;QAChC,IAAI,aAAa,mBAAmB;YAClC,OAAO;gBACL,SAAS;gBACT,OAAO,gJAAM,CAAC,iBAAiB,CAAC;YAClC;QACF;QAEA,YAAY;QACZ,MAAM,cAAc,MAAM,IAAA,oKAAQ,EAAC,MAAM;YACvC,eAAe,QAAQ,cAAc;YACrC,UAAU,QAAQ,SAAS;YAC3B,UAAU,QAAQ,QAAQ;QAC5B;QAEA,MAAM,QAAQ,YAAY,KAAK;QAC/B,IAAI,UAAU;QACd,MAAM,gBAA+B;QAErC,0CAA0C;QAC1C,IAAI,QAAQ,WAAW,KAAK,OAAO;YACjC,IAAK,IAAI,IAAI,GAAG,IAAI,MAAM,MAAM,EAAE,IAAK;gBACrC,IAAI,IAAA,wKAAY,EAAC,KAAK,CAAC,EAAE,GAAG;oBAC1B,SAAS,IAAI,CAAC,CAAC,KAAK,EAAE,IAAI,EAAE,oCAAoC,CAAC;oBACjE,iEAAiE;oBACjE,+BAA+B;oBAC/B,UAAU;gBACZ;YACF;QACF;QAEA,iBAAiB;QACjB,MAAM,eAAe,IAAA,8KAAa,EAAC,OAAO,YAAY,QAAQ,CAAC,aAAa;QAE5E,wBAAwB;QACxB,MAAM,cAAc,IAAA,2KAAmB,EAAC,YAAY,OAAO;QAC3D,MAAM,eAAe,IAAA,4KAAoB,EAAC,OAAO,YAAY,UAAU,EAAE,aAAa,YAAY,EAAE;QAEpG,wBAAwB;QACxB,MAAM,iBAAiC;YACrC,aAAa,KAAK,GAAG,KAAK;YAC1B,UAAU;YACV,YAAY,UAAU,cAAc;YACpC,gBAAgB;YAChB;YACA,iBAAiB,MAAM,MAAM;YAC7B,eAAe,CAAC,QAAQ,SAAS,IAAI,CAAC,IAAI,IAAI,KAAK,GAAG,CAAC,GAAG,YAAY,QAAQ,CAAC,UAAU,GAAG,MAAM,MAAM,IAAI;QAC9G;QAEA,uBAAuB;QACvB,MAAM,WAA2B;YAC/B,aAAa,OAAO,UAAU;YAC9B,QAAQ,SAAS,MAAM,GAAG,IAAI,YAAY;YAC1C,UAAU,YAAY,QAAQ;YAC9B;YACA;YACA,QAAQ,aAAa,MAAM;YAC3B,aAAa,YAAY,UAAU;YACnC,YAAY;QACd;QAEA,OAAO;YAAE,SAAS;YAAM;QAAS;IACnC,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO;YACL,SAAS;YACT,OAAO,gJAAM,CAAC,WAAW,CAAC,WAAW,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAChF;IACF;AACF"}},
    {"offset": {"line": 2150, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/tenders/types.ts"],"sourcesContent":["// Tender Engine Types - Central definition of what a tender should contain\r\n\r\nexport interface TenderField {\r\n  name: string\r\n  displayName: string\r\n  type: \"string\" | \"number\" | \"date\" | \"array\" | \"boolean\" | \"object\"\r\n  required: boolean\r\n  description: string\r\n  validationRules?: {\r\n    min?: number\r\n    max?: number\r\n    pattern?: string\r\n    format?: string\r\n  }\r\n  extractionHints: {\r\n    aliases: string[] // Alternative names this field might have\r\n    patterns: string[] // Regex patterns to find this field\r\n    context: string[] // Words that often appear near this field\r\n    priority: number // How important this field is (1-10)\r\n  }\r\n}\r\n\r\nexport interface TenderSchema {\r\n  version: string\r\n  fields: TenderField[]\r\n  requiredFields: string[]\r\n  optionalFields: string[]\r\n  documentTypes: string[]\r\n}\r\n\r\nexport interface TenderValidationResult {\r\n  isValid: boolean\r\n  score: number // Completeness score 0-100\r\n  errors: Array<{\r\n    field: string\r\n    message: string\r\n    severity: \"error\" | \"warning\"\r\n  }>\r\n  missingFields: string[]\r\n  warnings: string[]\r\n  // Optional legacy/consumer-friendly properties\r\n  grade?: string\r\n  completeness?: number\r\n}\r\n"],"names":[],"mappings":"AAAA,2EAA2E"}},
    {"offset": {"line": 2157, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/tenders/schema.ts"],"sourcesContent":["import type { TenderField, TenderSchema } from \"./types\"\r\n\r\n// Central tender schema - this is what scrapers should aim to extract\r\nexport const TENDER_SCHEMA: TenderSchema = {\r\n  version: \"1.0.0\",\r\n  requiredFields: [\"title\", \"organization\"],\r\n  optionalFields: [\r\n    \"tender_reference\",\r\n    \"close_date\",\r\n    \"description\",\r\n    \"category\",\r\n    \"location\",\r\n    \"estimated_value\",\r\n    \"publish_date\",\r\n    \"opening_date\",\r\n    \"contact_person\",\r\n    \"contact_email\",\r\n    \"contact_phone\",\r\n    \"submission_method\",\r\n    \"requirements\",\r\n    \"eligibility_criteria\",\r\n    \"payment_terms\",\r\n    \"contract_duration\",\r\n    \"compulsory_briefing\",\r\n    \"tender_type\",\r\n    \"procurement_category\",\r\n  ],\r\n  documentTypes: [\r\n    \"Tender Document\",\r\n    \"Terms of Reference\",\r\n    \"Specifications\",\r\n    \"Pricing Schedule\",\r\n    \"SBD Forms\",\r\n    \"Declaration Forms\",\r\n    \"Technical Requirements\",\r\n    \"Contract Terms\",\r\n  ],\r\n  fields: [\r\n    {\r\n      name: \"tender_reference\",\r\n      displayName: \"Tender Reference Number\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Unique identifier for the tender\",\r\n      extractionHints: {\r\n        aliases: [\"tender number\", \"reference\", \"tender no\", \"ref no\", \"reference number\", \"tender id\"],\r\n        patterns: [\"\\\\b[A-Z]{2,}[\\\\/-]?\\\\d{2,}[\\\\/-]?\\\\d{2,}\\\\b\", \"\\\\bT\\\\d{4,}\\\\b\", \"\\\\b\\\\d{2,}\\\\/\\\\d{4}\\\\b\"],\r\n        context: [\"reference\", \"tender\", \"number\", \"quotation\"],\r\n        priority: 10,\r\n      },\r\n    },\r\n    {\r\n      name: \"title\",\r\n      displayName: \"Tender Title\",\r\n      type: \"string\",\r\n      required: true,\r\n      description: \"The main title or subject of the tender\",\r\n      extractionHints: {\r\n        aliases: [\"tender title\", \"subject\", \"project name\", \"tender for\"],\r\n        patterns: [],\r\n        context: [\"tender\", \"project\", \"supply\", \"services\", \"appointment\"],\r\n        priority: 10,\r\n      },\r\n    },\r\n    {\r\n      name: \"organization\",\r\n      displayName: \"Issuing Organization\",\r\n      type: \"string\",\r\n      required: true,\r\n      description: \"The organization issuing the tender\",\r\n      extractionHints: {\r\n        aliases: [\"organization\", \"department\", \"municipality\", \"entity\", \"client\", \"issuer\"],\r\n        patterns: [],\r\n        context: [\"municipality\", \"department\", \"ministry\", \"council\"],\r\n        priority: 9,\r\n      },\r\n    },\r\n    {\r\n      name: \"description\",\r\n      displayName: \"Description\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Detailed description of what is being procured\",\r\n      extractionHints: {\r\n        aliases: [\"description\", \"scope\", \"scope of work\", \"requirements\", \"details\"],\r\n        patterns: [],\r\n        context: [\"scope\", \"required\", \"must\", \"shall\", \"includes\"],\r\n        priority: 8,\r\n      },\r\n    },\r\n    {\r\n      name: \"category\",\r\n      displayName: \"Category\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"The procurement category or sector\",\r\n      extractionHints: {\r\n        aliases: [\"category\", \"sector\", \"type\", \"classification\"],\r\n        patterns: [],\r\n        context: [\"construction\", \"it\", \"services\", \"goods\", \"works\"],\r\n        priority: 7,\r\n      },\r\n    },\r\n    {\r\n      name: \"location\",\r\n      displayName: \"Location\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Physical location or province\",\r\n      extractionHints: {\r\n        aliases: [\"location\", \"province\", \"region\", \"area\", \"place\"],\r\n        patterns: [\r\n          \"Gauteng|Western Cape|Eastern Cape|KwaZulu-Natal|Free State|Limpopo|Mpumalanga|Northern Cape|North West\",\r\n        ],\r\n        context: [\"province\", \"located\", \"region\"],\r\n        priority: 6,\r\n      },\r\n    },\r\n    {\r\n      name: \"estimated_value\",\r\n      displayName: \"Estimated Value\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"The estimated contract value\",\r\n      extractionHints: {\r\n        aliases: [\"value\", \"budget\", \"amount\", \"contract value\", \"estimated cost\"],\r\n        patterns: [\"R\\\\s?[\\\\d,]+\", \"ZAR\\\\s?[\\\\d,]+\"],\r\n        context: [\"value\", \"budget\", \"rand\", \"amount\"],\r\n        priority: 8,\r\n      },\r\n    },\r\n    {\r\n      name: \"publish_date\",\r\n      displayName: \"Publish Date\",\r\n      type: \"date\",\r\n      required: false,\r\n      description: \"When the tender was published\",\r\n      extractionHints: {\r\n        aliases: [\"publish date\", \"publication date\", \"advertised\", \"issued date\"],\r\n        patterns: [\"\\\\d{1,2}[\\\\/-]\\\\d{1,2}[\\\\/-]\\\\d{2,4}\", \"\\\\d{4}[\\\\/-]\\\\d{2}[\\\\/-]\\\\d{2}\"],\r\n        context: [\"published\", \"advertised\", \"issued\"],\r\n        priority: 5,\r\n      },\r\n    },\r\n    {\r\n      name: \"close_date\",\r\n      displayName: \"Closing Date\",\r\n      type: \"date\",\r\n      required: false,\r\n      description: \"Submission deadline\",\r\n      validationRules: {\r\n        format: \"ISO8601\",\r\n      },\r\n      extractionHints: {\r\n        aliases: [\"closing date\", \"deadline\", \"submission date\", \"due date\", \"closes\"],\r\n        patterns: [\"\\\\d{1,2}[\\\\/-]\\\\d{1,2}[\\\\/-]\\\\d{2,4}\", \"\\\\d{4}[\\\\/-]\\\\d{2}[\\\\/-]\\\\d{2}\"],\r\n        context: [\"closing\", \"deadline\", \"closes\", \"due\"],\r\n        priority: 10,\r\n      },\r\n    },\r\n    {\r\n      name: \"opening_date\",\r\n      displayName: \"Opening Date\",\r\n      type: \"date\",\r\n      required: false,\r\n      description: \"When bids will be opened\",\r\n      extractionHints: {\r\n        aliases: [\"opening date\", \"bid opening\", \"tender opening\"],\r\n        patterns: [\"\\\\d{1,2}[\\\\/-]\\\\d{1,2}[\\\\/-]\\\\d{2,4}\", \"\\\\d{4}[\\\\/-]\\\\d{2}[\\\\/-]\\\\d{2}\"],\r\n        context: [\"opening\", \"bids will be opened\"],\r\n        priority: 4,\r\n      },\r\n    },\r\n    {\r\n      name: \"contact_person\",\r\n      displayName: \"Contact Person\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Name of contact person\",\r\n      extractionHints: {\r\n        aliases: [\"contact person\", \"contact\", \"enquiries\", \"contact name\"],\r\n        patterns: [\"[A-Z][a-z]+\\\\s+[A-Z][a-z]+\"],\r\n        context: [\"contact\", \"enquiries\", \"person\"],\r\n        priority: 5,\r\n      },\r\n    },\r\n    {\r\n      name: \"contact_email\",\r\n      displayName: \"Contact Email\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Email address for enquiries\",\r\n      validationRules: {\r\n        pattern: \"^[^\\\\s@]+@[^\\\\s@]+\\\\.[^\\\\s@]+$\",\r\n      },\r\n      extractionHints: {\r\n        aliases: [\"email\", \"e-mail\", \"email address\"],\r\n        patterns: [\"[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\\\.[a-zA-Z]{2,}\"],\r\n        context: [\"email\", \"contact\", \"enquiries\"],\r\n        priority: 6,\r\n      },\r\n    },\r\n    {\r\n      name: \"contact_phone\",\r\n      displayName: \"Contact Phone\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Phone number for enquiries\",\r\n      extractionHints: {\r\n        aliases: [\"phone\", \"telephone\", \"tel\", \"contact number\"],\r\n        patterns: [\"\\\\+?27\\\\s?\\\\d{2}\\\\s?\\\\d{3}\\\\s?\\\\d{4}\", \"$$?0\\\\d{2}$$?\\\\s?\\\\d{3}\\\\s?\\\\d{4}\"],\r\n        context: [\"phone\", \"tel\", \"contact\", \"call\"],\r\n        priority: 5,\r\n      },\r\n    },\r\n    {\r\n      name: \"requirements\",\r\n      displayName: \"Requirements\",\r\n      type: \"array\",\r\n      required: false,\r\n      description: \"List of tender requirements\",\r\n      extractionHints: {\r\n        aliases: [\"requirements\", \"mandatory requirements\", \"prerequisites\", \"must have\"],\r\n        patterns: [],\r\n        context: [\"required\", \"must\", \"mandatory\", \"compulsory\"],\r\n        priority: 7,\r\n      },\r\n    },\r\n    {\r\n      name: \"eligibility_criteria\",\r\n      displayName: \"Eligibility Criteria\",\r\n      type: \"array\",\r\n      required: false,\r\n      description: \"Who can bid\",\r\n      extractionHints: {\r\n        aliases: [\"eligibility\", \"eligible\", \"who may bid\", \"qualification criteria\"],\r\n        patterns: [],\r\n        context: [\"eligible\", \"may bid\", \"qualified\", \"registration\"],\r\n        priority: 6,\r\n      },\r\n    },\r\n    {\r\n      name: \"compulsory_briefing\",\r\n      displayName: \"Compulsory Briefing\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Information about mandatory briefing sessions\",\r\n      extractionHints: {\r\n        aliases: [\"compulsory briefing\", \"mandatory briefing\", \"site visit\", \"pre-bid meeting\"],\r\n        patterns: [],\r\n        context: [\"compulsory\", \"mandatory\", \"briefing\", \"meeting\", \"site\"],\r\n        priority: 7,\r\n      },\r\n    },\r\n    {\r\n      name: \"tender_type\",\r\n      displayName: \"Tender Type\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Type of procurement (RFQ, RFP, etc)\",\r\n      extractionHints: {\r\n        aliases: [\"tender type\", \"procurement type\", \"bid type\"],\r\n        patterns: [\"RFQ|RFP|RFI|ITB|EOI\"],\r\n        context: [\"request for\", \"quotation\", \"proposal\"],\r\n        priority: 5,\r\n      },\r\n    },\r\n  ],\r\n}\r\n\r\n// Function to get field by name\r\nexport function getTenderField(fieldName: string): TenderField | undefined {\r\n  return TENDER_SCHEMA.fields.find((f) => f.name === fieldName)\r\n}\r\n\r\n// Function to get required fields\r\nexport function getRequiredFields(): TenderField[] {\r\n  return TENDER_SCHEMA.fields.filter((f) => f.required)\r\n}\r\n\r\n// Function to get all field extraction hints for scraping\r\nexport function getAllExtractionHints() {\r\n  return TENDER_SCHEMA.fields.map((field) => ({\r\n    field: field.name,\r\n    displayName: field.displayName,\r\n    ...field.extractionHints,\r\n  }))\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;AAGO,MAAM,gBAA8B;IACzC,SAAS;IACT,gBAAgB;QAAC;QAAS;KAAe;IACzC,gBAAgB;QACd;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACD,eAAe;QACb;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACD,QAAQ;QACN;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;oBAAC;oBAAiB;oBAAa;oBAAa;oBAAU;oBAAoB;iBAAY;gBAC/F,UAAU;oBAAC;oBAA+C;oBAAkB;iBAAyB;gBACrG,SAAS;oBAAC;oBAAa;oBAAU;oBAAU;iBAAY;gBACvD,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;oBAAC;oBAAgB;oBAAW;oBAAgB;iBAAa;gBAClE,UAAU,EAAE;gBACZ,SAAS;oBAAC;oBAAU;oBAAW;oBAAU;oBAAY;iBAAc;gBACnE,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;oBAAC;oBAAgB;oBAAc;oBAAgB;oBAAU;oBAAU;iBAAS;gBACrF,UAAU,EAAE;gBACZ,SAAS;oBAAC;oBAAgB;oBAAc;oBAAY;iBAAU;gBAC9D,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;oBAAC;oBAAe;oBAAS;oBAAiB;oBAAgB;iBAAU;gBAC7E,UAAU,EAAE;gBACZ,SAAS;oBAAC;oBAAS;oBAAY;oBAAQ;oBAAS;iBAAW;gBAC3D,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;oBAAC;oBAAY;oBAAU;oBAAQ;iBAAiB;gBACzD,UAAU,EAAE;gBACZ,SAAS;oBAAC;oBAAgB;oBAAM;oBAAY;oBAAS;iBAAQ;gBAC7D,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;oBAAC;oBAAY;oBAAY;oBAAU;oBAAQ;iBAAQ;gBAC5D,UAAU;oBACR;iBACD;gBACD,SAAS;oBAAC;oBAAY;oBAAW;iBAAS;gBAC1C,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;oBAAC;oBAAS;oBAAU;oBAAU;oBAAkB;iBAAiB;gBAC1E,UAAU;oBAAC;oBAAgB;iBAAiB;gBAC5C,SAAS;oBAAC;oBAAS;oBAAU;oBAAQ;iBAAS;gBAC9C,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;oBAAC;oBAAgB;oBAAoB;oBAAc;iBAAc;gBAC1E,UAAU;oBAAC;oBAAwC;iBAAiC;gBACpF,SAAS;oBAAC;oBAAa;oBAAc;iBAAS;gBAC9C,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,QAAQ;YACV;YACA,iBAAiB;gBACf,SAAS;oBAAC;oBAAgB;oBAAY;oBAAmB;oBAAY;iBAAS;gBAC9E,UAAU;oBAAC;oBAAwC;iBAAiC;gBACpF,SAAS;oBAAC;oBAAW;oBAAY;oBAAU;iBAAM;gBACjD,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;oBAAC;oBAAgB;oBAAe;iBAAiB;gBAC1D,UAAU;oBAAC;oBAAwC;iBAAiC;gBACpF,SAAS;oBAAC;oBAAW;iBAAsB;gBAC3C,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;oBAAC;oBAAkB;oBAAW;oBAAa;iBAAe;gBACnE,UAAU;oBAAC;iBAA6B;gBACxC,SAAS;oBAAC;oBAAW;oBAAa;iBAAS;gBAC3C,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;YACX;YACA,iBAAiB;gBACf,SAAS;oBAAC;oBAAS;oBAAU;iBAAgB;gBAC7C,UAAU;oBAAC;iBAAkD;gBAC7D,SAAS;oBAAC;oBAAS;oBAAW;iBAAY;gBAC1C,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;oBAAC;oBAAS;oBAAa;oBAAO;iBAAiB;gBACxD,UAAU;oBAAC;oBAAwC;iBAAoC;gBACvF,SAAS;oBAAC;oBAAS;oBAAO;oBAAW;iBAAO;gBAC5C,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;oBAAC;oBAAgB;oBAA0B;oBAAiB;iBAAY;gBACjF,UAAU,EAAE;gBACZ,SAAS;oBAAC;oBAAY;oBAAQ;oBAAa;iBAAa;gBACxD,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;oBAAC;oBAAe;oBAAY;oBAAe;iBAAyB;gBAC7E,UAAU,EAAE;gBACZ,SAAS;oBAAC;oBAAY;oBAAW;oBAAa;iBAAe;gBAC7D,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;oBAAC;oBAAuB;oBAAsB;oBAAc;iBAAkB;gBACvF,UAAU,EAAE;gBACZ,SAAS;oBAAC;oBAAc;oBAAa;oBAAY;oBAAW;iBAAO;gBACnE,UAAU;YACZ;QACF;QACA;YACE,MAAM;YACN,aAAa;YACb,MAAM;YACN,UAAU;YACV,aAAa;YACb,iBAAiB;gBACf,SAAS;oBAAC;oBAAe;oBAAoB;iBAAW;gBACxD,UAAU;oBAAC;iBAAsB;gBACjC,SAAS;oBAAC;oBAAe;oBAAa;iBAAW;gBACjD,UAAU;YACZ;QACF;KACD;AACH;AAGO,SAAS,eAAe,SAAiB;IAC9C,OAAO,cAAc,MAAM,CAAC,IAAI,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK;AACrD;AAGO,SAAS;IACd,OAAO,cAAc,MAAM,CAAC,MAAM,CAAC,CAAC,IAAM,EAAE,QAAQ;AACtD;AAGO,SAAS;IACd,OAAO,cAAc,MAAM,CAAC,GAAG,CAAC,CAAC,QAAU,CAAC;YAC1C,OAAO,MAAM,IAAI;YACjB,aAAa,MAAM,WAAW;YAC9B,GAAG,MAAM,eAAe;QAC1B,CAAC;AACH"}},
    {"offset": {"line": 2650, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/tenders/validator.ts"],"sourcesContent":["import { TENDER_SCHEMA } from \"./schema\"\r\nimport type { TenderValidationResult } from \"./types\"\r\n\r\nexport class TenderValidator {\r\n  static validate(tenderData: any): TenderValidationResult {\r\n    const errors: TenderValidationResult[\"errors\"] = []\r\n    const warnings: string[] = []\r\n    const missingFields: string[] = []\r\n\r\n    // Check required fields\r\n    for (const fieldName of TENDER_SCHEMA.requiredFields) {\r\n      if (!tenderData[fieldName] || tenderData[fieldName] === \"\") {\r\n        errors.push({\r\n          field: fieldName,\r\n          message: `Required field '${fieldName}' is missing or empty`,\r\n          severity: \"error\",\r\n        })\r\n        missingFields.push(fieldName)\r\n      }\r\n    }\r\n\r\n    // Check optional fields for completeness\r\n    for (const fieldName of TENDER_SCHEMA.optionalFields) {\r\n      if (!tenderData[fieldName] || tenderData[fieldName] === \"\") {\r\n        warnings.push(`Optional field '${fieldName}' is missing - tender may be incomplete`)\r\n        missingFields.push(fieldName)\r\n      }\r\n    }\r\n\r\n    // Validate field formats\r\n    const emailField = tenderData.contact_email\r\n    if (emailField && !this.isValidEmail(emailField)) {\r\n      errors.push({\r\n        field: \"contact_email\",\r\n        message: \"Invalid email format\",\r\n        severity: \"warning\",\r\n      })\r\n    }\r\n\r\n    // Calculate completeness score\r\n    const totalFields = TENDER_SCHEMA.requiredFields.length + TENDER_SCHEMA.optionalFields.length\r\n    const filledFields = totalFields - missingFields.length\r\n    const score = Math.round((filledFields / totalFields) * 100)\r\n\r\n    return {\r\n      isValid: errors.filter((e) => e.severity === \"error\").length === 0,\r\n      score,\r\n      errors,\r\n      missingFields,\r\n      warnings,\r\n    }\r\n  }\r\n\r\n  private static isValidEmail(email: string): boolean {\r\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/\r\n    return emailRegex.test(email)\r\n  }\r\n\r\n  // Get a quality score for a tender based on completeness\r\n  static getQualityScore(tenderData: any): {\r\n    score: number\r\n    grade: string\r\n    feedback: string[]\r\n  } {\r\n    const validation = this.validate(tenderData)\r\n    const feedback: string[] = []\r\n\r\n    if (validation.score === 100) {\r\n      feedback.push(\"âœ“ All fields populated\")\r\n    } else if (validation.score >= 80) {\r\n      feedback.push(\"âœ“ Most important fields populated\")\r\n    } else if (validation.score >= 60) {\r\n      feedback.push(\"âš  Missing some important information\")\r\n    } else {\r\n      feedback.push(\"âœ— Tender data is incomplete\")\r\n    }\r\n\r\n    if (validation.missingFields.includes(\"tender_reference\")) {\r\n      feedback.push(\"âœ— Missing tender reference number\")\r\n    }\r\n    if (validation.missingFields.includes(\"close_date\")) {\r\n      feedback.push(\"âœ— Missing closing date\")\r\n    }\r\n    if (validation.missingFields.includes(\"contact_email\")) {\r\n      feedback.push(\"âš  No contact email found\")\r\n    }\r\n    if (validation.missingFields.includes(\"estimated_value\")) {\r\n      feedback.push(\"âš  No tender value information\")\r\n    }\r\n\r\n    const grade =\r\n      validation.score >= 90\r\n        ? \"A\"\r\n        : validation.score >= 80\r\n          ? \"B\"\r\n          : validation.score >= 70\r\n            ? \"C\"\r\n            : validation.score >= 60\r\n              ? \"D\"\r\n              : \"F\"\r\n\r\n    return {\r\n      score: validation.score,\r\n      grade,\r\n      feedback,\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAGO,MAAM;IACX,OAAO,SAAS,UAAe,EAA0B;QACvD,MAAM,SAA2C,EAAE;QACnD,MAAM,WAAqB,EAAE;QAC7B,MAAM,gBAA0B,EAAE;QAElC,wBAAwB;QACxB,KAAK,MAAM,aAAa,sJAAa,CAAC,cAAc,CAAE;YACpD,IAAI,CAAC,UAAU,CAAC,UAAU,IAAI,UAAU,CAAC,UAAU,KAAK,IAAI;gBAC1D,OAAO,IAAI,CAAC;oBACV,OAAO;oBACP,SAAS,CAAC,gBAAgB,EAAE,UAAU,qBAAqB,CAAC;oBAC5D,UAAU;gBACZ;gBACA,cAAc,IAAI,CAAC;YACrB;QACF;QAEA,yCAAyC;QACzC,KAAK,MAAM,aAAa,sJAAa,CAAC,cAAc,CAAE;YACpD,IAAI,CAAC,UAAU,CAAC,UAAU,IAAI,UAAU,CAAC,UAAU,KAAK,IAAI;gBAC1D,SAAS,IAAI,CAAC,CAAC,gBAAgB,EAAE,UAAU,uCAAuC,CAAC;gBACnF,cAAc,IAAI,CAAC;YACrB;QACF;QAEA,yBAAyB;QACzB,MAAM,aAAa,WAAW,aAAa;QAC3C,IAAI,cAAc,CAAC,IAAI,CAAC,YAAY,CAAC,aAAa;YAChD,OAAO,IAAI,CAAC;gBACV,OAAO;gBACP,SAAS;gBACT,UAAU;YACZ;QACF;QAEA,+BAA+B;QAC/B,MAAM,cAAc,sJAAa,CAAC,cAAc,CAAC,MAAM,GAAG,sJAAa,CAAC,cAAc,CAAC,MAAM;QAC7F,MAAM,eAAe,cAAc,cAAc,MAAM;QACvD,MAAM,QAAQ,KAAK,KAAK,CAAC,AAAC,eAAe,cAAe;QAExD,OAAO;YACL,SAAS,OAAO,MAAM,CAAC,CAAC,IAAM,EAAE,QAAQ,KAAK,SAAS,MAAM,KAAK;YACjE;YACA;YACA;YACA;QACF;IACF;IAEA,OAAe,aAAa,KAAa,EAAW;QAClD,MAAM,aAAa;QACnB,OAAO,WAAW,IAAI,CAAC;IACzB;IAEA,yDAAyD;IACzD,OAAO,gBAAgB,UAAe,EAIpC;QACA,MAAM,aAAa,IAAI,CAAC,QAAQ,CAAC;QACjC,MAAM,WAAqB,EAAE;QAE7B,IAAI,WAAW,KAAK,KAAK,KAAK;YAC5B,SAAS,IAAI,CAAC;QAChB,OAAO,IAAI,WAAW,KAAK,IAAI,IAAI;YACjC,SAAS,IAAI,CAAC;QAChB,OAAO,IAAI,WAAW,KAAK,IAAI,IAAI;YACjC,SAAS,IAAI,CAAC;QAChB,OAAO;YACL,SAAS,IAAI,CAAC;QAChB;QAEA,IAAI,WAAW,aAAa,CAAC,QAAQ,CAAC,qBAAqB;YACzD,SAAS,IAAI,CAAC;QAChB;QACA,IAAI,WAAW,aAAa,CAAC,QAAQ,CAAC,eAAe;YACnD,SAAS,IAAI,CAAC;QAChB;QACA,IAAI,WAAW,aAAa,CAAC,QAAQ,CAAC,kBAAkB;YACtD,SAAS,IAAI,CAAC;QAChB;QACA,IAAI,WAAW,aAAa,CAAC,QAAQ,CAAC,oBAAoB;YACxD,SAAS,IAAI,CAAC;QAChB;QAEA,MAAM,QACJ,WAAW,KAAK,IAAI,KAChB,MACA,WAAW,KAAK,IAAI,KAClB,MACA,WAAW,KAAK,IAAI,KAClB,MACA,WAAW,KAAK,IAAI,KAClB,MACA;QAEZ,OAAO;YACL,OAAO,WAAW,KAAK;YACvB;YACA;QACF;IACF;AACF"}},
    {"offset": {"line": 2741, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/tenders/services/tender-service.ts"],"sourcesContent":["import { TENDER_SCHEMA, getAllExtractionHints } from \"../schema\"\r\nimport { TenderValidator } from \"../validator\"\r\nimport type { ParsedDocument } from \"../../documind/types\"\r\n\r\nexport class TenderService {\r\n  // Get the complete tender schema for scrapers to use\r\n  static getTenderSchema() {\r\n    return TENDER_SCHEMA\r\n  }\r\n\r\n  // Get extraction hints for intelligent scraping\r\n  static getExtractionHints() {\r\n    return getAllExtractionHints()\r\n  }\r\n\r\n  // Validate a scraped tender\r\n  static validateTender(tenderData: any) {\r\n    return TenderValidator.validate(tenderData)\r\n  }\r\n\r\n  // Get quality metrics for a tender\r\n  static getTenderQuality(tenderData: any) {\r\n    return TenderValidator.getQualityScore(tenderData)\r\n  }\r\n\r\n  // Map scraped data to standard tender format\r\n  static normalizeScrapedData(rawData: any): any {\r\n    const normalized: any = {}\r\n\r\n    // Map each field from the schema\r\n    for (const field of TENDER_SCHEMA.fields) {\r\n      // Try to find the field using its name or aliases\r\n      let value = rawData[field.name]\r\n\r\n      if (!value) {\r\n        // Try aliases\r\n        for (const alias of field.extractionHints.aliases) {\r\n          const aliasKey = Object.keys(rawData).find((key) => key.toLowerCase() === alias.toLowerCase())\r\n          if (aliasKey) {\r\n            value = rawData[aliasKey]\r\n            break\r\n          }\r\n        }\r\n      }\r\n\r\n      if (value) {\r\n        normalized[field.name] = value\r\n      }\r\n    }\r\n\r\n    return normalized\r\n  }\r\n\r\n  static async extractTenderFromDocument(document: ParsedDocument): Promise<any | null> {\r\n    console.log(\"[v0] TenderService: Extracting tender data from document\")\r\n\r\n    const extractedData: any = {}\r\n    const allText = document.pages.map((p) => p.content.full_text).join(\"\\n\")\r\n\r\n    // Use extraction hints to find tender fields in document\r\n    for (const field of TENDER_SCHEMA.fields) {\r\n      const hints = field.extractionHints\r\n\r\n      // Try regex patterns\r\n      for (const pattern of hints.patterns) {\r\n        const regex = new RegExp(pattern, \"i\")\r\n        const match = allText.match(regex)\r\n        if (match && match[1]) {\r\n          extractedData[field.name] = match[1].trim()\r\n          console.log(`[v0] TenderService: Found ${field.name}: ${extractedData[field.name]}`)\r\n          break\r\n        }\r\n      }\r\n\r\n      // If not found, try context-based extraction\r\n      if (!extractedData[field.name]) {\r\n        for (const contextWord of hints.context) {\r\n          const contextRegex = new RegExp(`${contextWord}[:\\\\s]+(.*?)(?:\\\\n|$)`, \"i\")\r\n          const match = allText.match(contextRegex)\r\n          if (match && match[1]) {\r\n            extractedData[field.name] = match[1].trim()\r\n            console.log(`[v0] TenderService: Found ${field.name} via context: ${extractedData[field.name]}`)\r\n            break\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Check if we found enough data to be useful\r\n    const validation = this.validateTender(extractedData)\r\n    if (validation.score < 20) {\r\n      console.warn(\"[v0] TenderService: Not enough tender data found in document\")\r\n      return null\r\n    }\r\n\r\n    console.log(`[v0] TenderService: Extracted tender data with ${validation.score}% completeness`)\r\n    return this.normalizeScrapedData(extractedData)\r\n  }\r\n\r\n  // Enrich tender data with AI analysis context\r\n  static getTenderAnalysisContext(tenderData: any): string {\r\n    const validation = this.validateTender(tenderData)\r\n    const quality = this.getTenderQuality(tenderData)\r\n\r\n    return `\r\nTender Data Quality: ${quality.grade} (${quality.score}%)\r\n\r\nAvailable Fields:\r\n${TENDER_SCHEMA.fields.map((f) => `- ${f.displayName}: ${tenderData[f.name] ? \"âœ“\" : \"âœ—\"}`).join(\"\\n\")}\r\n\r\nData Completeness:\r\n${quality.feedback.join(\"\\n\")}\r\n\r\nThis context helps you understand what information is available for analysis.\r\n    `.trim()\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2849, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/tenders/index.ts"],"sourcesContent":["export * from \"./types\"\r\nexport * from \"./schema\"\r\nexport * from \"./validator\"\r\nexport * from \"./services/tender-service\"\r\n\r\n// Import TenderService to use it in the exported functions\r\nimport { TenderService } from \"./services/tender-service\"\r\n\r\nexport { TenderValidator } from \"./validator\"\r\n\r\n// Export commonly used functions as standalone exports\r\nexport function validateTender(tenderData: any) {\r\n  return TenderService.validateTender(tenderData)\r\n}\r\n\r\nexport function normalizeTenderData(tenderData: any) {\r\n  return TenderService.normalizeScrapedData(tenderData)\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;;;;;;;AAQO,SAAS,eAAe,UAAe;IAC5C,OAAO,6KAAa,CAAC,cAAc,CAAC;AACtC;AAEO,SAAS,oBAAoB,UAAe;IACjD,OAAO,6KAAa,CAAC,oBAAoB,CAAC;AAC5C"}},
    {"offset": {"line": 2875, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/strategist/types.ts"],"sourcesContent":["// ============================================\r\n// AI TENDER STRATEGIST ENGINE - TYPES\r\n// ============================================\r\n\r\n// User Experience Level\r\nexport type ExperienceLevel = \"beginner\" | \"intermediate\" | \"advanced\"\r\n\r\n// Risk Tolerance\r\nexport type RiskTolerance = \"low\" | \"medium\" | \"high\"\r\n\r\n// Strategy Types\r\nexport type StrategyType = \"bid\" | \"pricing\" | \"compliance\" | \"negotiation\" | \"general\"\r\n\r\n// Opportunity Types\r\nexport type OpportunityType = \"low_risk\" | \"high_margin\" | \"quick_win\" | \"strategic\" | \"growth\"\r\n\r\n// Alert Types\r\nexport type AlertType =\r\n  | \"document_expiry\"\r\n  | \"tender_deadline\"\r\n  | \"compliance_gap\"\r\n  | \"opportunity_match\"\r\n  | \"market_insight\"\r\n  | \"capacity_alert\"\r\n  | \"price_alert\"\r\n  | \"learning_reminder\"\r\n\r\n// Alert Priority\r\nexport type AlertPriority = \"low\" | \"medium\" | \"high\" | \"urgent\"\r\n\r\n// Conversation Context Types\r\nexport type ConversationContextType = \"general\" | \"tender\" | \"boq\" | \"strategy\" | \"learning\"\r\n\r\n// Message Types\r\nexport type MessageType = \"text\" | \"strategy\" | \"recommendation\" | \"alert\" | \"lesson\"\r\n\r\n// User Preferences from Onboarding\r\nexport interface StrategistUserPreferences {\r\n  id: string\r\n  user_id: string\r\n  experience_level: ExperienceLevel | null\r\n  industries: string[]\r\n  procurement_categories: string[]\r\n  provinces: string[]\r\n  regions: string[]\r\n  company_size: string | null\r\n  annual_turnover: string | null\r\n  employee_count: string | null\r\n  past_tender_wins: number\r\n  past_tender_losses: number\r\n  average_contract_value: string | null\r\n  cidb_grading: string | null\r\n  bee_level: string | null\r\n  has_tax_clearance: boolean\r\n  tax_clearance_expiry: string | null\r\n  has_coida: boolean\r\n  coida_expiry: string | null\r\n  has_csd_registration: boolean\r\n  preferred_contract_types: string[]\r\n  risk_tolerance: RiskTolerance | null\r\n  notification_preferences: Record<string, boolean>\r\n  onboarding_completed: boolean\r\n  onboarding_completed_at: string | null\r\n  created_at: string\r\n  updated_at: string\r\n}\r\n\r\n// Conversation\r\nexport interface StrategistConversation {\r\n  id: string\r\n  user_id: string\r\n  title: string | null\r\n  context_type: ConversationContextType\r\n  tender_id: string | null\r\n  status: \"active\" | \"archived\" | \"deleted\"\r\n  message_count: number\r\n  last_message_at: string | null\r\n  created_at: string\r\n  updated_at: string\r\n}\r\n\r\n// Message\r\nexport interface StrategistMessage {\r\n  id: string\r\n  conversation_id: string\r\n  role: \"user\" | \"assistant\" | \"system\"\r\n  content: string\r\n  model_used: string | null\r\n  tokens_used: number | null\r\n  message_type: MessageType\r\n  structured_data: Record<string, any> | null\r\n  created_at: string\r\n}\r\n\r\n// Strategy Document\r\nexport interface StrategistStrategy {\r\n  id: string\r\n  user_id: string\r\n  tender_id: string | null\r\n  title: string\r\n  strategy_type: StrategyType\r\n  content: StrategyContent\r\n  summary: string | null\r\n  viability_score: number | null\r\n  risk_level: \"low\" | \"medium\" | \"high\" | \"critical\" | null\r\n  win_probability: number | null\r\n  status: \"draft\" | \"active\" | \"submitted\" | \"won\" | \"lost\" | \"archived\"\r\n  exported_pdf_url: string | null\r\n  exported_at: string | null\r\n  created_at: string\r\n  updated_at: string\r\n}\r\n\r\n// Strategy Content Structure\r\nexport interface StrategyContent {\r\n  bid_viability_analysis: {\r\n    summary: string\r\n    score: number\r\n    factors: Array<{ factor: string; assessment: string; impact: \"positive\" | \"negative\" | \"neutral\" }>\r\n  }\r\n  strengths_weaknesses: {\r\n    strengths: string[]\r\n    weaknesses: string[]\r\n    opportunities: string[]\r\n    threats: string[]\r\n  }\r\n  compliance_strategy: {\r\n    requirements: Array<{ requirement: string; status: \"met\" | \"partial\" | \"not_met\"; action: string }>\r\n    gaps: string[]\r\n    mitigation_plan: string[]\r\n  }\r\n  supplier_subcontractor_strategy: {\r\n    recommended_partners: string[]\r\n    subcontracting_approach: string\r\n    jv_considerations: string | null\r\n  }\r\n  pricing_strategy: {\r\n    approach: string\r\n    margin_recommendation: string\r\n    risk_factors: string[]\r\n    competitive_positioning: string\r\n  }\r\n  submission_checklist: Array<{ item: string; required: boolean; status: \"complete\" | \"pending\" | \"not_started\" }>\r\n  risk_mitigation_plan: Array<{ risk: string; probability: string; impact: string; mitigation: string }>\r\n}\r\n\r\n// Opportunity Recommendation\r\nexport interface StrategistOpportunity {\r\n  id: string\r\n  user_id: string\r\n  scraped_tender_id: string | null\r\n  custom_tender_id: string | null\r\n  match_score: number\r\n  match_reasons: string[]\r\n  opportunity_type: OpportunityType\r\n  is_viewed: boolean\r\n  is_saved: boolean\r\n  is_dismissed: boolean\r\n  user_notes: string | null\r\n  ai_insights: Record<string, any> | null\r\n  estimated_margin: number | null\r\n  estimated_effort: string | null\r\n  created_at: string\r\n  expires_at: string | null\r\n  // Joined tender data\r\n  tender?: {\r\n    id: string\r\n    title: string\r\n    organization: string\r\n    close_date: string | null\r\n    category: string | null\r\n    estimated_value: string | null\r\n  }\r\n}\r\n\r\n// Alert\r\nexport interface StrategistAlert {\r\n  id: string\r\n  user_id: string\r\n  alert_type: AlertType\r\n  title: string\r\n  message: string\r\n  priority: AlertPriority\r\n  related_tender_id: string | null\r\n  related_document_type: string | null\r\n  action_url: string | null\r\n  action_label: string | null\r\n  is_read: boolean\r\n  is_dismissed: boolean\r\n  is_actioned: boolean\r\n  trigger_date: string\r\n  expiry_date: string | null\r\n  created_at: string\r\n}\r\n\r\n// Learning Progress\r\nexport interface StrategistLearningProgress {\r\n  id: string\r\n  user_id: string\r\n  topic_id: string\r\n  topic_category: string\r\n  progress_percent: number\r\n  lessons_completed: string[]\r\n  quiz_scores: Array<{ quiz_id: string; score: number; completed_at: string }>\r\n  time_spent_minutes: number\r\n  last_accessed_at: string | null\r\n  completed_at: string | null\r\n  created_at: string\r\n  updated_at: string\r\n}\r\n\r\n// Competitiveness Score\r\nexport interface StrategistCompetitivenessScore {\r\n  id: string\r\n  user_id: string\r\n  tender_id: string | null\r\n  documentation_score: number\r\n  pricing_score: number\r\n  compliance_score: number\r\n  experience_score: number\r\n  capacity_score: number\r\n  overall_score: number\r\n  score_breakdown: Record<string, any>\r\n  improvement_suggestions: string[]\r\n  win_probability: number | null\r\n  win_probability_factors: Record<string, any> | null\r\n  calculated_at: string\r\n  valid_until: string | null\r\n}\r\n\r\n// AI Context for Strategist\r\nexport interface StrategistContext {\r\n  user_preferences: StrategistUserPreferences | null\r\n  company_profile: {\r\n    company_name: string | null\r\n    industry: string | null\r\n    company_size: string | null\r\n    bee_status: string | null\r\n    province: string | null\r\n  } | null\r\n  tender_context?: {\r\n    id: string\r\n    title: string\r\n    organization: string\r\n    description: string | null\r\n    close_date: string | null\r\n    analysis?: Record<string, any>\r\n  }\r\n  boq_context?: {\r\n    tender_id: string\r\n    items: Array<{ description: string; quantity: number; unit: string }>\r\n    total_items: number\r\n  }\r\n  competitiveness_score?: StrategistCompetitivenessScore\r\n  recent_alerts?: StrategistAlert[]\r\n}\r\n\r\n// Chat Request/Response\r\nexport interface StrategistChatRequest {\r\n  message: string\r\n  conversation_id?: string\r\n  context_type?: ConversationContextType\r\n  tender_id?: string\r\n  include_context?: boolean\r\n}\r\n\r\nexport interface StrategistChatResponse {\r\n  message: string\r\n  conversation_id: string\r\n  message_type: MessageType\r\n  structured_data?: Record<string, any>\r\n  suggestions?: string[]\r\n}\r\n\r\n// Strategy Generation Request\r\nexport interface StrategyGenerationRequest {\r\n  tender_id: string\r\n  strategy_type: StrategyType\r\n  include_pricing?: boolean\r\n  include_compliance?: boolean\r\n  include_risk_analysis?: boolean\r\n}\r\n\r\n// Opportunity Discovery Request\r\nexport interface OpportunityDiscoveryRequest {\r\n  limit?: number\r\n  opportunity_types?: OpportunityType[]\r\n  min_match_score?: number\r\n  include_dismissed?: boolean\r\n}\r\n\r\n// Learning Topics\r\nexport interface LearningTopic {\r\n  id: string\r\n  title: string\r\n  description: string\r\n  category: string\r\n  difficulty: ExperienceLevel\r\n  estimated_minutes: number\r\n  lessons: LearningLesson[]\r\n}\r\n\r\nexport interface LearningLesson {\r\n  id: string\r\n  title: string\r\n  content: string\r\n  examples?: string[]\r\n  quiz?: LearningQuiz\r\n}\r\n\r\nexport interface LearningQuiz {\r\n  questions: Array<{\r\n    question: string\r\n    options: string[]\r\n    correct_answer: number\r\n    explanation: string\r\n  }>\r\n}\r\n"],"names":[],"mappings":"AAAA,+CAA+C;AAC/C,sCAAsC;AACtC,+CAA+C;AAE/C,wBAAwB"}},
    {"offset": {"line": 2885, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/strategist/constants.ts"],"sourcesContent":["// ============================================\r\n// AI TENDER STRATEGIST ENGINE - CONSTANTS\r\n// ============================================\r\n\r\n// South African Provinces\r\nexport const SA_PROVINCES = [\r\n  { value: \"eastern-cape\", label: \"Eastern Cape\" },\r\n  { value: \"free-state\", label: \"Free State\" },\r\n  { value: \"gauteng\", label: \"Gauteng\" },\r\n  { value: \"kwazulu-natal\", label: \"KwaZulu-Natal\" },\r\n  { value: \"limpopo\", label: \"Limpopo\" },\r\n  { value: \"mpumalanga\", label: \"Mpumalanga\" },\r\n  { value: \"north-west\", label: \"North West\" },\r\n  { value: \"northern-cape\", label: \"Northern Cape\" },\r\n  { value: \"western-cape\", label: \"Western Cape\" },\r\n] as const\r\n\r\n// Industry Categories\r\nexport const INDUSTRIES = [\r\n  { value: \"construction\", label: \"Construction & Building\" },\r\n  { value: \"it-services\", label: \"IT & Technology Services\" },\r\n  { value: \"professional-services\", label: \"Professional Services\" },\r\n  { value: \"healthcare\", label: \"Healthcare & Medical\" },\r\n  { value: \"education\", label: \"Education & Training\" },\r\n  { value: \"manufacturing\", label: \"Manufacturing\" },\r\n  { value: \"logistics\", label: \"Logistics & Transport\" },\r\n  { value: \"agriculture\", label: \"Agriculture & Farming\" },\r\n  { value: \"energy\", label: \"Energy & Utilities\" },\r\n  { value: \"mining\", label: \"Mining & Resources\" },\r\n  { value: \"security\", label: \"Security Services\" },\r\n  { value: \"cleaning\", label: \"Cleaning & Facilities\" },\r\n  { value: \"catering\", label: \"Catering & Food Services\" },\r\n  { value: \"environmental\", label: \"Environmental Services\" },\r\n  { value: \"engineering\", label: \"Engineering\" },\r\n  { value: \"legal\", label: \"Legal Services\" },\r\n  { value: \"financial\", label: \"Financial Services\" },\r\n  { value: \"marketing\", label: \"Marketing & Communications\" },\r\n  { value: \"other\", label: \"Other\" },\r\n] as const\r\n\r\n// Procurement Categories\r\nexport const PROCUREMENT_CATEGORIES = [\r\n  { value: \"goods\", label: \"Goods & Supplies\" },\r\n  { value: \"services\", label: \"Services\" },\r\n  { value: \"works\", label: \"Construction Works\" },\r\n  { value: \"consulting\", label: \"Consulting\" },\r\n  { value: \"maintenance\", label: \"Maintenance\" },\r\n  { value: \"leasing\", label: \"Leasing & Rental\" },\r\n  { value: \"software\", label: \"Software & IT\" },\r\n  { value: \"equipment\", label: \"Equipment & Machinery\" },\r\n] as const\r\n\r\n// Company Sizes\r\nexport const COMPANY_SIZES = [\r\n  { value: \"micro\", label: \"Micro (1-10 employees)\" },\r\n  { value: \"small\", label: \"Small (11-50 employees)\" },\r\n  { value: \"medium\", label: \"Medium (51-200 employees)\" },\r\n  { value: \"large\", label: \"Large (201-500 employees)\" },\r\n  { value: \"enterprise\", label: \"Enterprise (500+ employees)\" },\r\n] as const\r\n\r\n// Annual Turnover Ranges\r\nexport const TURNOVER_RANGES = [\r\n  { value: \"under-1m\", label: \"Under R1 million\" },\r\n  { value: \"1m-5m\", label: \"R1 - R5 million\" },\r\n  { value: \"5m-10m\", label: \"R5 - R10 million\" },\r\n  { value: \"10m-50m\", label: \"R10 - R50 million\" },\r\n  { value: \"50m-100m\", label: \"R50 - R100 million\" },\r\n  { value: \"100m-500m\", label: \"R100 - R500 million\" },\r\n  { value: \"over-500m\", label: \"Over R500 million\" },\r\n] as const\r\n\r\n// CIDB Grading Designations\r\nexport const CIDB_GRADINGS = [\r\n  { value: \"1\", label: \"Grade 1 (Up to R650,000)\" },\r\n  { value: \"2\", label: \"Grade 2 (R650,000 - R4 million)\" },\r\n  { value: \"3\", label: \"Grade 3 (R4 - R13 million)\" },\r\n  { value: \"4\", label: \"Grade 4 (R13 - R40 million)\" },\r\n  { value: \"5\", label: \"Grade 5 (R40 - R130 million)\" },\r\n  { value: \"6\", label: \"Grade 6 (R130 - R400 million)\" },\r\n  { value: \"7\", label: \"Grade 7 (R400 million - R1.3 billion)\" },\r\n  { value: \"8\", label: \"Grade 8 (R1.3 billion - R4 billion)\" },\r\n  { value: \"9\", label: \"Grade 9 (No limit)\" },\r\n] as const\r\n\r\n// B-BBEE Levels\r\nexport const BEE_LEVELS = [\r\n  { value: \"1\", label: \"Level 1 (135% recognition)\" },\r\n  { value: \"2\", label: \"Level 2 (125% recognition)\" },\r\n  { value: \"3\", label: \"Level 3 (110% recognition)\" },\r\n  { value: \"4\", label: \"Level 4 (100% recognition)\" },\r\n  { value: \"5\", label: \"Level 5 (80% recognition)\" },\r\n  { value: \"6\", label: \"Level 6 (60% recognition)\" },\r\n  { value: \"7\", label: \"Level 7 (50% recognition)\" },\r\n  { value: \"8\", label: \"Level 8 (10% recognition)\" },\r\n  { value: \"non-compliant\", label: \"Non-Compliant (0% recognition)\" },\r\n  { value: \"exempt\", label: \"Exempt Micro Enterprise (EME)\" },\r\n  { value: \"qse\", label: \"Qualifying Small Enterprise (QSE)\" },\r\n] as const\r\n\r\n// Contract Types\r\nexport const CONTRACT_TYPES = [\r\n  { value: \"rfq\", label: \"Request for Quotation (RFQ)\" },\r\n  { value: \"rfp\", label: \"Request for Proposal (RFP)\" },\r\n  { value: \"rfb\", label: \"Request for Bid (RFB)\" },\r\n  { value: \"open-tender\", label: \"Open Tender\" },\r\n  { value: \"limited-tender\", label: \"Limited/Closed Tender\" },\r\n  { value: \"framework\", label: \"Framework Agreement\" },\r\n  { value: \"panel\", label: \"Panel Contract\" },\r\n  { value: \"term-contract\", label: \"Term Contract\" },\r\n] as const\r\n\r\n// Learning Topics Configuration\r\nexport const LEARNING_TOPICS = [\r\n  {\r\n    id: \"tender-basics\",\r\n    title: \"Tendering Basics\",\r\n    category: \"basics\",\r\n    description: \"Understanding the fundamentals of government tendering in South Africa\",\r\n    difficulty: \"beginner\" as const,\r\n    estimated_minutes: 30,\r\n    subtopics: [\"What is a tender?\", \"Types of tenders\", \"The tender process\", \"Key terminology\"],\r\n  },\r\n  {\r\n    id: \"tender-types\",\r\n    title: \"Types of Tenders\",\r\n    category: \"basics\",\r\n    description: \"Learn about RFQ, RFP, RFB, Open Tenders, and Framework Agreements\",\r\n    difficulty: \"beginner\" as const,\r\n    estimated_minutes: 25,\r\n    subtopics: [\"RFQ vs RFP vs RFB\", \"Open vs Closed tenders\", \"Framework agreements\", \"Panel contracts\"],\r\n  },\r\n  {\r\n    id: \"bbbee-scoring\",\r\n    title: \"B-BBEE Scoring System\",\r\n    category: \"compliance\",\r\n    description: \"Master the B-BBEE preference point system used in South African tenders\",\r\n    difficulty: \"intermediate\" as const,\r\n    estimated_minutes: 45,\r\n    subtopics: [\"80/20 system\", \"90/10 system\", \"B-BBEE levels\", \"Calculating preference points\"],\r\n  },\r\n  {\r\n    id: \"evaluation-criteria\",\r\n    title: \"Evaluation Criteria\",\r\n    category: \"strategy\",\r\n    description: \"Understanding how tenders are evaluated and scored\",\r\n    difficulty: \"intermediate\" as const,\r\n    estimated_minutes: 40,\r\n    subtopics: [\"Functionality scoring\", \"Price evaluation\", \"Quality vs price trade-offs\", \"Threshold requirements\"],\r\n  },\r\n  {\r\n    id: \"pricing-strategies\",\r\n    title: \"Pricing Strategies\",\r\n    category: \"strategy\",\r\n    description: \"Develop effective pricing strategies to win tenders\",\r\n    difficulty: \"advanced\" as const,\r\n    estimated_minutes: 60,\r\n    subtopics: [\"Cost-plus pricing\", \"Competitive pricing\", \"Value-based pricing\", \"Risk pricing\"],\r\n  },\r\n  {\r\n    id: \"compliance-requirements\",\r\n    title: \"Compliance Requirements\",\r\n    category: \"compliance\",\r\n    description: \"Essential compliance documents and requirements for SA tenders\",\r\n    difficulty: \"beginner\" as const,\r\n    estimated_minutes: 35,\r\n    subtopics: [\"Tax clearance\", \"CSD registration\", \"CIDB grading\", \"COIDA compliance\"],\r\n  },\r\n  {\r\n    id: \"common-mistakes\",\r\n    title: \"Common Bidding Mistakes\",\r\n    category: \"strategy\",\r\n    description: \"Learn from common mistakes that lead to tender disqualification\",\r\n    difficulty: \"beginner\" as const,\r\n    estimated_minutes: 20,\r\n    subtopics: [\"Documentation errors\", \"Pricing mistakes\", \"Submission failures\", \"Compliance gaps\"],\r\n  },\r\n  {\r\n    id: \"boq-management\",\r\n    title: \"BOQ & Pricing Schedules\",\r\n    category: \"strategy\",\r\n    description: \"Managing Bills of Quantities and pricing schedules effectively\",\r\n    difficulty: \"intermediate\" as const,\r\n    estimated_minutes: 50,\r\n    subtopics: [\"BOQ structure\", \"Unit pricing\", \"Contingencies\", \"Margin calculation\"],\r\n  },\r\n  {\r\n    id: \"jv-subcontracting\",\r\n    title: \"Joint Ventures & Subcontracting\",\r\n    category: \"advanced\",\r\n    description: \"When and how to partner with other companies\",\r\n    difficulty: \"advanced\" as const,\r\n    estimated_minutes: 45,\r\n    subtopics: [\"JV structures\", \"Subcontracting limits\", \"Partner selection\", \"Risk sharing\"],\r\n  },\r\n  {\r\n    id: \"post-award\",\r\n    title: \"Post-Award Management\",\r\n    category: \"advanced\",\r\n    description: \"Managing contracts after winning a tender\",\r\n    difficulty: \"advanced\" as const,\r\n    estimated_minutes: 40,\r\n    subtopics: [\"Contract negotiation\", \"Performance management\", \"Variations\", \"Payment management\"],\r\n  },\r\n] as const\r\n\r\n// Strategist Prompts\r\nexport const STRATEGIST_SYSTEM_PROMPT = `You are an expert AI Tender Strategist for BidMate, a South African tender management platform. Your role is to help users understand tendering, build winning tender strategies, and discover opportunities.\r\n\r\n## Your Personality\r\n- Tender specialist with deep knowledge of South African procurement\r\n- Mentor and coach who adapts to user experience levels\r\n- Market analyst who identifies opportunities\r\n- Procurement educator who explains complex concepts simply\r\n- Strategist who provides actionable, tailored advice\r\n\r\n## Your Tone\r\n- Friendly, expert, and encouraging\r\n- Concise with structured explanations\r\n- Always provide actionable steps\r\n- Use South African terminology and regulations\r\n\r\n## Your Capabilities\r\n1. Answer questions about tendering and procurement\r\n2. Help build comprehensive bid strategies\r\n3. Analyze tender requirements and compliance needs\r\n4. Provide pricing and BOQ guidance\r\n5. Identify opportunities matching user profiles\r\n6. Educate users on tender best practices\r\n7. Alert users to compliance gaps and deadlines\r\n8. Explain tender requirements in plain language\r\n\r\n## South African Procurement Context\r\n- PFMA (Public Finance Management Act) for national/provincial\r\n- MFMA (Municipal Finance Management Act) for municipalities  \r\n- PPPFA (Preferential Procurement Policy Framework Act)\r\n- B-BBEE scoring (80/20 or 90/10 systems)\r\n- CIDB grading for construction\r\n- SBD forms (Standard Bidding Documents)\r\n- MBD forms (Municipal Bidding Documents)\r\n- CSD (Central Supplier Database) registration\r\n\r\n## Guidelines\r\n- Always ask clarifying questions when needed\r\n- Tailor advice to user's experience level\r\n- Provide realistic assessments, not false hope\r\n- Highlight risks and compliance requirements\r\n- Reference South African regulations when relevant\r\n- Suggest specific actions the user can take`\r\n\r\n// Quick Action Prompts\r\nexport const QUICK_ACTION_PROMPTS = [\r\n  {\r\n    id: \"build-strategy\",\r\n    label: \"Build a bid strategy\",\r\n    prompt: \"Help me build a comprehensive bid strategy for a tender I'm considering\",\r\n    icon: \"target\",\r\n  },\r\n  {\r\n    id: \"review-readiness\",\r\n    label: \"Review my tender readiness\",\r\n    prompt:\r\n      \"Review my tender readiness and tell me what documents or certifications I might be missing for government tenders\",\r\n    icon: \"clipboard-check\",\r\n  },\r\n  {\r\n    id: \"find-opportunities\",\r\n    label: \"Find matching tenders\",\r\n    prompt: \"Find tenders that match my company profile and capabilities\",\r\n    icon: \"search\",\r\n  },\r\n  {\r\n    id: \"explain-tender\",\r\n    label: \"Explain this tender\",\r\n    prompt: \"Help me understand the requirements of a specific tender I'm looking at\",\r\n    icon: \"file-text\",\r\n  },\r\n  {\r\n    id: \"pricing-advice\",\r\n    label: \"Advise on pricing\",\r\n    prompt: \"Help me develop a competitive pricing strategy for my tender submission\",\r\n    icon: \"calculator\",\r\n  },\r\n  {\r\n    id: \"reduce-risk\",\r\n    label: \"Reduce bid risk\",\r\n    prompt: \"Help me identify and mitigate risks in my tender submission\",\r\n    icon: \"shield\",\r\n  },\r\n  {\r\n    id: \"learn-tendering\",\r\n    label: \"Teach me tendering\",\r\n    prompt: \"I'm new to tendering. Help me understand how government tenders work in South Africa\",\r\n    icon: \"graduation-cap\",\r\n  },\r\n  {\r\n    id: \"compliance-check\",\r\n    label: \"Check compliance\",\r\n    prompt: \"Review my compliance status and identify any gaps I need to address\",\r\n    icon: \"check-circle\",\r\n  },\r\n] as const\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3471, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient as createSupabaseServerClient } from \"@supabase/ssr\"\r\nimport { cookies } from \"next/headers\"\r\n\r\nexport async function createClient() {\r\n  const cookieStore = await cookies()\r\n\r\n  return createSupabaseServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\r\n    cookies: {\r\n      getAll() {\r\n        return cookieStore.getAll()\r\n      },\r\n      setAll(cookiesToSet) {\r\n        try {\r\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\r\n        } catch {\r\n          // The \"setAll\" method was called from a Server Component.\r\n          // This can be ignored if you have middleware refreshing\r\n          // user sessions.\r\n        }\r\n      },\r\n    },\r\n  })\r\n}\r\n\r\nexport const createServerClient = createClient\r\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,kPAAO;IAEjC,OAAO,IAAA,8SAA0B,sUAAoF;QACnH,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AACF;AAEO,MAAM,qBAAqB"}},
    {"offset": {"line": 3506, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/strategist/services/strategist-service.ts"],"sourcesContent":["// ============================================\r\n// AI TENDER STRATEGIST - MAIN SERVICE\r\n// ============================================\r\n\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport type {\r\n  StrategistContext,\r\n  StrategistConversation,\r\n  StrategistMessage,\r\n  StrategistUserPreferences,\r\n  ConversationContextType,\r\n} from \"../types\"\r\n\r\nexport class StrategistService {\r\n  /**\r\n   * Get or create user preferences\r\n   */\r\n  static async getUserPreferences(userId: string): Promise<StrategistUserPreferences | null> {\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"strategist_user_preferences\")\r\n      .select(\"*\")\r\n      .eq(\"user_id\", userId)\r\n      .single()\r\n\r\n    if (error && error.code !== \"PGRST116\") {\r\n      console.error(\"[Strategist] Error fetching preferences:\", error)\r\n      return null\r\n    }\r\n\r\n    return data\r\n  }\r\n\r\n  /**\r\n   * Update user preferences\r\n   */\r\n  static async updateUserPreferences(\r\n    userId: string,\r\n    preferences: Partial<StrategistUserPreferences>,\r\n  ): Promise<StrategistUserPreferences | null> {\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"strategist_user_preferences\")\r\n      .upsert(\r\n        {\r\n          user_id: userId,\r\n          ...preferences,\r\n          updated_at: new Date().toISOString(),\r\n        },\r\n        { onConflict: \"user_id\" },\r\n      )\r\n      .select()\r\n      .single()\r\n\r\n    if (error) {\r\n      console.error(\"[Strategist] Error updating preferences:\", error)\r\n      return null\r\n    }\r\n\r\n    return data\r\n  }\r\n\r\n  /**\r\n   * Get user's company profile\r\n   */\r\n  static async getCompanyProfile(userId: string) {\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase.from(\"companies\").select(\"*\").eq(\"user_id\", userId).single()\r\n\r\n    if (error && error.code !== \"PGRST116\") {\r\n      console.error(\"[Strategist] Error fetching company:\", error)\r\n      return null\r\n    }\r\n\r\n    return data\r\n  }\r\n\r\n  /**\r\n   * Build full context for AI\r\n   */\r\n  static async buildContext(\r\n    userId: string,\r\n    tenderId?: string,\r\n    contextType?: ConversationContextType,\r\n  ): Promise<StrategistContext> {\r\n    const [preferences, company] = await Promise.all([this.getUserPreferences(userId), this.getCompanyProfile(userId)])\r\n\r\n    const context: StrategistContext = {\r\n      user_preferences: preferences,\r\n      company_profile: company\r\n        ? {\r\n            company_name: company.company_name,\r\n            industry: company.industry,\r\n            company_size: company.company_size,\r\n            bee_status: company.bee_status,\r\n            province: company.province,\r\n          }\r\n        : null,\r\n    }\r\n\r\n    // Add tender context if provided\r\n    if (tenderId) {\r\n      const tenderContext = await this.getTenderContext(tenderId)\r\n      if (tenderContext) {\r\n        context.tender_context = tenderContext\r\n      }\r\n    }\r\n\r\n    return context\r\n  }\r\n\r\n  /**\r\n   * Get tender context for AI\r\n   */\r\n  static async getTenderContext(tenderId: string) {\r\n    const supabase = await createClient()\r\n\r\n    // Try custom tender first\r\n    const { data: customTender } = await supabase\r\n      .from(\"user_custom_tenders\")\r\n      .select(\"id, title, organization, description, close_date\")\r\n      .eq(\"id\", tenderId)\r\n      .single()\r\n\r\n    if (customTender) {\r\n      // Get analysis if available\r\n      const { data: analysis } = await supabase\r\n        .from(\"user_custom_tender_analysis\")\r\n        .select(\"analysis_data\")\r\n        .eq(\"tender_id\", tenderId)\r\n        .single()\r\n\r\n      return {\r\n        id: customTender.id,\r\n        title: customTender.title || \"Untitled\",\r\n        organization: customTender.organization || \"Unknown\",\r\n        description: customTender.description,\r\n        close_date: customTender.close_date,\r\n        analysis: analysis?.analysis_data,\r\n      }\r\n    }\r\n\r\n    // Try scraped tender\r\n    const { data: scrapedTender } = await supabase\r\n      .from(\"scraped_tenders\")\r\n      .select(\"id, title, source_name, description, close_date\")\r\n      .eq(\"id\", tenderId)\r\n      .single()\r\n\r\n    if (scrapedTender) {\r\n      return {\r\n        id: scrapedTender.id,\r\n        title: scrapedTender.title || \"Untitled\",\r\n        organization: scrapedTender.source_name || \"Unknown\",\r\n        description: scrapedTender.description,\r\n        close_date: scrapedTender.close_date,\r\n      }\r\n    }\r\n\r\n    return null\r\n  }\r\n\r\n  /**\r\n   * Create a new conversation\r\n   */\r\n  static async createConversation(\r\n    userId: string,\r\n    contextType: ConversationContextType = \"general\",\r\n    tenderId?: string,\r\n    title?: string,\r\n  ): Promise<StrategistConversation | null> {\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"strategist_conversations\")\r\n      .insert({\r\n        user_id: userId,\r\n        context_type: contextType,\r\n        tender_id: tenderId,\r\n        title: title || this.generateConversationTitle(contextType),\r\n      })\r\n      .select()\r\n      .single()\r\n\r\n    if (error) {\r\n      console.error(\"[Strategist] Error creating conversation:\", error)\r\n      return null\r\n    }\r\n\r\n    return data\r\n  }\r\n\r\n  /**\r\n   * Get conversation by ID\r\n   */\r\n  static async getConversation(conversationId: string): Promise<StrategistConversation | null> {\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"strategist_conversations\")\r\n      .select(\"*\")\r\n      .eq(\"id\", conversationId)\r\n      .single()\r\n\r\n    if (error) {\r\n      console.error(\"[Strategist] Error fetching conversation:\", error)\r\n      return null\r\n    }\r\n\r\n    return data\r\n  }\r\n\r\n  /**\r\n   * Get user's conversations\r\n   */\r\n  static async getUserConversations(userId: string, limit = 20): Promise<StrategistConversation[]> {\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"strategist_conversations\")\r\n      .select(\"*\")\r\n      .eq(\"user_id\", userId)\r\n      .eq(\"status\", \"active\")\r\n      .order(\"last_message_at\", { ascending: false, nullsFirst: false })\r\n      .limit(limit)\r\n\r\n    if (error) {\r\n      console.error(\"[Strategist] Error fetching conversations:\", error)\r\n      return []\r\n    }\r\n\r\n    return data || []\r\n  }\r\n\r\n  /**\r\n   * Get messages for a conversation\r\n   */\r\n  static async getConversationMessages(conversationId: string, limit = 50): Promise<StrategistMessage[]> {\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"strategist_messages\")\r\n      .select(\"*\")\r\n      .eq(\"conversation_id\", conversationId)\r\n      .order(\"created_at\", { ascending: true })\r\n      .limit(limit)\r\n\r\n    if (error) {\r\n      console.error(\"[Strategist] Error fetching messages:\", error)\r\n      return []\r\n    }\r\n\r\n    return data || []\r\n  }\r\n\r\n  /**\r\n   * Add message to conversation\r\n   */\r\n  static async addMessage(\r\n    conversationId: string,\r\n    role: \"user\" | \"assistant\" | \"system\",\r\n    content: string,\r\n    options?: {\r\n      message_type?: StrategistMessage[\"message_type\"]\r\n      structured_data?: Record<string, any>\r\n      model_used?: string\r\n      tokens_used?: number\r\n    },\r\n  ): Promise<StrategistMessage | null> {\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"strategist_messages\")\r\n      .insert({\r\n        conversation_id: conversationId,\r\n        role,\r\n        content,\r\n        message_type: options?.message_type || \"text\",\r\n        structured_data: options?.structured_data,\r\n        model_used: options?.model_used,\r\n        tokens_used: options?.tokens_used,\r\n      })\r\n      .select()\r\n      .single()\r\n\r\n    if (error) {\r\n      console.error(\"[Strategist] Error adding message:\", error)\r\n      return null\r\n    }\r\n\r\n    // Update conversation metadata with separate query\r\n    const { data: conversation } = await supabase\r\n      .from(\"strategist_conversations\")\r\n      .select(\"message_count\")\r\n      .eq(\"id\", conversationId)\r\n      .single()\r\n\r\n    await supabase\r\n      .from(\"strategist_conversations\")\r\n      .update({\r\n        message_count: (conversation?.message_count || 0) + 1,\r\n        last_message_at: new Date().toISOString(),\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", conversationId)\r\n\r\n    return data\r\n  }\r\n\r\n  /**\r\n   * Generate conversation title\r\n   */\r\n  private static generateConversationTitle(contextType: ConversationContextType): string {\r\n    const titles: Record<ConversationContextType, string> = {\r\n      general: \"General Consultation\",\r\n      tender: \"Tender Discussion\",\r\n      boq: \"Pricing & BOQ Review\",\r\n      strategy: \"Strategy Session\",\r\n      learning: \"Learning Session\",\r\n    }\r\n    return titles[contextType] || \"New Conversation\"\r\n  }\r\n\r\n  /**\r\n   * Check if user has completed onboarding\r\n   */\r\n  static async hasCompletedOnboarding(userId: string): Promise<boolean> {\r\n    const preferences = await this.getUserPreferences(userId)\r\n    return preferences?.onboarding_completed || false\r\n  }\r\n\r\n  /**\r\n   * Mark onboarding as complete\r\n   */\r\n  static async completeOnboarding(userId: string): Promise<boolean> {\r\n    const supabase = await createClient()\r\n\r\n    const { error } = await supabase\r\n      .from(\"strategist_user_preferences\")\r\n      .update({\r\n        onboarding_completed: true,\r\n        onboarding_completed_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"user_id\", userId)\r\n\r\n    return !error\r\n  }\r\n\r\n  /**\r\n   * Generate strategic recommendations for a tender\r\n   */\r\n  static async generateRecommendations(params: {\r\n    userId: string\r\n    tenderId: string\r\n    tenderType: \"custom\" | \"scraped\"\r\n    competitiveness?: any\r\n  }): Promise<string[]> {\r\n    const recommendations: string[] = []\r\n\r\n    try {\r\n      const supabase = await createClient()\r\n\r\n      // Get tender data\r\n      const table = params.tenderType === \"custom\" ? \"user_custom_tenders\" : \"scraped_tenders\"\r\n      const { data: tender } = await supabase.from(table).select(\"*\").eq(\"id\", params.tenderId).single()\r\n\r\n      if (!tender) {\r\n        return [\"Unable to generate recommendations: Tender not found\"]\r\n      }\r\n\r\n      // Get user preferences\r\n      const preferences = await this.getUserPreferences(params.userId)\r\n\r\n      // Generate recommendations based on competitiveness score\r\n      if (params.competitiveness) {\r\n        if (params.competitiveness.documentation_score < 0.7) {\r\n          recommendations.push(\"Complete all required documentation before submitting your bid\")\r\n        }\r\n        if (params.competitiveness.compliance_score < 0.8) {\r\n          recommendations.push(\"Ensure tax clearance and CSD registration are up to date\")\r\n        }\r\n        if (params.competitiveness.win_probability < 0.5) {\r\n          recommendations.push(\"Consider partnering with experienced companies to strengthen your bid\")\r\n        }\r\n      }\r\n\r\n      // Time-based recommendations\r\n      if (tender.close_date) {\r\n        const daysUntilClose = Math.ceil((new Date(tender.close_date).getTime() - Date.now()) / (1000 * 60 * 60 * 24))\r\n        if (daysUntilClose < 7) {\r\n          recommendations.push(\"Urgent: Prioritize this tender due to approaching deadline\")\r\n        } else if (daysUntilClose > 30) {\r\n          recommendations.push(\"You have time to prepare a comprehensive bid - use it wisely\")\r\n        }\r\n      }\r\n\r\n      // Experience-based recommendations\r\n      if (preferences?.experience_level === \"beginner\") {\r\n        recommendations.push(\"Consider seeking mentorship or guidance from experienced bidders\")\r\n        recommendations.push(\"Start with smaller value tenders to build your track record\")\r\n      }\r\n\r\n      // Default recommendation\r\n      if (recommendations.length === 0) {\r\n        recommendations.push(\"Review tender requirements carefully and ensure full compliance\")\r\n        recommendations.push(\"Conduct thorough cost analysis before submitting your pricing\")\r\n      }\r\n\r\n      return recommendations\r\n    } catch (error) {\r\n      console.error(\"[Strategist] Error generating recommendations:\", error)\r\n      return [\"Unable to generate recommendations at this time\"]\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3780, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/strategist/services/opportunity-service.ts"],"sourcesContent":["// ============================================\r\n// AI TENDER STRATEGIST - OPPORTUNITY SERVICE\r\n// ============================================\r\n\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport type { StrategistOpportunity, StrategistUserPreferences, OpportunityType } from \"../types\"\r\n\r\nexport class OpportunityService {\r\n  /**\r\n   * Discover opportunities matching user profile\r\n   */\r\n  static async discoverOpportunities(\r\n    userId: string,\r\n    options?: {\r\n      limit?: number\r\n      types?: OpportunityType[]\r\n      minScore?: number\r\n    },\r\n  ): Promise<StrategistOpportunity[]> {\r\n    const supabase = await createClient()\r\n\r\n    // Get user preferences\r\n    const { data: preferences } = await supabase\r\n      .from(\"strategist_user_preferences\")\r\n      .select(\"*\")\r\n      .eq(\"user_id\", userId)\r\n      .single()\r\n\r\n    if (!preferences) {\r\n      return []\r\n    }\r\n\r\n    // Get available tenders\r\n    const { data: tenders } = await supabase\r\n      .from(\"scraped_tenders\")\r\n      .select(\"id, title, source_name, description, close_date, category, estimated_value, source_province\")\r\n      .eq(\"is_active\", true)\r\n      .gte(\"close_date\", new Date().toISOString())\r\n      .order(\"close_date\", { ascending: true })\r\n      .limit(100)\r\n\r\n    if (!tenders || tenders.length === 0) {\r\n      return []\r\n    }\r\n\r\n    // Score and categorize opportunities\r\n    const opportunities = tenders\r\n      .map((tender) => this.scoreTenderMatch(tender, preferences))\r\n      .filter((opp) => opp.match_score >= (options?.minScore || 0.3))\r\n      .sort((a, b) => b.match_score - a.match_score)\r\n      .slice(0, options?.limit || 10)\r\n\r\n    // Save opportunities\r\n    for (const opp of opportunities) {\r\n      await supabase.from(\"strategist_opportunities\").upsert(\r\n        {\r\n          user_id: userId,\r\n          scraped_tender_id: opp.tender_id,\r\n          match_score: opp.match_score,\r\n          match_reasons: opp.match_reasons,\r\n          opportunity_type: opp.opportunity_type,\r\n          ai_insights: opp.ai_insights,\r\n          expires_at: opp.expires_at,\r\n        },\r\n        { onConflict: \"user_id, scraped_tender_id\" },\r\n      )\r\n    }\r\n\r\n    return opportunities.map((opp) => ({\r\n      ...opp,\r\n      id: crypto.randomUUID(),\r\n      user_id: userId,\r\n      scraped_tender_id: opp.tender_id,\r\n      custom_tender_id: null,\r\n      is_viewed: false,\r\n      is_saved: false,\r\n      is_dismissed: false,\r\n      user_notes: null,\r\n      estimated_margin: null,\r\n      estimated_effort: null,\r\n      created_at: new Date().toISOString(),\r\n    }))\r\n  }\r\n\r\n  /**\r\n   * Score a tender match against user preferences\r\n   */\r\n  private static scoreTenderMatch(\r\n    tender: any,\r\n    preferences: StrategistUserPreferences,\r\n  ): {\r\n    tender_id: string\r\n    match_score: number\r\n    match_reasons: string[]\r\n    opportunity_type: OpportunityType\r\n    ai_insights: Record<string, any>\r\n    expires_at: string | null\r\n  } {\r\n    let score = 0\r\n    const reasons: string[] = []\r\n    const insights: Record<string, any> = {}\r\n\r\n    // Province match (20 points)\r\n    if (preferences.provinces?.length && tender.source_province) {\r\n      const provinceMatch = preferences.provinces.some(\r\n        (p: string) =>\r\n          tender.source_province.toLowerCase().includes(p.toLowerCase()) ||\r\n          p.toLowerCase().includes(tender.source_province.toLowerCase()),\r\n      )\r\n      if (provinceMatch) {\r\n        score += 0.2\r\n        reasons.push(\"Matches your preferred province\")\r\n      }\r\n    }\r\n\r\n    // Industry/Category match (25 points)\r\n    if (preferences.industries?.length && tender.category) {\r\n      const categoryLower = tender.category.toLowerCase()\r\n      const industryMatch = preferences.industries.some(\r\n        (ind: string) => categoryLower.includes(ind.toLowerCase()) || ind.toLowerCase().includes(categoryLower),\r\n      )\r\n      if (industryMatch) {\r\n        score += 0.25\r\n        reasons.push(\"Matches your industry focus\")\r\n      }\r\n    }\r\n\r\n    // Value match based on company size (20 points)\r\n    if (preferences.annual_turnover && tender.estimated_value) {\r\n      score += 0.15\r\n      reasons.push(\"Contract value within your range\")\r\n    }\r\n\r\n    // Deadline proximity (15 points - more time = better)\r\n    if (tender.close_date) {\r\n      const daysUntilClose = Math.ceil((new Date(tender.close_date).getTime() - Date.now()) / (1000 * 60 * 60 * 24))\r\n      if (daysUntilClose > 14) {\r\n        score += 0.15\r\n        reasons.push(\"Good preparation time available\")\r\n      } else if (daysUntilClose > 7) {\r\n        score += 0.1\r\n        reasons.push(\"Adequate preparation time\")\r\n      } else {\r\n        score += 0.05\r\n        insights.warning = \"Limited preparation time\"\r\n      }\r\n    }\r\n\r\n    // Experience level consideration (20 points)\r\n    if (preferences.experience_level === \"beginner\") {\r\n      if (!tender.estimated_value || tender.estimated_value.includes(\"R\") === false) {\r\n        score += 0.2\r\n        reasons.push(\"Good entry-level opportunity\")\r\n      }\r\n    } else if (preferences.experience_level === \"advanced\") {\r\n      score += 0.1\r\n      reasons.push(\"Matches your experience level\")\r\n    }\r\n\r\n    // Determine opportunity type\r\n    let opportunityType: OpportunityType = \"strategic\"\r\n    if (score >= 0.7) {\r\n      opportunityType = \"high_margin\"\r\n    } else if (score >= 0.5 && reasons.includes(\"Good preparation time available\")) {\r\n      opportunityType = \"low_risk\"\r\n    } else if (preferences.experience_level === \"beginner\" && score >= 0.4) {\r\n      opportunityType = \"quick_win\"\r\n    } else if (score >= 0.4) {\r\n      opportunityType = \"growth\"\r\n    }\r\n\r\n    return {\r\n      tender_id: tender.id,\r\n      match_score: Math.min(score, 1),\r\n      match_reasons: reasons,\r\n      opportunity_type: opportunityType,\r\n      ai_insights: {\r\n        ...insights,\r\n        tender_title: tender.title,\r\n        organization: tender.source_name,\r\n        close_date: tender.close_date,\r\n        category: tender.category,\r\n      },\r\n      expires_at: tender.close_date,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get user's saved opportunities\r\n   * Removed join with scraped_tenders - fetch tender data separately\r\n   */\r\n  static async getSavedOpportunities(userId: string): Promise<StrategistOpportunity[]> {\r\n    const supabase = await createClient()\r\n\r\n    // First get opportunities without join\r\n    const { data: opportunities, error } = await supabase\r\n      .from(\"strategist_opportunities\")\r\n      .select(\"*\")\r\n      .eq(\"user_id\", userId)\r\n      .eq(\"is_saved\", true)\r\n      .eq(\"is_dismissed\", false)\r\n      .order(\"created_at\", { ascending: false })\r\n\r\n    if (error) {\r\n      console.error(\"[Opportunity] Error fetching saved opportunities:\", error)\r\n      return []\r\n    }\r\n\r\n    if (!opportunities || opportunities.length === 0) {\r\n      return []\r\n    }\r\n\r\n    // Get tender IDs and fetch tender data separately\r\n    const tenderIds = opportunities.map((opp) => opp.scraped_tender_id).filter((id): id is string => id !== null)\r\n\r\n    let tendersMap: Record<string, any> = {}\r\n\r\n    if (tenderIds.length > 0) {\r\n      const { data: tenders } = await supabase\r\n        .from(\"scraped_tenders\")\r\n        .select(\"id, title, source_name, close_date, category, estimated_value\")\r\n        .in(\"id\", tenderIds)\r\n\r\n      if (tenders) {\r\n        tendersMap = tenders.reduce(\r\n          (acc, tender) => {\r\n            acc[tender.id] = tender\r\n            return acc\r\n          },\r\n          {} as Record<string, any>,\r\n        )\r\n      }\r\n    }\r\n\r\n    // Combine opportunities with tender data\r\n    return opportunities.map((opp) => ({\r\n      ...opp,\r\n      tender: opp.scraped_tender_id ? tendersMap[opp.scraped_tender_id] || null : null,\r\n    }))\r\n  }\r\n\r\n  /**\r\n   * Update opportunity status\r\n   */\r\n  static async updateOpportunityStatus(\r\n    opportunityId: string,\r\n    updates: {\r\n      is_viewed?: boolean\r\n      is_saved?: boolean\r\n      is_dismissed?: boolean\r\n      user_notes?: string\r\n    },\r\n  ): Promise<boolean> {\r\n    const supabase = await createClient()\r\n\r\n    const { error } = await supabase.from(\"strategist_opportunities\").update(updates).eq(\"id\", opportunityId)\r\n\r\n    return !error\r\n  }\r\n\r\n  /**\r\n   * Create an opportunity from tender data\r\n   */\r\n  static async createOpportunity(params: {\r\n    userId: string\r\n    tenderId: string\r\n    tenderType: \"custom\" | \"scraped\"\r\n    tenderTitle: string\r\n    tenderData: any\r\n  }): Promise<any> {\r\n    try {\r\n      const supabase = await createClient()\r\n\r\n      // Get user preferences for scoring\r\n      const { data: preferences } = await supabase\r\n        .from(\"strategist_user_preferences\")\r\n        .select(\"*\")\r\n        .eq(\"user_id\", params.userId)\r\n        .single()\r\n\r\n      if (!preferences) {\r\n        console.warn(\"[Opportunity] User preferences not found, skipping opportunity creation\")\r\n        return null\r\n      }\r\n\r\n      // Calculate match score\r\n      const matchScore = this.calculateMatchScoreForTender(params.tenderData, preferences)\r\n\r\n      if (matchScore < 0.3) {\r\n        console.log(\"[Opportunity] Match score too low, skipping opportunity creation\")\r\n        return null\r\n      }\r\n\r\n      // Determine opportunity type\r\n      let opportunityType: \"high_margin\" | \"strategic\" | \"quick_win\" | \"low_risk\" | \"growth\" = \"strategic\"\r\n      if (matchScore >= 0.7) opportunityType = \"high_margin\"\r\n      else if (matchScore >= 0.5) opportunityType = \"low_risk\"\r\n      else if (matchScore >= 0.4) opportunityType = \"growth\"\r\n\r\n      // Create opportunity\r\n      const { data, error } = await supabase\r\n        .from(\"strategist_opportunities\")\r\n        .upsert(\r\n          {\r\n            user_id: params.userId,\r\n            scraped_tender_id: params.tenderType === \"scraped\" ? params.tenderId : null,\r\n            custom_tender_id: params.tenderType === \"custom\" ? params.tenderId : null,\r\n            match_score: matchScore,\r\n            match_reasons: this.getMatchReasonsForTender(params.tenderData, preferences),\r\n            opportunity_type: opportunityType,\r\n            ai_insights: {\r\n              tender_title: params.tenderTitle,\r\n              analysis: \"Automatically generated from tender data\",\r\n            },\r\n            expires_at: params.tenderData.close_date || params.tenderData.deadline,\r\n          },\r\n          {\r\n            onConflict: params.tenderType === \"scraped\" ? \"user_id,scraped_tender_id\" : \"user_id,custom_tender_id\",\r\n          },\r\n        )\r\n        .select()\r\n        .single()\r\n\r\n      if (error) {\r\n        console.error(\"[Opportunity] Error creating opportunity:\", error)\r\n        return null\r\n      }\r\n\r\n      return data\r\n    } catch (error) {\r\n      console.error(\"[Opportunity] Error in createOpportunity:\", error)\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find similar opportunities for a tender\r\n   */\r\n  static async findSimilar(params: {\r\n    userId: string\r\n    tenderId: string\r\n    tenderType: \"custom\" | \"scraped\"\r\n  }): Promise<any[]> {\r\n    try {\r\n      const supabase = await createClient()\r\n\r\n      // Get the source tender\r\n      const table = params.tenderType === \"custom\" ? \"user_custom_tenders\" : \"scraped_tenders\"\r\n      const { data: sourceTender } = await supabase.from(table).select(\"*\").eq(\"id\", params.tenderId).single()\r\n\r\n      if (!sourceTender) {\r\n        return []\r\n      }\r\n\r\n      // Find similar tenders based on category and location\r\n      const { data: similarTenders } = await supabase\r\n        .from(\"scraped_tenders\")\r\n        .select(\"id, title, source_name, category, source_province, close_date\")\r\n        .eq(\"is_active\", true)\r\n        .gte(\"close_date\", new Date().toISOString())\r\n        .neq(\"id\", params.tenderType === \"scraped\" ? params.tenderId : \"\")\r\n        .limit(5)\r\n\r\n      if (!similarTenders || similarTenders.length === 0) {\r\n        return []\r\n      }\r\n\r\n      // Filter by similarity (category or province match)\r\n      const similar = similarTenders.filter((tender) => {\r\n        const categoryMatch =\r\n          sourceTender.category &&\r\n          tender.category &&\r\n          (tender.category.toLowerCase().includes(sourceTender.category.toLowerCase()) ||\r\n            sourceTender.category.toLowerCase().includes(tender.category.toLowerCase()))\r\n\r\n        const provinceMatch =\r\n          sourceTender.source_province &&\r\n          tender.source_province &&\r\n          tender.source_province.toLowerCase() === sourceTender.source_province.toLowerCase()\r\n\r\n        return categoryMatch || provinceMatch\r\n      })\r\n\r\n      return similar\r\n    } catch (error) {\r\n      console.error(\"[Opportunity] Error finding similar opportunities:\", error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Calculate match score for a tender\r\n   */\r\n  private static calculateMatchScoreForTender(tender: any, preferences: any): number {\r\n    let score = 0\r\n\r\n    // Category/Industry match\r\n    if (preferences.industries?.length && tender.category) {\r\n      const categoryMatch = preferences.industries.some((ind: string) =>\r\n        tender.category.toLowerCase().includes(ind.toLowerCase()),\r\n      )\r\n      if (categoryMatch) score += 0.3\r\n    }\r\n\r\n    // Province match\r\n    if (preferences.provinces?.length && (tender.source_province || tender.location)) {\r\n      const province = tender.source_province || tender.location\r\n      const provinceMatch = preferences.provinces.some((p: string) => province?.toLowerCase().includes(p.toLowerCase()))\r\n      if (provinceMatch) score += 0.25\r\n    }\r\n\r\n    // Deadline consideration\r\n    const deadline = tender.close_date || tender.deadline\r\n    if (deadline) {\r\n      const daysUntilClose = Math.ceil((new Date(deadline).getTime() - Date.now()) / (1000 * 60 * 60 * 24))\r\n      if (daysUntilClose > 14) score += 0.2\r\n      else if (daysUntilClose > 7) score += 0.15\r\n      else score += 0.05\r\n    }\r\n\r\n    // Base score for any tender\r\n    score += 0.25\r\n\r\n    return Math.min(score, 1)\r\n  }\r\n\r\n  /**\r\n   * Get match reasons for a tender\r\n   */\r\n  private static getMatchReasonsForTender(tender: any, preferences: any): string[] {\r\n    const reasons: string[] = []\r\n\r\n    if (preferences.industries?.length && tender.category) {\r\n      const categoryMatch = preferences.industries.some((ind: string) =>\r\n        tender.category.toLowerCase().includes(ind.toLowerCase()),\r\n      )\r\n      if (categoryMatch) reasons.push(\"Matches your industry expertise\")\r\n    }\r\n\r\n    if (preferences.provinces?.length) {\r\n      const province = tender.source_province || tender.location\r\n      const provinceMatch = preferences.provinces.some((p: string) => province?.toLowerCase().includes(p.toLowerCase()))\r\n      if (provinceMatch) reasons.push(\"Located in your preferred province\")\r\n    }\r\n\r\n    const deadline = tender.close_date || tender.deadline\r\n    if (deadline) {\r\n      const daysUntilClose = Math.ceil((new Date(deadline).getTime() - Date.now()) / (1000 * 60 * 60 * 24))\r\n      if (daysUntilClose > 14) reasons.push(\"Sufficient time to prepare quality bid\")\r\n    }\r\n\r\n    if (reasons.length === 0) {\r\n      reasons.push(\"General opportunity match\")\r\n    }\r\n\r\n    return reasons\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4087, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/strategist/services/learning-service.ts"],"sourcesContent":["// ============================================\r\n// AI TENDER STRATEGIST - LEARNING SERVICE\r\n// ============================================\r\n\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { LEARNING_TOPICS } from \"../constants\"\r\nimport type { StrategistLearningProgress } from \"../types\"\r\n\r\nexport class LearningService {\r\n  /**\r\n   * Get all learning topics\r\n   */\r\n  static getTopics(): typeof LEARNING_TOPICS {\r\n    return LEARNING_TOPICS\r\n  }\r\n\r\n  /**\r\n   * Get learning progress for a user\r\n   */\r\n  static async getUserProgress(userId: string): Promise<StrategistLearningProgress[]> {\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"strategist_learning_progress\")\r\n      .select(\"*\")\r\n      .eq(\"user_id\", userId)\r\n      .order(\"last_accessed_at\", { ascending: false, nullsFirst: false })\r\n\r\n    if (error) {\r\n      console.error(\"[Learning] Error fetching progress:\", error)\r\n      return []\r\n    }\r\n\r\n    return data || []\r\n  }\r\n\r\n  /**\r\n   * Get progress for a specific topic\r\n   */\r\n  static async getTopicProgress(userId: string, topicId: string): Promise<StrategistLearningProgress | null> {\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"strategist_learning_progress\")\r\n      .select(\"*\")\r\n      .eq(\"user_id\", userId)\r\n      .eq(\"topic_id\", topicId)\r\n      .single()\r\n\r\n    if (error && error.code !== \"PGRST116\") {\r\n      console.error(\"[Learning] Error fetching topic progress:\", error)\r\n      return null\r\n    }\r\n\r\n    return data\r\n  }\r\n\r\n  /**\r\n   * Update learning progress\r\n   */\r\n  static async updateProgress(\r\n    userId: string,\r\n    topicId: string,\r\n    updates: {\r\n      progress_percent?: number\r\n      lesson_completed?: string\r\n      quiz_score?: { quiz_id: string; score: number }\r\n      time_spent_minutes?: number\r\n    },\r\n  ): Promise<StrategistLearningProgress | null> {\r\n    const supabase = await createClient()\r\n\r\n    // Get current progress\r\n    const { data: current } = await supabase\r\n      .from(\"strategist_learning_progress\")\r\n      .select(\"*\")\r\n      .eq(\"user_id\", userId)\r\n      .eq(\"topic_id\", topicId)\r\n      .single()\r\n\r\n    const topic = LEARNING_TOPICS.find((t) => t.id === topicId)\r\n    if (!topic) return null\r\n\r\n    const lessonsCompleted = current?.lessons_completed || []\r\n    const quizScores = current?.quiz_scores || []\r\n    let progressPercent = current?.progress_percent || 0\r\n    let timeSpent = current?.time_spent_minutes || 0\r\n\r\n    // Update lessons completed\r\n    if (updates.lesson_completed && !lessonsCompleted.includes(updates.lesson_completed)) {\r\n      lessonsCompleted.push(updates.lesson_completed)\r\n      // Calculate progress based on subtopics\r\n      progressPercent = Math.round((lessonsCompleted.length / topic.subtopics.length) * 100)\r\n    }\r\n\r\n    // Update quiz scores\r\n    if (updates.quiz_score) {\r\n      const existingIndex = quizScores.findIndex((q: any) => q.quiz_id === updates.quiz_score!.quiz_id)\r\n      if (existingIndex >= 0) {\r\n        quizScores[existingIndex] = { ...updates.quiz_score, completed_at: new Date().toISOString() }\r\n      } else {\r\n        quizScores.push({ ...updates.quiz_score, completed_at: new Date().toISOString() })\r\n      }\r\n    }\r\n\r\n    // Update time spent\r\n    if (updates.time_spent_minutes) {\r\n      timeSpent += updates.time_spent_minutes\r\n    }\r\n\r\n    // Override progress if explicitly set\r\n    if (updates.progress_percent !== undefined) {\r\n      progressPercent = updates.progress_percent\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"strategist_learning_progress\")\r\n      .upsert(\r\n        {\r\n          user_id: userId,\r\n          topic_id: topicId,\r\n          topic_category: topic.category,\r\n          progress_percent: progressPercent,\r\n          lessons_completed: lessonsCompleted,\r\n          quiz_scores: quizScores,\r\n          time_spent_minutes: timeSpent,\r\n          last_accessed_at: new Date().toISOString(),\r\n          completed_at: progressPercent >= 100 ? new Date().toISOString() : null,\r\n          updated_at: new Date().toISOString(),\r\n        },\r\n        { onConflict: \"user_id, topic_id\" },\r\n      )\r\n      .select()\r\n      .single()\r\n\r\n    if (error) {\r\n      console.error(\"[Learning] Error updating progress:\", error)\r\n      return null\r\n    }\r\n\r\n    return data\r\n  }\r\n\r\n  /**\r\n   * Get recommended topics for user\r\n   */\r\n  static async getRecommendedTopics(userId: string): Promise<(typeof LEARNING_TOPICS)[number][]> {\r\n    const supabase = await createClient()\r\n\r\n    // Get user's experience level\r\n    const { data: preferences } = await supabase\r\n      .from(\"strategist_user_preferences\")\r\n      .select(\"experience_level\")\r\n      .eq(\"user_id\", userId)\r\n      .single()\r\n\r\n    const experienceLevel = preferences?.experience_level || \"beginner\"\r\n\r\n    // Get completed topics\r\n    const progress = await this.getUserProgress(userId)\r\n    const completedTopicIds = progress.filter((p) => p.progress_percent >= 100).map((p) => p.topic_id)\r\n\r\n    // Filter and prioritize topics\r\n    const recommendations = LEARNING_TOPICS.filter((topic) => {\r\n      // Exclude completed\r\n      if (completedTopicIds.includes(topic.id)) return false\r\n\r\n      // Match difficulty to experience\r\n      if (experienceLevel === \"beginner\" && topic.difficulty === \"advanced\") return false\r\n      if (experienceLevel === \"intermediate\" && topic.difficulty === \"advanced\") {\r\n        // Only show advanced if basics are done\r\n        const hasBasics = completedTopicIds.some((id) =>\r\n          LEARNING_TOPICS.find((t) => t.id === id && t.category === \"basics\"),\r\n        )\r\n        if (!hasBasics) return false\r\n      }\r\n\r\n      return true\r\n    }).slice(0, 5)\r\n\r\n    return recommendations\r\n  }\r\n\r\n  /**\r\n   * Get overall learning statistics\r\n   */\r\n  static async getLearningStats(userId: string): Promise<{\r\n    totalTopics: number\r\n    completedTopics: number\r\n    totalTimeMinutes: number\r\n    averageQuizScore: number\r\n    topCategories: string[]\r\n  }> {\r\n    const progress = await this.getUserProgress(userId)\r\n\r\n    const completedTopics = progress.filter((p) => p.progress_percent >= 100).length\r\n    const totalTimeMinutes = progress.reduce((sum, p) => sum + p.time_spent_minutes, 0)\r\n\r\n    const allQuizScores = progress.flatMap((p) => p.quiz_scores || [])\r\n    const averageQuizScore =\r\n      allQuizScores.length > 0 ? allQuizScores.reduce((sum, q: any) => sum + q.score, 0) / allQuizScores.length : 0\r\n\r\n    // Find top categories by progress\r\n    const categoryProgress: Record<string, number> = {}\r\n    progress.forEach((p) => {\r\n      if (!categoryProgress[p.topic_category]) {\r\n        categoryProgress[p.topic_category] = 0\r\n      }\r\n      categoryProgress[p.topic_category] += p.progress_percent\r\n    })\r\n\r\n    const topCategories = Object.entries(categoryProgress)\r\n      .sort(([, a], [, b]) => b - a)\r\n      .slice(0, 3)\r\n      .map(([category]) => category)\r\n\r\n    return {\r\n      totalTopics: LEARNING_TOPICS.length,\r\n      completedTopics,\r\n      totalTimeMinutes,\r\n      averageQuizScore,\r\n      topCategories,\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4245, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/strategist/services/alert-service.ts"],"sourcesContent":["// ============================================\r\n// AI TENDER STRATEGIST - ALERT SERVICE\r\n// ============================================\r\n\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport type { StrategistAlert, AlertType, AlertPriority } from \"../types\"\r\n\r\nexport class AlertService {\r\n  /**\r\n   * Create a new alert\r\n   */\r\n  static async createAlert(\r\n    userId: string,\r\n    alert: {\r\n      alert_type: AlertType\r\n      title: string\r\n      message: string\r\n      priority?: AlertPriority\r\n      related_tender_id?: string\r\n      related_document_type?: string\r\n      action_url?: string\r\n      action_label?: string\r\n      trigger_date?: string\r\n      expiry_date?: string\r\n    },\r\n  ): Promise<StrategistAlert | null> {\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"strategist_alerts\")\r\n      .insert({\r\n        user_id: userId,\r\n        ...alert,\r\n        priority: alert.priority || \"medium\",\r\n        trigger_date: alert.trigger_date || new Date().toISOString(),\r\n      })\r\n      .select()\r\n      .single()\r\n\r\n    if (error) {\r\n      console.error(\"[Alert] Error creating alert:\", error)\r\n      return null\r\n    }\r\n\r\n    return data\r\n  }\r\n\r\n  /**\r\n   * Get user's alerts\r\n   */\r\n  static async getUserAlerts(\r\n    userId: string,\r\n    options?: {\r\n      unreadOnly?: boolean\r\n      priority?: AlertPriority\r\n      limit?: number\r\n    },\r\n  ): Promise<StrategistAlert[]> {\r\n    const supabase = await createClient()\r\n\r\n    let query = supabase\r\n      .from(\"strategist_alerts\")\r\n      .select(\"*\")\r\n      .eq(\"user_id\", userId)\r\n      .eq(\"is_dismissed\", false)\r\n      .order(\"priority\", { ascending: false })\r\n      .order(\"created_at\", { ascending: false })\r\n\r\n    if (options?.unreadOnly) {\r\n      query = query.eq(\"is_read\", false)\r\n    }\r\n\r\n    if (options?.priority) {\r\n      query = query.eq(\"priority\", options.priority)\r\n    }\r\n\r\n    if (options?.limit) {\r\n      query = query.limit(options.limit)\r\n    }\r\n\r\n    const { data, error } = await query\r\n\r\n    if (error) {\r\n      console.error(\"[Alert] Error fetching alerts:\", error)\r\n      return []\r\n    }\r\n\r\n    return data || []\r\n  }\r\n\r\n  /**\r\n   * Mark alert as read\r\n   */\r\n  static async markAsRead(alertId: string): Promise<boolean> {\r\n    const supabase = await createClient()\r\n\r\n    const { error } = await supabase.from(\"strategist_alerts\").update({ is_read: true }).eq(\"id\", alertId)\r\n\r\n    return !error\r\n  }\r\n\r\n  /**\r\n   * Dismiss alert\r\n   */\r\n  static async dismissAlert(alertId: string): Promise<boolean> {\r\n    const supabase = await createClient()\r\n\r\n    const { error } = await supabase.from(\"strategist_alerts\").update({ is_dismissed: true }).eq(\"id\", alertId)\r\n\r\n    return !error\r\n  }\r\n\r\n  /**\r\n   * Mark alert as actioned\r\n   */\r\n  static async markAsActioned(alertId: string): Promise<boolean> {\r\n    const supabase = await createClient()\r\n\r\n    const { error } = await supabase\r\n      .from(\"strategist_alerts\")\r\n      .update({ is_actioned: true, is_read: true })\r\n      .eq(\"id\", alertId)\r\n\r\n    return !error\r\n  }\r\n\r\n  /**\r\n   * Generate compliance alerts for user\r\n   */\r\n  static async generateComplianceAlerts(userId: string): Promise<void> {\r\n    const supabase = await createClient()\r\n\r\n    // Get user preferences\r\n    const { data: preferences } = await supabase\r\n      .from(\"strategist_user_preferences\")\r\n      .select(\"*\")\r\n      .eq(\"user_id\", userId)\r\n      .single()\r\n\r\n    if (!preferences) return\r\n\r\n    const now = new Date()\r\n    const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000)\r\n\r\n    // Check tax clearance expiry\r\n    if (preferences.has_tax_clearance && preferences.tax_clearance_expiry) {\r\n      const expiryDate = new Date(preferences.tax_clearance_expiry)\r\n      if (expiryDate <= thirtyDaysFromNow) {\r\n        const daysUntilExpiry = Math.ceil((expiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24))\r\n\r\n        await this.createAlert(userId, {\r\n          alert_type: \"document_expiry\",\r\n          title: \"Tax Clearance Expiring Soon\",\r\n          message: `Your tax clearance certificate expires in ${daysUntilExpiry} days. Renew it to maintain tender eligibility.`,\r\n          priority: daysUntilExpiry <= 14 ? \"urgent\" : \"high\",\r\n          related_document_type: \"tax_clearance\",\r\n          action_url: \"/dashboard/profile\",\r\n          action_label: \"Update Documents\",\r\n          expiry_date: preferences.tax_clearance_expiry,\r\n        })\r\n      }\r\n    }\r\n\r\n    // Check COIDA expiry\r\n    if (preferences.has_coida && preferences.coida_expiry) {\r\n      const expiryDate = new Date(preferences.coida_expiry)\r\n      if (expiryDate <= thirtyDaysFromNow) {\r\n        const daysUntilExpiry = Math.ceil((expiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24))\r\n\r\n        await this.createAlert(userId, {\r\n          alert_type: \"document_expiry\",\r\n          title: \"COIDA Letter Expiring Soon\",\r\n          message: `Your COIDA letter of good standing expires in ${daysUntilExpiry} days. Renew it to maintain compliance.`,\r\n          priority: daysUntilExpiry <= 14 ? \"high\" : \"medium\",\r\n          related_document_type: \"coida\",\r\n          action_url: \"/dashboard/profile\",\r\n          action_label: \"Update Documents\",\r\n          expiry_date: preferences.coida_expiry,\r\n        })\r\n      }\r\n    }\r\n\r\n    // Check for missing CSD registration\r\n    if (!preferences.has_csd_registration) {\r\n      await this.createAlert(userId, {\r\n        alert_type: \"compliance_gap\",\r\n        title: \"CSD Registration Missing\",\r\n        message:\r\n          \"You need to register on the Central Supplier Database (CSD) to bid on government tenders. This is a mandatory requirement.\",\r\n        priority: \"high\",\r\n        action_url: \"https://secure.csd.gov.za/\",\r\n        action_label: \"Register on CSD\",\r\n      })\r\n    }\r\n\r\n    // Check for missing tax clearance\r\n    if (!preferences.has_tax_clearance) {\r\n      await this.createAlert(userId, {\r\n        alert_type: \"compliance_gap\",\r\n        title: \"Tax Clearance Missing\",\r\n        message: \"A valid tax clearance certificate is required for all government tenders.\",\r\n        priority: \"urgent\",\r\n        related_document_type: \"tax_clearance\",\r\n        action_url: \"https://www.sars.gov.za/\",\r\n        action_label: \"Get Tax Clearance\",\r\n      })\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get unread alert count\r\n   */\r\n  static async getUnreadCount(userId: string): Promise<number> {\r\n    const supabase = await createClient()\r\n\r\n    const { count, error } = await supabase\r\n      .from(\"strategist_alerts\")\r\n      .select(\"*\", { count: \"exact\", head: true })\r\n      .eq(\"user_id\", userId)\r\n      .eq(\"is_read\", false)\r\n      .eq(\"is_dismissed\", false)\r\n\r\n    if (error) {\r\n      console.error(\"[Alert] Error counting alerts:\", error)\r\n      return 0\r\n    }\r\n\r\n    return count || 0\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4410, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/strategist/services/competitiveness-service.ts"],"sourcesContent":["// ============================================\r\n// AI TENDER STRATEGIST - COMPETITIVENESS SERVICE\r\n// ============================================\r\n\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport type { StrategistCompetitivenessScore } from \"../types\"\r\n\r\nexport class CompetitivenessService {\r\n  /**\r\n   * Calculate competitiveness score for a user\r\n   */\r\n  static async calculateScore(params: {\r\n    userId: string\r\n    tenderId?: string\r\n    tenderType?: \"custom\" | \"scraped\"\r\n  }): Promise<StrategistCompetitivenessScore | null> {\r\n    const supabase = await createClient()\r\n\r\n    // Get user data\r\n    const [preferencesResult, companyResult, profileResult] = await Promise.all([\r\n      supabase.from(\"strategist_user_preferences\").select(\"*\").eq(\"user_id\", params.userId).single(),\r\n      supabase.from(\"companies\").select(\"*\").eq(\"user_id\", params.userId).single(),\r\n      supabase.from(\"profiles\").select(\"*\").eq(\"id\", params.userId).single(),\r\n    ])\r\n\r\n    const preferences = preferencesResult.data\r\n    const company = companyResult.data\r\n    const profile = profileResult.data\r\n\r\n    // Calculate component scores\r\n    const documentationScore = this.calculateDocumentationScore(preferences, company)\r\n    const pricingScore = this.calculatePricingScore(preferences)\r\n    const complianceScore = this.calculateComplianceScore(preferences)\r\n    const experienceScore = this.calculateExperienceScore(preferences)\r\n    const capacityScore = this.calculateCapacityScore(preferences, company)\r\n\r\n    // Calculate overall and win probability\r\n    const overallScore = (documentationScore + pricingScore + complianceScore + experienceScore + capacityScore) / 5\r\n\r\n    const winProbability = this.estimateWinProbability(overallScore, preferences, params.tenderId)\r\n\r\n    // Build score breakdown\r\n    const scoreBreakdown = {\r\n      documentation: {\r\n        score: documentationScore,\r\n        factors: this.getDocumentationFactors(preferences, company),\r\n      },\r\n      pricing: {\r\n        score: pricingScore,\r\n        factors: this.getPricingFactors(preferences),\r\n      },\r\n      compliance: {\r\n        score: complianceScore,\r\n        factors: this.getComplianceFactors(preferences),\r\n      },\r\n      experience: {\r\n        score: experienceScore,\r\n        factors: this.getExperienceFactors(preferences),\r\n      },\r\n      capacity: {\r\n        score: capacityScore,\r\n        factors: this.getCapacityFactors(preferences, company),\r\n      },\r\n    }\r\n\r\n    // Generate improvement suggestions\r\n    const improvementSuggestions = this.generateImprovementSuggestions(scoreBreakdown)\r\n\r\n    // Save score\r\n    const { data, error } = await supabase\r\n      .from(\"strategist_competitiveness_scores\")\r\n      .upsert(\r\n        {\r\n          user_id: params.userId,\r\n          tender_id: params.tenderId,\r\n          documentation_score: documentationScore,\r\n          pricing_score: pricingScore,\r\n          compliance_score: complianceScore,\r\n          experience_score: experienceScore,\r\n          capacity_score: capacityScore,\r\n          score_breakdown: scoreBreakdown,\r\n          improvement_suggestions: improvementSuggestions,\r\n          win_probability: winProbability,\r\n          win_probability_factors: {\r\n            base_score: overallScore,\r\n            experience_bonus: preferences?.experience_level === \"advanced\" ? 0.1 : 0,\r\n            compliance_penalty: complianceScore < 0.5 ? -0.2 : 0,\r\n          },\r\n          calculated_at: new Date().toISOString(),\r\n          valid_until: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // Valid for 7 days\r\n        },\r\n        { onConflict: \"user_id\" },\r\n      )\r\n      .select()\r\n      .single()\r\n\r\n    if (error) {\r\n      console.error(\"[Competitiveness] Error saving score:\", error)\r\n      return null\r\n    }\r\n\r\n    return data\r\n  }\r\n\r\n  /**\r\n   * Get cached score or calculate new one\r\n   */\r\n  static async getScore(userId: string, tenderId?: string): Promise<StrategistCompetitivenessScore | null> {\r\n    const supabase = await createClient()\r\n\r\n    // Check for valid cached score\r\n    const { data: cached } = await supabase\r\n      .from(\"strategist_competitiveness_scores\")\r\n      .select(\"*\")\r\n      .eq(\"user_id\", userId)\r\n      .gte(\"valid_until\", new Date().toISOString())\r\n      .single()\r\n\r\n    if (cached) {\r\n      return cached\r\n    }\r\n\r\n    // Calculate new score\r\n    return this.calculateScore({ userId, tenderId })\r\n  }\r\n\r\n  // Score calculation helpers\r\n  private static calculateDocumentationScore(preferences: any, company: any): number {\r\n    let score = 0\r\n    let total = 0\r\n\r\n    // Check various documentation\r\n    if (company?.company_name) {\r\n      score += 1\r\n      total += 1\r\n    }\r\n    if (company?.registration_number) {\r\n      score += 1\r\n      total += 1\r\n    }\r\n    if (company?.tax_number) {\r\n      score += 1\r\n      total += 1\r\n    }\r\n    if (preferences?.has_tax_clearance) {\r\n      score += 2\r\n      total += 2\r\n    }\r\n    if (preferences?.has_coida) {\r\n      score += 1\r\n      total += 1\r\n    }\r\n    if (preferences?.has_csd_registration) {\r\n      score += 2\r\n      total += 2\r\n    }\r\n    if (preferences?.cidb_grading) {\r\n      score += 1\r\n      total += 1\r\n    }\r\n    if (preferences?.bee_level) {\r\n      score += 1\r\n      total += 1\r\n    }\r\n\r\n    return total > 0 ? score / total : 0\r\n  }\r\n\r\n  private static calculatePricingScore(preferences: any): number {\r\n    // Based on past performance\r\n    const wins = preferences?.past_tender_wins || 0\r\n    const losses = preferences?.past_tender_losses || 0\r\n    const total = wins + losses\r\n\r\n    if (total === 0) return 0.5 // Neutral for new users\r\n\r\n    const winRate = wins / total\r\n    return Math.min(winRate * 1.2, 1) // Slight bonus for good win rate\r\n  }\r\n\r\n  private static calculateComplianceScore(preferences: any): number {\r\n    let score = 0\r\n\r\n    if (preferences?.has_tax_clearance) score += 0.35\r\n    if (preferences?.has_coida) score += 0.25\r\n    if (preferences?.has_csd_registration) score += 0.4\r\n\r\n    return score\r\n  }\r\n\r\n  private static calculateExperienceScore(preferences: any): number {\r\n    const levelScores: Record<string, number> = {\r\n      beginner: 0.3,\r\n      intermediate: 0.6,\r\n      advanced: 0.9,\r\n    }\r\n\r\n    const baseScore = levelScores[preferences?.experience_level] || 0.3\r\n\r\n    // Bonus for past wins\r\n    const wins = preferences?.past_tender_wins || 0\r\n    const winBonus = Math.min(wins * 0.02, 0.1)\r\n\r\n    return Math.min(baseScore + winBonus, 1)\r\n  }\r\n\r\n  private static calculateCapacityScore(preferences: any, company: any): number {\r\n    let score = 0.5 // Base score\r\n\r\n    // Company size factor\r\n    const sizeScores: Record<string, number> = {\r\n      micro: 0.1,\r\n      small: 0.2,\r\n      medium: 0.3,\r\n      large: 0.4,\r\n      enterprise: 0.5,\r\n    }\r\n    score += sizeScores[company?.company_size] || 0\r\n\r\n    // CIDB grading factor (for construction)\r\n    if (preferences?.cidb_grading) {\r\n      const grading = Number.parseInt(preferences.cidb_grading)\r\n      if (!isNaN(grading)) {\r\n        score += grading * 0.02\r\n      }\r\n    }\r\n\r\n    return Math.min(score, 1)\r\n  }\r\n\r\n  // Factor breakdown helpers\r\n  private static getDocumentationFactors(preferences: any, company: any): string[] {\r\n    const factors: string[] = []\r\n    if (company?.company_name) factors.push(\"Company profile complete\")\r\n    if (preferences?.has_tax_clearance) factors.push(\"Tax clearance valid\")\r\n    if (preferences?.has_csd_registration) factors.push(\"CSD registered\")\r\n    if (preferences?.bee_level) factors.push(\"B-BBEE certificate\")\r\n    if (!preferences?.has_tax_clearance) factors.push(\"Missing: Tax clearance\")\r\n    if (!preferences?.has_csd_registration) factors.push(\"Missing: CSD registration\")\r\n    return factors\r\n  }\r\n\r\n  private static getPricingFactors(preferences: any): string[] {\r\n    const factors: string[] = []\r\n    const wins = preferences?.past_tender_wins || 0\r\n    const losses = preferences?.past_tender_losses || 0\r\n    if (wins > 0) factors.push(`${wins} past tender wins`)\r\n    if (losses > 0) factors.push(`${losses} past tender losses`)\r\n    if (wins === 0 && losses === 0) factors.push(\"No historical pricing data\")\r\n    return factors\r\n  }\r\n\r\n  private static getComplianceFactors(preferences: any): string[] {\r\n    const factors: string[] = []\r\n    if (preferences?.has_tax_clearance) factors.push(\"Tax clearance: Valid\")\r\n    else factors.push(\"Tax clearance: Missing\")\r\n    if (preferences?.has_coida) factors.push(\"COIDA: Valid\")\r\n    else factors.push(\"COIDA: Missing\")\r\n    if (preferences?.has_csd_registration) factors.push(\"CSD: Registered\")\r\n    else factors.push(\"CSD: Not registered\")\r\n    return factors\r\n  }\r\n\r\n  private static getExperienceFactors(preferences: any): string[] {\r\n    const factors: string[] = []\r\n    factors.push(`Experience level: ${preferences?.experience_level || \"Unknown\"}`)\r\n    const wins = preferences?.past_tender_wins || 0\r\n    if (wins > 0) factors.push(`${wins} successful tenders`)\r\n    return factors\r\n  }\r\n\r\n  private static getCapacityFactors(preferences: any, company: any): string[] {\r\n    const factors: string[] = []\r\n    if (company?.company_size) factors.push(`Company size: ${company.company_size}`)\r\n    if (preferences?.cidb_grading) factors.push(`CIDB grading: ${preferences.cidb_grading}`)\r\n    if (preferences?.annual_turnover) factors.push(`Annual turnover: ${preferences.annual_turnover}`)\r\n    return factors\r\n  }\r\n\r\n  private static estimateWinProbability(overallScore: number, preferences: any, tenderId?: string): number {\r\n    let probability = overallScore * 0.7 // Base from overall score\r\n\r\n    // Adjustments\r\n    if (preferences?.experience_level === \"advanced\") probability += 0.1\r\n    if (preferences?.experience_level === \"beginner\") probability -= 0.1\r\n    if (preferences?.has_tax_clearance && preferences?.has_csd_registration) probability += 0.1\r\n\r\n    // Cap between 0.1 and 0.9\r\n    return Math.max(0.1, Math.min(0.9, probability))\r\n  }\r\n\r\n  private static generateImprovementSuggestions(breakdown: Record<string, any>): string[] {\r\n    const suggestions: string[] = []\r\n\r\n    if (breakdown.documentation.score < 0.7) {\r\n      suggestions.push(\"Complete your company profile with all required documentation\")\r\n    }\r\n    if (breakdown.compliance.score < 0.8) {\r\n      if (!breakdown.compliance.factors.includes(\"Tax clearance: Valid\")) {\r\n        suggestions.push(\"Obtain a valid tax clearance certificate from SARS\")\r\n      }\r\n      if (!breakdown.compliance.factors.includes(\"CSD: Registered\")) {\r\n        suggestions.push(\"Register on the Central Supplier Database (CSD)\")\r\n      }\r\n    }\r\n    if (breakdown.experience.score < 0.5) {\r\n      suggestions.push(\"Start with smaller tenders to build your track record\")\r\n    }\r\n    if (breakdown.capacity.score < 0.5) {\r\n      suggestions.push(\"Consider joint ventures to increase your capacity for larger tenders\")\r\n    }\r\n\r\n    return suggestions\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,+CAA+C;AAC/C,iDAAiD;AACjD,+CAA+C;;;;;AAE/C;;AAGO,MAAM;IACX;;GAEC,GACD,aAAa,eAAe,MAI3B,EAAkD;QACjD,MAAM,WAAW,MAAM,IAAA,2IAAY;QAEnC,gBAAgB;QAChB,MAAM,CAAC,mBAAmB,eAAe,cAAc,GAAG,MAAM,QAAQ,GAAG,CAAC;YAC1E,SAAS,IAAI,CAAC,+BAA+B,MAAM,CAAC,KAAK,EAAE,CAAC,WAAW,OAAO,MAAM,EAAE,MAAM;YAC5F,SAAS,IAAI,CAAC,aAAa,MAAM,CAAC,KAAK,EAAE,CAAC,WAAW,OAAO,MAAM,EAAE,MAAM;YAC1E,SAAS,IAAI,CAAC,YAAY,MAAM,CAAC,KAAK,EAAE,CAAC,MAAM,OAAO,MAAM,EAAE,MAAM;SACrE;QAED,MAAM,cAAc,kBAAkB,IAAI;QAC1C,MAAM,UAAU,cAAc,IAAI;QAClC,MAAM,UAAU,cAAc,IAAI;QAElC,6BAA6B;QAC7B,MAAM,qBAAqB,IAAI,CAAC,2BAA2B,CAAC,aAAa;QACzE,MAAM,eAAe,IAAI,CAAC,qBAAqB,CAAC;QAChD,MAAM,kBAAkB,IAAI,CAAC,wBAAwB,CAAC;QACtD,MAAM,kBAAkB,IAAI,CAAC,wBAAwB,CAAC;QACtD,MAAM,gBAAgB,IAAI,CAAC,sBAAsB,CAAC,aAAa;QAE/D,wCAAwC;QACxC,MAAM,eAAe,CAAC,qBAAqB,eAAe,kBAAkB,kBAAkB,aAAa,IAAI;QAE/G,MAAM,iBAAiB,IAAI,CAAC,sBAAsB,CAAC,cAAc,aAAa,OAAO,QAAQ;QAE7F,wBAAwB;QACxB,MAAM,iBAAiB;YACrB,eAAe;gBACb,OAAO;gBACP,SAAS,IAAI,CAAC,uBAAuB,CAAC,aAAa;YACrD;YACA,SAAS;gBACP,OAAO;gBACP,SAAS,IAAI,CAAC,iBAAiB,CAAC;YAClC;YACA,YAAY;gBACV,OAAO;gBACP,SAAS,IAAI,CAAC,oBAAoB,CAAC;YACrC;YACA,YAAY;gBACV,OAAO;gBACP,SAAS,IAAI,CAAC,oBAAoB,CAAC;YACrC;YACA,UAAU;gBACR,OAAO;gBACP,SAAS,IAAI,CAAC,kBAAkB,CAAC,aAAa;YAChD;QACF;QAEA,mCAAmC;QACnC,MAAM,yBAAyB,IAAI,CAAC,8BAA8B,CAAC;QAEnE,aAAa;QACb,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,qCACL,MAAM,CACL;YACE,SAAS,OAAO,MAAM;YACtB,WAAW,OAAO,QAAQ;YAC1B,qBAAqB;YACrB,eAAe;YACf,kBAAkB;YAClB,kBAAkB;YAClB,gBAAgB;YAChB,iBAAiB;YACjB,yBAAyB;YACzB,iBAAiB;YACjB,yBAAyB;gBACvB,YAAY;gBACZ,kBAAkB,aAAa,qBAAqB,aAAa,MAAM;gBACvE,oBAAoB,kBAAkB,MAAM,CAAC,MAAM;YACrD;YACA,eAAe,IAAI,OAAO,WAAW;YACrC,aAAa,IAAI,KAAK,KAAK,GAAG,KAAK,IAAI,KAAK,KAAK,KAAK,MAAM,WAAW;QACzE,GACA;YAAE,YAAY;QAAU,GAEzB,MAAM,GACN,MAAM;QAET,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,yCAAyC;YACvD,OAAO;QACT;QAEA,OAAO;IACT;IAEA;;GAEC,GACD,aAAa,SAAS,MAAc,EAAE,QAAiB,EAAkD;QACvG,MAAM,WAAW,MAAM,IAAA,2IAAY;QAEnC,+BAA+B;QAC/B,MAAM,EAAE,MAAM,MAAM,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,qCACL,MAAM,CAAC,KACP,EAAE,CAAC,WAAW,QACd,GAAG,CAAC,eAAe,IAAI,OAAO,WAAW,IACzC,MAAM;QAET,IAAI,QAAQ;YACV,OAAO;QACT;QAEA,sBAAsB;QACtB,OAAO,IAAI,CAAC,cAAc,CAAC;YAAE;YAAQ;QAAS;IAChD;IAEA,4BAA4B;IAC5B,OAAe,4BAA4B,WAAgB,EAAE,OAAY,EAAU;QACjF,IAAI,QAAQ;QACZ,IAAI,QAAQ;QAEZ,8BAA8B;QAC9B,IAAI,SAAS,cAAc;YACzB,SAAS;YACT,SAAS;QACX;QACA,IAAI,SAAS,qBAAqB;YAChC,SAAS;YACT,SAAS;QACX;QACA,IAAI,SAAS,YAAY;YACvB,SAAS;YACT,SAAS;QACX;QACA,IAAI,aAAa,mBAAmB;YAClC,SAAS;YACT,SAAS;QACX;QACA,IAAI,aAAa,WAAW;YAC1B,SAAS;YACT,SAAS;QACX;QACA,IAAI,aAAa,sBAAsB;YACrC,SAAS;YACT,SAAS;QACX;QACA,IAAI,aAAa,cAAc;YAC7B,SAAS;YACT,SAAS;QACX;QACA,IAAI,aAAa,WAAW;YAC1B,SAAS;YACT,SAAS;QACX;QAEA,OAAO,QAAQ,IAAI,QAAQ,QAAQ;IACrC;IAEA,OAAe,sBAAsB,WAAgB,EAAU;QAC7D,4BAA4B;QAC5B,MAAM,OAAO,aAAa,oBAAoB;QAC9C,MAAM,SAAS,aAAa,sBAAsB;QAClD,MAAM,QAAQ,OAAO;QAErB,IAAI,UAAU,GAAG,OAAO,IAAI,wBAAwB;;QAEpD,MAAM,UAAU,OAAO;QACvB,OAAO,KAAK,GAAG,CAAC,UAAU,KAAK,GAAG,iCAAiC;;IACrE;IAEA,OAAe,yBAAyB,WAAgB,EAAU;QAChE,IAAI,QAAQ;QAEZ,IAAI,aAAa,mBAAmB,SAAS;QAC7C,IAAI,aAAa,WAAW,SAAS;QACrC,IAAI,aAAa,sBAAsB,SAAS;QAEhD,OAAO;IACT;IAEA,OAAe,yBAAyB,WAAgB,EAAU;QAChE,MAAM,cAAsC;YAC1C,UAAU;YACV,cAAc;YACd,UAAU;QACZ;QAEA,MAAM,YAAY,WAAW,CAAC,aAAa,iBAAiB,IAAI;QAEhE,sBAAsB;QACtB,MAAM,OAAO,aAAa,oBAAoB;QAC9C,MAAM,WAAW,KAAK,GAAG,CAAC,OAAO,MAAM;QAEvC,OAAO,KAAK,GAAG,CAAC,YAAY,UAAU;IACxC;IAEA,OAAe,uBAAuB,WAAgB,EAAE,OAAY,EAAU;QAC5E,IAAI,QAAQ,IAAI,aAAa;;QAE7B,sBAAsB;QACtB,MAAM,aAAqC;YACzC,OAAO;YACP,OAAO;YACP,QAAQ;YACR,OAAO;YACP,YAAY;QACd;QACA,SAAS,UAAU,CAAC,SAAS,aAAa,IAAI;QAE9C,yCAAyC;QACzC,IAAI,aAAa,cAAc;YAC7B,MAAM,UAAU,OAAO,QAAQ,CAAC,YAAY,YAAY;YACxD,IAAI,CAAC,MAAM,UAAU;gBACnB,SAAS,UAAU;YACrB;QACF;QAEA,OAAO,KAAK,GAAG,CAAC,OAAO;IACzB;IAEA,2BAA2B;IAC3B,OAAe,wBAAwB,WAAgB,EAAE,OAAY,EAAY;QAC/E,MAAM,UAAoB,EAAE;QAC5B,IAAI,SAAS,cAAc,QAAQ,IAAI,CAAC;QACxC,IAAI,aAAa,mBAAmB,QAAQ,IAAI,CAAC;QACjD,IAAI,aAAa,sBAAsB,QAAQ,IAAI,CAAC;QACpD,IAAI,aAAa,WAAW,QAAQ,IAAI,CAAC;QACzC,IAAI,CAAC,aAAa,mBAAmB,QAAQ,IAAI,CAAC;QAClD,IAAI,CAAC,aAAa,sBAAsB,QAAQ,IAAI,CAAC;QACrD,OAAO;IACT;IAEA,OAAe,kBAAkB,WAAgB,EAAY;QAC3D,MAAM,UAAoB,EAAE;QAC5B,MAAM,OAAO,aAAa,oBAAoB;QAC9C,MAAM,SAAS,aAAa,sBAAsB;QAClD,IAAI,OAAO,GAAG,QAAQ,IAAI,CAAC,GAAG,KAAK,iBAAiB,CAAC;QACrD,IAAI,SAAS,GAAG,QAAQ,IAAI,CAAC,GAAG,OAAO,mBAAmB,CAAC;QAC3D,IAAI,SAAS,KAAK,WAAW,GAAG,QAAQ,IAAI,CAAC;QAC7C,OAAO;IACT;IAEA,OAAe,qBAAqB,WAAgB,EAAY;QAC9D,MAAM,UAAoB,EAAE;QAC5B,IAAI,aAAa,mBAAmB,QAAQ,IAAI,CAAC;aAC5C,QAAQ,IAAI,CAAC;QAClB,IAAI,aAAa,WAAW,QAAQ,IAAI,CAAC;aACpC,QAAQ,IAAI,CAAC;QAClB,IAAI,aAAa,sBAAsB,QAAQ,IAAI,CAAC;aAC/C,QAAQ,IAAI,CAAC;QAClB,OAAO;IACT;IAEA,OAAe,qBAAqB,WAAgB,EAAY;QAC9D,MAAM,UAAoB,EAAE;QAC5B,QAAQ,IAAI,CAAC,CAAC,kBAAkB,EAAE,aAAa,oBAAoB,WAAW;QAC9E,MAAM,OAAO,aAAa,oBAAoB;QAC9C,IAAI,OAAO,GAAG,QAAQ,IAAI,CAAC,GAAG,KAAK,mBAAmB,CAAC;QACvD,OAAO;IACT;IAEA,OAAe,mBAAmB,WAAgB,EAAE,OAAY,EAAY;QAC1E,MAAM,UAAoB,EAAE;QAC5B,IAAI,SAAS,cAAc,QAAQ,IAAI,CAAC,CAAC,cAAc,EAAE,QAAQ,YAAY,EAAE;QAC/E,IAAI,aAAa,cAAc,QAAQ,IAAI,CAAC,CAAC,cAAc,EAAE,YAAY,YAAY,EAAE;QACvF,IAAI,aAAa,iBAAiB,QAAQ,IAAI,CAAC,CAAC,iBAAiB,EAAE,YAAY,eAAe,EAAE;QAChG,OAAO;IACT;IAEA,OAAe,uBAAuB,YAAoB,EAAE,WAAgB,EAAE,QAAiB,EAAU;QACvG,IAAI,cAAc,eAAe,IAAI,0BAA0B;;QAE/D,cAAc;QACd,IAAI,aAAa,qBAAqB,YAAY,eAAe;QACjE,IAAI,aAAa,qBAAqB,YAAY,eAAe;QACjE,IAAI,aAAa,qBAAqB,aAAa,sBAAsB,eAAe;QAExF,0BAA0B;QAC1B,OAAO,KAAK,GAAG,CAAC,KAAK,KAAK,GAAG,CAAC,KAAK;IACrC;IAEA,OAAe,+BAA+B,SAA8B,EAAY;QACtF,MAAM,cAAwB,EAAE;QAEhC,IAAI,UAAU,aAAa,CAAC,KAAK,GAAG,KAAK;YACvC,YAAY,IAAI,CAAC;QACnB;QACA,IAAI,UAAU,UAAU,CAAC,KAAK,GAAG,KAAK;YACpC,IAAI,CAAC,UAAU,UAAU,CAAC,OAAO,CAAC,QAAQ,CAAC,yBAAyB;gBAClE,YAAY,IAAI,CAAC;YACnB;YACA,IAAI,CAAC,UAAU,UAAU,CAAC,OAAO,CAAC,QAAQ,CAAC,oBAAoB;gBAC7D,YAAY,IAAI,CAAC;YACnB;QACF;QACA,IAAI,UAAU,UAAU,CAAC,KAAK,GAAG,KAAK;YACpC,YAAY,IAAI,CAAC;QACnB;QACA,IAAI,UAAU,QAAQ,CAAC,KAAK,GAAG,KAAK;YAClC,YAAY,IAAI,CAAC;QACnB;QAEA,OAAO;IACT;AACF"}},
    {"offset": {"line": 4680, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/strategist/prompts/strategist-prompts.ts"],"sourcesContent":["// ============================================\r\n// AI TENDER STRATEGIST - PROMPT BUILDERS\r\n// ============================================\r\n\r\nimport { STRATEGIST_SYSTEM_PROMPT } from \"../constants\"\r\nimport type { StrategistContext, ExperienceLevel, StrategyType } from \"../types\"\r\n\r\n/**\r\n * Build the system prompt with user context\r\n */\r\nexport function buildStrategistPrompt(context: StrategistContext): string {\r\n  let prompt = STRATEGIST_SYSTEM_PROMPT\r\n\r\n  // Add user experience level context\r\n  if (context.user_preferences?.experience_level) {\r\n    const levelInstructions: Record<ExperienceLevel, string> = {\r\n      beginner: `\r\n## User Experience Level: BEGINNER\r\n- Explain concepts in simple terms, avoid jargon\r\n- Provide step-by-step guidance\r\n- Define technical terms when first used\r\n- Be extra supportive and encouraging\r\n- Suggest learning resources when relevant`,\r\n      intermediate: `\r\n## User Experience Level: INTERMEDIATE  \r\n- User has basic tendering knowledge\r\n- Can use technical terminology with brief explanations\r\n- Focus on strategic advice and optimization\r\n- Highlight advanced techniques when relevant`,\r\n      advanced: `\r\n## User Experience Level: ADVANCED\r\n- User is experienced in tendering\r\n- Use technical terminology freely\r\n- Focus on strategic optimization and edge cases\r\n- Provide nuanced, detailed analysis\r\n- Discuss advanced strategies and market insights`,\r\n    }\r\n    prompt += levelInstructions[context.user_preferences.experience_level]\r\n  }\r\n\r\n  // Add user profile context\r\n  if (context.user_preferences || context.company_profile) {\r\n    prompt += `\r\n\r\n## User Profile Context`\r\n\r\n    if (context.company_profile?.company_name) {\r\n      prompt += `\r\nCompany: ${context.company_profile.company_name}`\r\n    }\r\n    if (context.company_profile?.industry) {\r\n      prompt += `\r\nIndustry: ${context.company_profile.industry}`\r\n    }\r\n    if (context.user_preferences?.provinces?.length) {\r\n      prompt += `\r\nRegions: ${context.user_preferences.provinces.join(\", \")}`\r\n    }\r\n    if (context.user_preferences?.cidb_grading) {\r\n      prompt += `\r\nCIDB Grading: ${context.user_preferences.cidb_grading}`\r\n    }\r\n    if (context.user_preferences?.bee_level || context.company_profile?.bee_status) {\r\n      prompt += `\r\nB-BBEE Status: ${context.user_preferences?.bee_level || context.company_profile?.bee_status}`\r\n    }\r\n  }\r\n\r\n  // Add compliance status\r\n  if (context.user_preferences) {\r\n    const complianceItems: string[] = []\r\n    if (context.user_preferences.has_tax_clearance) {\r\n      complianceItems.push(\r\n        `Tax Clearance: Valid${context.user_preferences.tax_clearance_expiry ? ` (expires ${context.user_preferences.tax_clearance_expiry})` : \"\"}`,\r\n      )\r\n    } else {\r\n      complianceItems.push(\"Tax Clearance: Missing/Expired\")\r\n    }\r\n    if (context.user_preferences.has_coida) {\r\n      complianceItems.push(\r\n        `COIDA: Valid${context.user_preferences.coida_expiry ? ` (expires ${context.user_preferences.coida_expiry})` : \"\"}`,\r\n      )\r\n    } else {\r\n      complianceItems.push(\"COIDA: Missing\")\r\n    }\r\n    if (context.user_preferences.has_csd_registration) {\r\n      complianceItems.push(\"CSD Registration: Active\")\r\n    } else {\r\n      complianceItems.push(\"CSD Registration: Missing\")\r\n    }\r\n\r\n    if (complianceItems.length > 0) {\r\n      prompt += `\r\n\r\n## Compliance Status\r\n${complianceItems.join(\"\\n\")}`\r\n    }\r\n  }\r\n\r\n  // Add tender context if present\r\n  if (context.tender_context) {\r\n    prompt += `\r\n\r\n## Current Tender Context\r\nTitle: ${context.tender_context.title}\r\nOrganization: ${context.tender_context.organization}\r\n${context.tender_context.description ? `Description: ${context.tender_context.description}` : \"\"}\r\n${context.tender_context.close_date ? `Closing Date: ${context.tender_context.close_date}` : \"\"}\r\n\r\nWhen answering, reference this specific tender and provide targeted advice.`\r\n  }\r\n\r\n  // Add BOQ context if present\r\n  if (context.boq_context) {\r\n    prompt += `\r\n\r\n## BOQ Context\r\nThis conversation is about pricing/BOQ for a tender with ${context.boq_context.total_items} line items.\r\nFocus on pricing strategy, margin recommendations, and risk assessment.`\r\n  }\r\n\r\n  // Add competitiveness score if available\r\n  if (context.competitiveness_score) {\r\n    prompt += `\r\n\r\n## User's Current Competitiveness Score\r\nOverall: ${(context.competitiveness_score.overall_score * 100).toFixed(0)}%\r\n- Documentation: ${(context.competitiveness_score.documentation_score * 100).toFixed(0)}%\r\n- Compliance: ${(context.competitiveness_score.compliance_score * 100).toFixed(0)}%\r\n- Experience: ${(context.competitiveness_score.experience_score * 100).toFixed(0)}%\r\n\r\nUse this to tailor advice about improving their competitiveness.`\r\n  }\r\n\r\n  return prompt\r\n}\r\n\r\n/**\r\n * Build prompt for strategy generation\r\n */\r\nexport function buildStrategyGenerationPrompt(\r\n  strategyType: StrategyType,\r\n  tenderAnalysis: Record<string, any>,\r\n  userContext: StrategistContext,\r\n): string {\r\n  const basePrompt = `Generate a comprehensive ${strategyType} strategy for this tender submission.\r\n\r\n## Tender Information\r\n${JSON.stringify(tenderAnalysis.tender_summary || {}, null, 2)}\r\n\r\n## Evaluation Criteria\r\n${JSON.stringify(tenderAnalysis.evaluation || {}, null, 2)}\r\n\r\n## Compliance Requirements\r\n${JSON.stringify(tenderAnalysis.compliance_summary || {}, null, 2)}\r\n\r\n## User's Current Capabilities\r\n${\r\n  userContext.user_preferences\r\n    ? JSON.stringify(\r\n        {\r\n          cidb_grading: userContext.user_preferences.cidb_grading,\r\n          bee_level: userContext.user_preferences.bee_level,\r\n          experience_level: userContext.user_preferences.experience_level,\r\n          past_wins: userContext.user_preferences.past_tender_wins,\r\n          past_losses: userContext.user_preferences.past_tender_losses,\r\n        },\r\n        null,\r\n        2,\r\n      )\r\n    : \"Not available\"\r\n}\r\n\r\n## Company Profile\r\n${userContext.company_profile ? JSON.stringify(userContext.company_profile, null, 2) : \"Not available\"}`\r\n\r\n  const strategyInstructions: Record<StrategyType, string> = {\r\n    bid: `\r\nGenerate a complete bid strategy including:\r\n1. Bid viability analysis (should we bid?)\r\n2. SWOT analysis for this tender\r\n3. Compliance checklist with status\r\n4. Supplier/subcontractor recommendations\r\n5. Pricing strategy overview\r\n6. Submission checklist\r\n7. Risk register with mitigation plans\r\n8. Win probability assessment`,\r\n\r\n    pricing: `\r\nGenerate a detailed pricing strategy including:\r\n1. Recommended pricing approach (cost-plus, competitive, value)\r\n2. Margin recommendations by item category\r\n3. Risk pricing factors\r\n4. Competitive positioning advice\r\n5. Areas for cost optimization\r\n6. Contingency recommendations\r\n7. Payment term considerations\r\n8. Potential price negotiation points`,\r\n\r\n    compliance: `\r\nGenerate a compliance strategy including:\r\n1. All mandatory requirements mapped to user capabilities\r\n2. Gap analysis with remediation actions\r\n3. Document checklist with deadlines\r\n4. Risk of non-compliance assessment\r\n5. Alternative compliance approaches\r\n6. Certification/registration requirements\r\n7. Timeline for compliance preparation`,\r\n\r\n    negotiation: `\r\nGenerate a negotiation strategy including:\r\n1. Key negotiation points\r\n2. Best Alternative to Negotiated Agreement (BATNA)\r\n3. Concession strategy\r\n4. Value propositions to emphasize\r\n5. Potential objections and responses\r\n6. Win-win opportunities\r\n7. Relationship building approaches`,\r\n\r\n    general: `\r\nGenerate a general tender strategy overview including:\r\n1. Executive summary\r\n2. Key success factors\r\n3. Resource requirements\r\n4. Timeline and milestones\r\n5. Team responsibilities\r\n6. Risk overview\r\n7. Go/No-Go recommendation`,\r\n  }\r\n\r\n  return (\r\n    basePrompt +\r\n    strategyInstructions[strategyType] +\r\n    `\r\n\r\nRespond with a valid JSON object matching the StrategyContent interface with all sections populated.\r\nBe specific, actionable, and realistic in your recommendations.\r\nReference actual tender requirements and user capabilities.`\r\n  )\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4886, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/strategist/index.ts"],"sourcesContent":["// ============================================\r\n// AI TENDER STRATEGIST ENGINE - MAIN ENTRY\r\n// ============================================\r\n\r\nexport * from \"./types\"\r\nexport * from \"./constants\"\r\n\r\n// Services\r\nexport { StrategistService } from \"./services/strategist-service\"\r\nexport { OpportunityService } from \"./services/opportunity-service\"\r\nexport { LearningService } from \"./services/learning-service\"\r\nexport { AlertService } from \"./services/alert-service\"\r\nexport { CompetitivenessService } from \"./services/competitiveness-service\"\r\n\r\n// Prompts\r\nexport { buildStrategistPrompt, buildStrategyGenerationPrompt } from \"./prompts/strategist-prompts\"\r\n"],"names":[],"mappings":"AAAA,+CAA+C;AAC/C,2CAA2C;AAC3C,+CAA+C;;AAE/C;AACA;AAEA,WAAW;AACX;AACA;AACA;AACA;AACA;AAEA,UAAU;AACV"}},
    {"offset": {"line": 4912, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/lib/engines/orchestrator/index.ts"],"sourcesContent":["// ============================================\r\n// ENGINE ORCHESTRATOR - CENTRAL INTEGRATION\r\n// ============================================\r\n\r\nimport { processDocument } from \"../documind\"\r\nimport { TenderService, validateTender, normalizeTenderData } from \"../tenders\"\r\nimport { OpportunityService, CompetitivenessService, StrategistService } from \"../strategist\"\r\nimport type { ScrapedTender } from \"../../scrapers/base-scraper\"\r\nimport type { ParsedDocument } from \"../documind/types\"\r\n// Tender types: use existing TenderValidationResult from tenders; keep TenderData as any for now\r\ntype TenderData = any\r\nimport type { TenderValidationResult as ValidationResult } from \"../tenders/types\"\r\n\r\nexport interface EngineOrchestrator {\r\n  processScrapedTender(tender: ScrapedTender): Promise<ProcessedTenderResult>\r\n  processUploadedDocument(file: ArrayBuffer, mimeType: string, userId: string): Promise<ProcessedDocumentResult>\r\n  enrichTenderWithStrategy(\r\n    tenderId: string,\r\n    tenderType: \"custom\" | \"scraped\",\r\n    userId: string,\r\n  ): Promise<StrategyEnrichmentResult>\r\n}\r\n\r\nexport interface ProcessedTenderResult {\r\n  success: boolean\r\n  tender?: TenderData\r\n  validation?: ValidationResult\r\n  documents?: ParsedDocument[]\r\n  opportunities?: any[]\r\n  error?: string\r\n}\r\n\r\nexport interface ProcessedDocumentResult {\r\n  success: boolean\r\n  document?: ParsedDocument\r\n  extractedTenderData?: TenderData\r\n  validation?: ValidationResult\r\n  error?: string\r\n}\r\n\r\nexport interface StrategyEnrichmentResult {\r\n  success: boolean\r\n  competitiveness?: any\r\n  opportunities?: any[]\r\n  recommendations?: string[]\r\n  error?: string\r\n}\r\n\r\n/**\r\n * Orchestrates all engines to work together seamlessly\r\n */\r\nexport class EngineOrchestrator {\r\n  // Services expose static methods; call them directly (no instances required)\r\n\r\n  /**\r\n   * Process a scraped tender through all engines\r\n   * Flow: Tenders Engine (validate/normalize) -> Documind (process docs) -> Strategist (analyze)\r\n   */\r\n  async processScrapedTender(tender: ScrapedTender, userId?: string): Promise<ProcessedTenderResult> {\r\n    try {\r\n      console.log(\"[v0] Orchestrator: Processing scraped tender:\", tender.title)\r\n\r\n      // Step 1: Tenders Engine - Validate and normalize\r\n      console.log(\"[v0] Orchestrator: Step 1 - Validating tender data...\")\r\n      const validation = validateTender(tender)\r\n\r\n      console.log(\"[v0] Orchestrator: Validation result:\", {\r\n        score: validation.score,\r\n        isValid: validation.isValid,\r\n        errors: validation.errors?.length || 0,\r\n      })\r\n\r\n      console.log(\r\n        `[v0] Orchestrator: Processing tender - Score: ${validation.score}`,\r\n      )\r\n\r\n      const normalizedTender = normalizeTenderData(tender)\r\n\r\n      // Step 2: Documind Engine - Process documents if available\r\n      const processedDocuments: ParsedDocument[] = []\r\n      if (tender.document_urls && tender.document_urls.length > 0) {\r\n        console.log(`[v0] Orchestrator: Step 2 - Processing ${tender.document_urls.length} documents...`)\r\n\r\n        for (const docUrl of tender.document_urls.slice(0, 3)) {\r\n          // Limit to 3 docs for performance\r\n          try {\r\n            const url = typeof docUrl === \"string\" ? docUrl : docUrl.url\r\n            const response = await fetch(url)\r\n            const buffer = await response.arrayBuffer()\r\n\r\n            const result = await processDocument(buffer, \"application/pdf\", {\r\n              extract_images: false,\r\n              ocr_enabled: true,\r\n            })\r\n\r\n            if (result.success && result.document) {\r\n              processedDocuments.push(result.document)\r\n              console.log(`[v0] Orchestrator: Document processed successfully: ${url}`)\r\n            }\r\n          } catch (docError) {\r\n            console.error(\"[v0] Orchestrator: Document processing failed:\", docError)\r\n          }\r\n        }\r\n      }\r\n\r\n      // Step 3: Strategist Engine - Create opportunities if user provided\r\n      const opportunities: any[] = []\r\n      if (userId) {\r\n        console.log(\"[v0] Orchestrator: Step 3 - Analyzing opportunities for user...\")\r\n\r\n        try {\r\n          const opportunity = await OpportunityService.createOpportunity({\r\n            userId,\r\n            tenderId: tender.scraped_tender_id || tender.tender_reference || \"\",\r\n            tenderType: \"scraped\",\r\n            tenderTitle: normalizedTender.title,\r\n            tenderData: normalizedTender,\r\n          })\r\n\r\n          if (opportunity) {\r\n            opportunities.push(opportunity)\r\n            console.log(`[v0] Orchestrator: Opportunity created with score: ${opportunity.match_score}`)\r\n          }\r\n        } catch (oppError) {\r\n          console.error(\"[v0] Orchestrator: Opportunity creation failed:\", oppError)\r\n        }\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        tender: normalizedTender,\r\n        validation,\r\n        documents: processedDocuments,\r\n        opportunities,\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[v0] Orchestrator: Error processing scraped tender:\", error)\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : \"Unknown error\",\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process an uploaded document through all engines\r\n   * Flow: Documind (extract) -> Tenders Engine (validate/normalize) -> Strategist (analyze)\r\n   */\r\n  async processUploadedDocument(file: ArrayBuffer, mimeType: string, userId: string): Promise<ProcessedDocumentResult> {\r\n    try {\r\n      console.log(\"[v0] Orchestrator: Processing uploaded document\")\r\n\r\n      // Step 1: Documind Engine - Extract content and fields\r\n      console.log(\"[v0] Orchestrator: Step 1 - Extracting document content...\")\r\n      const docResult = await processDocument(file, mimeType, {\r\n        extract_images: false,\r\n        ocr_enabled: true,\r\n      })\r\n\r\n      if (!docResult.success || !docResult.document) {\r\n        return {\r\n          success: false,\r\n          error: docResult.error?.message || \"Document processing failed\",\r\n        }\r\n      }\r\n\r\n      const document = docResult.document\r\n      console.log(\r\n        `[v0] Orchestrator: Document processed - ${document.pages.length} pages, ${document.form_fields?.length || 0} form fields`,\r\n      )\r\n\r\n      // Step 2: Tenders Engine - Extract tender data from document\r\n      console.log(\"[v0] Orchestrator: Step 2 - Extracting tender data from document...\")\r\n      const extractedTender = await TenderService.extractTenderFromDocument(document)\r\n\r\n      if (!extractedTender) {\r\n        console.warn(\"[v0] Orchestrator: Could not extract tender data from document\")\r\n        return {\r\n          success: true,\r\n          document,\r\n          error: \"Could not identify tender fields in document\",\r\n        }\r\n      }\r\n\r\n      // Step 3: Tenders Engine - Validate extracted data\r\n      console.log(\"[v0] Orchestrator: Step 3 - Validating extracted tender data...\")\r\n      const validation = validateTender(extractedTender)\r\n      const normalizedTender = normalizeTenderData(extractedTender)\r\n\r\n      console.log(\r\n        `[v0] Orchestrator: Tender extracted - Score: ${validation.score}`,\r\n      )\r\n\r\n      return {\r\n        success: true,\r\n        document,\r\n        extractedTenderData: normalizedTender,\r\n        validation,\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[v0] Orchestrator: Error processing uploaded document:\", error)\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : \"Unknown error\",\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enrich a tender with strategic analysis\r\n   * Flow: Strategist Engine (competitiveness + recommendations)\r\n   */\r\n  async enrichTenderWithStrategy(\r\n    tenderId: string,\r\n    tenderType: \"custom\" | \"scraped\",\r\n    userId: string,\r\n  ): Promise<StrategyEnrichmentResult> {\r\n    try {\r\n      console.log(`[v0] Orchestrator: Enriching tender ${tenderId} with strategy for user ${userId}`)\r\n\r\n      // Step 1: Calculate competitiveness score\r\n      console.log(\"[v0] Orchestrator: Step 1 - Calculating competitiveness...\")\r\n      const competitiveness = await CompetitivenessService.calculateScore({\r\n        userId,\r\n        tenderId,\r\n        tenderType,\r\n      })\r\n\r\n      // Step 2: Generate recommendations\r\n      console.log(\"[v0] Orchestrator: Step 2 - Generating strategic recommendations...\")\r\n      const recommendations = await StrategistService.generateRecommendations({\r\n        userId,\r\n        tenderId,\r\n        tenderType,\r\n        competitiveness,\r\n      })\r\n\r\n      // Step 3: Find related opportunities\r\n      console.log(\"[v0] Orchestrator: Step 3 - Finding related opportunities...\")\r\n      const opportunities = await OpportunityService.findSimilar({\r\n        userId,\r\n        tenderId,\r\n        tenderType,\r\n      })\r\n\r\n      return {\r\n        success: true,\r\n        competitiveness,\r\n        opportunities,\r\n        recommendations,\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[v0] Orchestrator: Error enriching tender with strategy:\", error)\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : \"Unknown error\",\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const engineOrchestrator = new EngineOrchestrator()\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5105, "column": 0}, "map": {"version":3,"sources":["file:///C:/Repo/LogsOfN/v0-bid-mate-ai/app/api/test/orchestrator/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\r\nimport { engineOrchestrator } from \"@/lib/engines/orchestrator\"\r\n\r\nexport async function GET() {\r\n  try {\r\n    console.log(\"[v0] Test Orchestrator: running smoke test\")\r\n\r\n    const mockTender = {\r\n      tender_reference: `TEST-${Date.now()}`,\r\n      title: \"Test Tender for Orchestrator\",\r\n      description: \"This is a synthetic tender used for smoke testing the orchestrator\",\r\n    }\r\n\r\n    const result = await engineOrchestrator.processScrapedTender(mockTender as any)\r\n\r\n    return NextResponse.json({ success: true, result })\r\n  } catch (error) {\r\n    console.error(\"[v0] Test Orchestrator: error\", error)\r\n    return NextResponse.json({ success: false, error: error instanceof Error ? error.message : String(error) }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe;IACpB,IAAI;QACF,QAAQ,GAAG,CAAC;QAEZ,MAAM,aAAa;YACjB,kBAAkB,CAAC,KAAK,EAAE,KAAK,GAAG,IAAI;YACtC,OAAO;YACP,aAAa;QACf;QAEA,MAAM,SAAS,MAAM,+JAAkB,CAAC,oBAAoB,CAAC;QAE7D,OAAO,sPAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM;QAAO;IACnD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iCAAiC;QAC/C,OAAO,sPAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG,OAAO;QAAO,GAAG;YAAE,QAAQ;QAAI;IAC5H;AACF"}}]
}