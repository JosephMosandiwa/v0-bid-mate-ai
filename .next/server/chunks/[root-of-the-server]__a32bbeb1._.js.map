{"version":3,"sources":["../../../lib/engines/tenders/schema.ts","../../../lib/engines/tenders/validator.ts","../../../lib/engines/tenders/services/tender-service.ts","../../../lib/engines/tenders/index.ts","../../../lib/engines/orchestrator/index.ts","../../../lib/services/scraping-service.ts","../../../lib/services/document-service.ts"],"sourcesContent":["import type { TenderField, TenderSchema } from \"./types\"\r\n\r\n// Central tender schema - this is what scrapers should aim to extract\r\nexport const TENDER_SCHEMA: TenderSchema = {\r\n  version: \"1.0.0\",\r\n  requiredFields: [\"title\", \"organization\"],\r\n  optionalFields: [\r\n    \"tender_reference\",\r\n    \"close_date\",\r\n    \"description\",\r\n    \"category\",\r\n    \"location\",\r\n    \"estimated_value\",\r\n    \"publish_date\",\r\n    \"opening_date\",\r\n    \"contact_person\",\r\n    \"contact_email\",\r\n    \"contact_phone\",\r\n    \"submission_method\",\r\n    \"requirements\",\r\n    \"eligibility_criteria\",\r\n    \"payment_terms\",\r\n    \"contract_duration\",\r\n    \"compulsory_briefing\",\r\n    \"tender_type\",\r\n    \"procurement_category\",\r\n  ],\r\n  documentTypes: [\r\n    \"Tender Document\",\r\n    \"Terms of Reference\",\r\n    \"Specifications\",\r\n    \"Pricing Schedule\",\r\n    \"SBD Forms\",\r\n    \"Declaration Forms\",\r\n    \"Technical Requirements\",\r\n    \"Contract Terms\",\r\n  ],\r\n  fields: [\r\n    {\r\n      name: \"tender_reference\",\r\n      displayName: \"Tender Reference Number\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Unique identifier for the tender\",\r\n      extractionHints: {\r\n        aliases: [\"tender number\", \"reference\", \"tender no\", \"ref no\", \"reference number\", \"tender id\"],\r\n        patterns: [\"\\\\b[A-Z]{2,}[\\\\/-]?\\\\d{2,}[\\\\/-]?\\\\d{2,}\\\\b\", \"\\\\bT\\\\d{4,}\\\\b\", \"\\\\b\\\\d{2,}\\\\/\\\\d{4}\\\\b\"],\r\n        context: [\"reference\", \"tender\", \"number\", \"quotation\"],\r\n        priority: 10,\r\n      },\r\n    },\r\n    {\r\n      name: \"title\",\r\n      displayName: \"Tender Title\",\r\n      type: \"string\",\r\n      required: true,\r\n      description: \"The main title or subject of the tender\",\r\n      extractionHints: {\r\n        aliases: [\"tender title\", \"subject\", \"project name\", \"tender for\"],\r\n        patterns: [],\r\n        context: [\"tender\", \"project\", \"supply\", \"services\", \"appointment\"],\r\n        priority: 10,\r\n      },\r\n    },\r\n    {\r\n      name: \"organization\",\r\n      displayName: \"Issuing Organization\",\r\n      type: \"string\",\r\n      required: true,\r\n      description: \"The organization issuing the tender\",\r\n      extractionHints: {\r\n        aliases: [\"organization\", \"department\", \"municipality\", \"entity\", \"client\", \"issuer\"],\r\n        patterns: [],\r\n        context: [\"municipality\", \"department\", \"ministry\", \"council\"],\r\n        priority: 9,\r\n      },\r\n    },\r\n    {\r\n      name: \"description\",\r\n      displayName: \"Description\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Detailed description of what is being procured\",\r\n      extractionHints: {\r\n        aliases: [\"description\", \"scope\", \"scope of work\", \"requirements\", \"details\"],\r\n        patterns: [],\r\n        context: [\"scope\", \"required\", \"must\", \"shall\", \"includes\"],\r\n        priority: 8,\r\n      },\r\n    },\r\n    {\r\n      name: \"category\",\r\n      displayName: \"Category\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"The procurement category or sector\",\r\n      extractionHints: {\r\n        aliases: [\"category\", \"sector\", \"type\", \"classification\"],\r\n        patterns: [],\r\n        context: [\"construction\", \"it\", \"services\", \"goods\", \"works\"],\r\n        priority: 7,\r\n      },\r\n    },\r\n    {\r\n      name: \"location\",\r\n      displayName: \"Location\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Physical location or province\",\r\n      extractionHints: {\r\n        aliases: [\"location\", \"province\", \"region\", \"area\", \"place\"],\r\n        patterns: [\r\n          \"Gauteng|Western Cape|Eastern Cape|KwaZulu-Natal|Free State|Limpopo|Mpumalanga|Northern Cape|North West\",\r\n        ],\r\n        context: [\"province\", \"located\", \"region\"],\r\n        priority: 6,\r\n      },\r\n    },\r\n    {\r\n      name: \"estimated_value\",\r\n      displayName: \"Estimated Value\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"The estimated contract value\",\r\n      extractionHints: {\r\n        aliases: [\"value\", \"budget\", \"amount\", \"contract value\", \"estimated cost\"],\r\n        patterns: [\"R\\\\s?[\\\\d,]+\", \"ZAR\\\\s?[\\\\d,]+\"],\r\n        context: [\"value\", \"budget\", \"rand\", \"amount\"],\r\n        priority: 8,\r\n      },\r\n    },\r\n    {\r\n      name: \"publish_date\",\r\n      displayName: \"Publish Date\",\r\n      type: \"date\",\r\n      required: false,\r\n      description: \"When the tender was published\",\r\n      extractionHints: {\r\n        aliases: [\"publish date\", \"publication date\", \"advertised\", \"issued date\"],\r\n        patterns: [\"\\\\d{1,2}[\\\\/-]\\\\d{1,2}[\\\\/-]\\\\d{2,4}\", \"\\\\d{4}[\\\\/-]\\\\d{2}[\\\\/-]\\\\d{2}\"],\r\n        context: [\"published\", \"advertised\", \"issued\"],\r\n        priority: 5,\r\n      },\r\n    },\r\n    {\r\n      name: \"close_date\",\r\n      displayName: \"Closing Date\",\r\n      type: \"date\",\r\n      required: false,\r\n      description: \"Submission deadline\",\r\n      validationRules: {\r\n        format: \"ISO8601\",\r\n      },\r\n      extractionHints: {\r\n        aliases: [\"closing date\", \"deadline\", \"submission date\", \"due date\", \"closes\"],\r\n        patterns: [\"\\\\d{1,2}[\\\\/-]\\\\d{1,2}[\\\\/-]\\\\d{2,4}\", \"\\\\d{4}[\\\\/-]\\\\d{2}[\\\\/-]\\\\d{2}\"],\r\n        context: [\"closing\", \"deadline\", \"closes\", \"due\"],\r\n        priority: 10,\r\n      },\r\n    },\r\n    {\r\n      name: \"opening_date\",\r\n      displayName: \"Opening Date\",\r\n      type: \"date\",\r\n      required: false,\r\n      description: \"When bids will be opened\",\r\n      extractionHints: {\r\n        aliases: [\"opening date\", \"bid opening\", \"tender opening\"],\r\n        patterns: [\"\\\\d{1,2}[\\\\/-]\\\\d{1,2}[\\\\/-]\\\\d{2,4}\", \"\\\\d{4}[\\\\/-]\\\\d{2}[\\\\/-]\\\\d{2}\"],\r\n        context: [\"opening\", \"bids will be opened\"],\r\n        priority: 4,\r\n      },\r\n    },\r\n    {\r\n      name: \"contact_person\",\r\n      displayName: \"Contact Person\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Name of contact person\",\r\n      extractionHints: {\r\n        aliases: [\"contact person\", \"contact\", \"enquiries\", \"contact name\"],\r\n        patterns: [\"[A-Z][a-z]+\\\\s+[A-Z][a-z]+\"],\r\n        context: [\"contact\", \"enquiries\", \"person\"],\r\n        priority: 5,\r\n      },\r\n    },\r\n    {\r\n      name: \"contact_email\",\r\n      displayName: \"Contact Email\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Email address for enquiries\",\r\n      validationRules: {\r\n        pattern: \"^[^\\\\s@]+@[^\\\\s@]+\\\\.[^\\\\s@]+$\",\r\n      },\r\n      extractionHints: {\r\n        aliases: [\"email\", \"e-mail\", \"email address\"],\r\n        patterns: [\"[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\\\.[a-zA-Z]{2,}\"],\r\n        context: [\"email\", \"contact\", \"enquiries\"],\r\n        priority: 6,\r\n      },\r\n    },\r\n    {\r\n      name: \"contact_phone\",\r\n      displayName: \"Contact Phone\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Phone number for enquiries\",\r\n      extractionHints: {\r\n        aliases: [\"phone\", \"telephone\", \"tel\", \"contact number\"],\r\n        patterns: [\"\\\\+?27\\\\s?\\\\d{2}\\\\s?\\\\d{3}\\\\s?\\\\d{4}\", \"$$?0\\\\d{2}$$?\\\\s?\\\\d{3}\\\\s?\\\\d{4}\"],\r\n        context: [\"phone\", \"tel\", \"contact\", \"call\"],\r\n        priority: 5,\r\n      },\r\n    },\r\n    {\r\n      name: \"requirements\",\r\n      displayName: \"Requirements\",\r\n      type: \"array\",\r\n      required: false,\r\n      description: \"List of tender requirements\",\r\n      extractionHints: {\r\n        aliases: [\"requirements\", \"mandatory requirements\", \"prerequisites\", \"must have\"],\r\n        patterns: [],\r\n        context: [\"required\", \"must\", \"mandatory\", \"compulsory\"],\r\n        priority: 7,\r\n      },\r\n    },\r\n    {\r\n      name: \"eligibility_criteria\",\r\n      displayName: \"Eligibility Criteria\",\r\n      type: \"array\",\r\n      required: false,\r\n      description: \"Who can bid\",\r\n      extractionHints: {\r\n        aliases: [\"eligibility\", \"eligible\", \"who may bid\", \"qualification criteria\"],\r\n        patterns: [],\r\n        context: [\"eligible\", \"may bid\", \"qualified\", \"registration\"],\r\n        priority: 6,\r\n      },\r\n    },\r\n    {\r\n      name: \"compulsory_briefing\",\r\n      displayName: \"Compulsory Briefing\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Information about mandatory briefing sessions\",\r\n      extractionHints: {\r\n        aliases: [\"compulsory briefing\", \"mandatory briefing\", \"site visit\", \"pre-bid meeting\"],\r\n        patterns: [],\r\n        context: [\"compulsory\", \"mandatory\", \"briefing\", \"meeting\", \"site\"],\r\n        priority: 7,\r\n      },\r\n    },\r\n    {\r\n      name: \"tender_type\",\r\n      displayName: \"Tender Type\",\r\n      type: \"string\",\r\n      required: false,\r\n      description: \"Type of procurement (RFQ, RFP, etc)\",\r\n      extractionHints: {\r\n        aliases: [\"tender type\", \"procurement type\", \"bid type\"],\r\n        patterns: [\"RFQ|RFP|RFI|ITB|EOI\"],\r\n        context: [\"request for\", \"quotation\", \"proposal\"],\r\n        priority: 5,\r\n      },\r\n    },\r\n  ],\r\n}\r\n\r\n// Function to get field by name\r\nexport function getTenderField(fieldName: string): TenderField | undefined {\r\n  return TENDER_SCHEMA.fields.find((f) => f.name === fieldName)\r\n}\r\n\r\n// Function to get required fields\r\nexport function getRequiredFields(): TenderField[] {\r\n  return TENDER_SCHEMA.fields.filter((f) => f.required)\r\n}\r\n\r\n// Function to get all field extraction hints for scraping\r\nexport function getAllExtractionHints() {\r\n  return TENDER_SCHEMA.fields.map((field) => ({\r\n    field: field.name,\r\n    displayName: field.displayName,\r\n    ...field.extractionHints,\r\n  }))\r\n}\r\n","import { TENDER_SCHEMA } from \"./schema\"\r\nimport type { TenderValidationResult } from \"./types\"\r\n\r\nexport class TenderValidator {\r\n  static validate(tenderData: any): TenderValidationResult {\r\n    const errors: TenderValidationResult[\"errors\"] = []\r\n    const warnings: string[] = []\r\n    const missingFields: string[] = []\r\n\r\n    // Check required fields\r\n    for (const fieldName of TENDER_SCHEMA.requiredFields) {\r\n      if (!tenderData[fieldName] || tenderData[fieldName] === \"\") {\r\n        errors.push({\r\n          field: fieldName,\r\n          message: `Required field '${fieldName}' is missing or empty`,\r\n          severity: \"error\",\r\n        })\r\n        missingFields.push(fieldName)\r\n      }\r\n    }\r\n\r\n    // Check optional fields for completeness\r\n    for (const fieldName of TENDER_SCHEMA.optionalFields) {\r\n      if (!tenderData[fieldName] || tenderData[fieldName] === \"\") {\r\n        warnings.push(`Optional field '${fieldName}' is missing - tender may be incomplete`)\r\n        missingFields.push(fieldName)\r\n      }\r\n    }\r\n\r\n    // Validate field formats\r\n    const emailField = tenderData.contact_email\r\n    if (emailField && !this.isValidEmail(emailField)) {\r\n      errors.push({\r\n        field: \"contact_email\",\r\n        message: \"Invalid email format\",\r\n        severity: \"warning\",\r\n      })\r\n    }\r\n\r\n    // Calculate completeness score\r\n    const totalFields = TENDER_SCHEMA.requiredFields.length + TENDER_SCHEMA.optionalFields.length\r\n    const filledFields = totalFields - missingFields.length\r\n    const score = Math.round((filledFields / totalFields) * 100)\r\n\r\n    return {\r\n      isValid: errors.filter((e) => e.severity === \"error\").length === 0,\r\n      score,\r\n      errors,\r\n      missingFields,\r\n      warnings,\r\n    }\r\n  }\r\n\r\n  private static isValidEmail(email: string): boolean {\r\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/\r\n    return emailRegex.test(email)\r\n  }\r\n\r\n  // Get a quality score for a tender based on completeness\r\n  static getQualityScore(tenderData: any): {\r\n    score: number\r\n    grade: string\r\n    feedback: string[]\r\n  } {\r\n    const validation = this.validate(tenderData)\r\n    const feedback: string[] = []\r\n\r\n    if (validation.score === 100) {\r\n      feedback.push(\"✓ All fields populated\")\r\n    } else if (validation.score >= 80) {\r\n      feedback.push(\"✓ Most important fields populated\")\r\n    } else if (validation.score >= 60) {\r\n      feedback.push(\"⚠ Missing some important information\")\r\n    } else {\r\n      feedback.push(\"✗ Tender data is incomplete\")\r\n    }\r\n\r\n    if (validation.missingFields.includes(\"tender_reference\")) {\r\n      feedback.push(\"✗ Missing tender reference number\")\r\n    }\r\n    if (validation.missingFields.includes(\"close_date\")) {\r\n      feedback.push(\"✗ Missing closing date\")\r\n    }\r\n    if (validation.missingFields.includes(\"contact_email\")) {\r\n      feedback.push(\"⚠ No contact email found\")\r\n    }\r\n    if (validation.missingFields.includes(\"estimated_value\")) {\r\n      feedback.push(\"⚠ No tender value information\")\r\n    }\r\n\r\n    const grade =\r\n      validation.score >= 90\r\n        ? \"A\"\r\n        : validation.score >= 80\r\n          ? \"B\"\r\n          : validation.score >= 70\r\n            ? \"C\"\r\n            : validation.score >= 60\r\n              ? \"D\"\r\n              : \"F\"\r\n\r\n    return {\r\n      score: validation.score,\r\n      grade,\r\n      feedback,\r\n    }\r\n  }\r\n}\r\n","import { TENDER_SCHEMA, getAllExtractionHints } from \"../schema\"\r\nimport { TenderValidator } from \"../validator\"\r\nimport type { ParsedDocument } from \"../../documind/types\"\r\n\r\nexport class TenderService {\r\n  // Get the complete tender schema for scrapers to use\r\n  static getTenderSchema() {\r\n    return TENDER_SCHEMA\r\n  }\r\n\r\n  // Get extraction hints for intelligent scraping\r\n  static getExtractionHints() {\r\n    return getAllExtractionHints()\r\n  }\r\n\r\n  // Validate a scraped tender\r\n  static validateTender(tenderData: any) {\r\n    return TenderValidator.validate(tenderData)\r\n  }\r\n\r\n  // Get quality metrics for a tender\r\n  static getTenderQuality(tenderData: any) {\r\n    return TenderValidator.getQualityScore(tenderData)\r\n  }\r\n\r\n  // Map scraped data to standard tender format\r\n  static normalizeScrapedData(rawData: any): any {\r\n    const normalized: any = {}\r\n\r\n    // Map each field from the schema\r\n    for (const field of TENDER_SCHEMA.fields) {\r\n      // Try to find the field using its name or aliases\r\n      let value = rawData[field.name]\r\n\r\n      if (!value) {\r\n        // Try aliases\r\n        for (const alias of field.extractionHints.aliases) {\r\n          const aliasKey = Object.keys(rawData).find((key) => key.toLowerCase() === alias.toLowerCase())\r\n          if (aliasKey) {\r\n            value = rawData[aliasKey]\r\n            break\r\n          }\r\n        }\r\n      }\r\n\r\n      if (value) {\r\n        normalized[field.name] = value\r\n      }\r\n    }\r\n\r\n    return normalized\r\n  }\r\n\r\n  static async extractTenderFromDocument(document: ParsedDocument): Promise<any | null> {\r\n    console.log(\"[v0] TenderService: Extracting tender data from document\")\r\n\r\n    const extractedData: any = {}\r\n    const allText = document.pages.map((p) => p.content.full_text).join(\"\\n\")\r\n\r\n    // Use extraction hints to find tender fields in document\r\n    for (const field of TENDER_SCHEMA.fields) {\r\n      const hints = field.extractionHints\r\n\r\n      // Try regex patterns\r\n      for (const pattern of hints.patterns) {\r\n        const regex = new RegExp(pattern, \"i\")\r\n        const match = allText.match(regex)\r\n        if (match && match[1]) {\r\n          extractedData[field.name] = match[1].trim()\r\n          console.log(`[v0] TenderService: Found ${field.name}: ${extractedData[field.name]}`)\r\n          break\r\n        }\r\n      }\r\n\r\n      // If not found, try context-based extraction\r\n      if (!extractedData[field.name]) {\r\n        for (const contextWord of hints.context) {\r\n          const contextRegex = new RegExp(`${contextWord}[:\\\\s]+(.*?)(?:\\\\n|$)`, \"i\")\r\n          const match = allText.match(contextRegex)\r\n          if (match && match[1]) {\r\n            extractedData[field.name] = match[1].trim()\r\n            console.log(`[v0] TenderService: Found ${field.name} via context: ${extractedData[field.name]}`)\r\n            break\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Check if we found enough data to be useful\r\n    const validation = this.validateTender(extractedData)\r\n    if (validation.score < 20) {\r\n      console.warn(\"[v0] TenderService: Not enough tender data found in document\")\r\n      return null\r\n    }\r\n\r\n    console.log(`[v0] TenderService: Extracted tender data with ${validation.score}% completeness`)\r\n    return this.normalizeScrapedData(extractedData)\r\n  }\r\n\r\n  // Enrich tender data with AI analysis context\r\n  static getTenderAnalysisContext(tenderData: any): string {\r\n    const validation = this.validateTender(tenderData)\r\n    const quality = this.getTenderQuality(tenderData)\r\n\r\n    return `\r\nTender Data Quality: ${quality.grade} (${quality.score}%)\r\n\r\nAvailable Fields:\r\n${TENDER_SCHEMA.fields.map((f) => `- ${f.displayName}: ${tenderData[f.name] ? \"✓\" : \"✗\"}`).join(\"\\n\")}\r\n\r\nData Completeness:\r\n${quality.feedback.join(\"\\n\")}\r\n\r\nThis context helps you understand what information is available for analysis.\r\n    `.trim()\r\n  }\r\n}\r\n","export * from \"./types\"\r\nexport * from \"./schema\"\r\nexport * from \"./validator\"\r\nexport * from \"./services/tender-service\"\r\n\r\n// Import TenderService to use it in the exported functions\r\nimport { TenderService } from \"./services/tender-service\"\r\n\r\nexport { TenderValidator } from \"./validator\"\r\n\r\n// Export commonly used functions as standalone exports\r\nexport function validateTender(tenderData: any) {\r\n  return TenderService.validateTender(tenderData)\r\n}\r\n\r\nexport function normalizeTenderData(tenderData: any) {\r\n  return TenderService.normalizeScrapedData(tenderData)\r\n}\r\n","// ============================================\r\n// ENGINE ORCHESTRATOR - CENTRAL INTEGRATION\r\n// ============================================\r\n\r\nimport { processDocument } from \"../documind\"\r\nimport { TenderService, validateTender, normalizeTenderData } from \"../tenders\"\r\nimport { OpportunityService, CompetitivenessService, StrategistService } from \"../strategist\"\r\nimport type { ScrapedTender } from \"../../scrapers/base-scraper\"\r\nimport type { ParsedDocument } from \"../documind/types\"\r\n// Tender types: use existing TenderValidationResult from tenders; keep TenderData as any for now\r\ntype TenderData = any\r\nimport type { TenderValidationResult as ValidationResult } from \"../tenders/types\"\r\n\r\nexport interface EngineOrchestrator {\r\n  processScrapedTender(tender: ScrapedTender): Promise<ProcessedTenderResult>\r\n  processUploadedDocument(file: ArrayBuffer, mimeType: string, userId: string): Promise<ProcessedDocumentResult>\r\n  enrichTenderWithStrategy(\r\n    tenderId: string,\r\n    tenderType: \"custom\" | \"scraped\",\r\n    userId: string,\r\n  ): Promise<StrategyEnrichmentResult>\r\n}\r\n\r\nexport interface ProcessedTenderResult {\r\n  success: boolean\r\n  tender?: TenderData\r\n  validation?: ValidationResult\r\n  documents?: ParsedDocument[]\r\n  opportunities?: any[]\r\n  error?: string\r\n}\r\n\r\nexport interface ProcessedDocumentResult {\r\n  success: boolean\r\n  document?: ParsedDocument\r\n  extractedTenderData?: TenderData\r\n  validation?: ValidationResult\r\n  error?: string\r\n}\r\n\r\nexport interface StrategyEnrichmentResult {\r\n  success: boolean\r\n  competitiveness?: any\r\n  opportunities?: any[]\r\n  recommendations?: string[]\r\n  error?: string\r\n}\r\n\r\n/**\r\n * Orchestrates all engines to work together seamlessly\r\n */\r\nexport class EngineOrchestrator {\r\n  // Services expose static methods; call them directly (no instances required)\r\n\r\n  /**\r\n   * Process a scraped tender through all engines\r\n   * Flow: Tenders Engine (validate/normalize) -> Documind (process docs) -> Strategist (analyze)\r\n   */\r\n  async processScrapedTender(tender: ScrapedTender, userId?: string): Promise<ProcessedTenderResult> {\r\n    try {\r\n      console.log(\"[v0] Orchestrator: Processing scraped tender:\", tender.title)\r\n\r\n      // Step 1: Tenders Engine - Validate and normalize\r\n      console.log(\"[v0] Orchestrator: Step 1 - Validating tender data...\")\r\n      const validation = validateTender(tender)\r\n\r\n      console.log(\"[v0] Orchestrator: Validation result:\", {\r\n        score: validation.score,\r\n        isValid: validation.isValid,\r\n        errors: validation.errors?.length || 0,\r\n      })\r\n\r\n      console.log(\r\n        `[v0] Orchestrator: Processing tender - Score: ${validation.score}`,\r\n      )\r\n\r\n      const normalizedTender = normalizeTenderData(tender)\r\n\r\n      // Step 2: Documind Engine - Process documents if available\r\n      const processedDocuments: ParsedDocument[] = []\r\n      if (tender.document_urls && tender.document_urls.length > 0) {\r\n        console.log(`[v0] Orchestrator: Step 2 - Processing ${tender.document_urls.length} documents...`)\r\n\r\n        for (const docUrl of tender.document_urls.slice(0, 3)) {\r\n          // Limit to 3 docs for performance\r\n          try {\r\n            const url = typeof docUrl === \"string\" ? docUrl : docUrl.url\r\n            const response = await fetch(url)\r\n            const buffer = await response.arrayBuffer()\r\n\r\n            const result = await processDocument(buffer, \"application/pdf\", {\r\n              extract_images: false,\r\n              ocr_enabled: true,\r\n            })\r\n\r\n            if (result.success && result.document) {\r\n              processedDocuments.push(result.document)\r\n              console.log(`[v0] Orchestrator: Document processed successfully: ${url}`)\r\n            }\r\n          } catch (docError) {\r\n            console.error(\"[v0] Orchestrator: Document processing failed:\", docError)\r\n          }\r\n        }\r\n      }\r\n\r\n      // Step 3: Strategist Engine - Create opportunities if user provided\r\n      const opportunities: any[] = []\r\n      if (userId) {\r\n        console.log(\"[v0] Orchestrator: Step 3 - Analyzing opportunities for user...\")\r\n\r\n        try {\r\n          const opportunity = await OpportunityService.createOpportunity({\r\n            userId,\r\n            tenderId: tender.scraped_tender_id || tender.tender_reference || \"\",\r\n            tenderType: \"scraped\",\r\n            tenderTitle: normalizedTender.title,\r\n            tenderData: normalizedTender,\r\n          })\r\n\r\n          if (opportunity) {\r\n            opportunities.push(opportunity)\r\n            console.log(`[v0] Orchestrator: Opportunity created with score: ${opportunity.match_score}`)\r\n          }\r\n        } catch (oppError) {\r\n          console.error(\"[v0] Orchestrator: Opportunity creation failed:\", oppError)\r\n        }\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        tender: normalizedTender,\r\n        validation,\r\n        documents: processedDocuments,\r\n        opportunities,\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[v0] Orchestrator: Error processing scraped tender:\", error)\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : \"Unknown error\",\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process an uploaded document through all engines\r\n   * Flow: Documind (extract) -> Tenders Engine (validate/normalize) -> Strategist (analyze)\r\n   */\r\n  async processUploadedDocument(file: ArrayBuffer, mimeType: string, userId: string): Promise<ProcessedDocumentResult> {\r\n    try {\r\n      console.log(\"[v0] Orchestrator: Processing uploaded document\")\r\n\r\n      // Step 1: Documind Engine - Extract content and fields\r\n      console.log(\"[v0] Orchestrator: Step 1 - Extracting document content...\")\r\n      const docResult = await processDocument(file, mimeType, {\r\n        extract_images: false,\r\n        ocr_enabled: true,\r\n      })\r\n\r\n      if (!docResult.success || !docResult.document) {\r\n        return {\r\n          success: false,\r\n          error: docResult.error?.message || \"Document processing failed\",\r\n        }\r\n      }\r\n\r\n      const document = docResult.document\r\n      console.log(\r\n        `[v0] Orchestrator: Document processed - ${document.pages.length} pages, ${document.form_fields?.length || 0} form fields`,\r\n      )\r\n\r\n      // Step 2: Tenders Engine - Extract tender data from document\r\n      console.log(\"[v0] Orchestrator: Step 2 - Extracting tender data from document...\")\r\n      const extractedTender = await TenderService.extractTenderFromDocument(document)\r\n\r\n      if (!extractedTender) {\r\n        console.warn(\"[v0] Orchestrator: Could not extract tender data from document\")\r\n        return {\r\n          success: true,\r\n          document,\r\n          error: \"Could not identify tender fields in document\",\r\n        }\r\n      }\r\n\r\n      // Step 3: Tenders Engine - Validate extracted data\r\n      console.log(\"[v0] Orchestrator: Step 3 - Validating extracted tender data...\")\r\n      const validation = validateTender(extractedTender)\r\n      const normalizedTender = normalizeTenderData(extractedTender)\r\n\r\n      console.log(\r\n        `[v0] Orchestrator: Tender extracted - Score: ${validation.score}`,\r\n      )\r\n\r\n      return {\r\n        success: true,\r\n        document,\r\n        extractedTenderData: normalizedTender,\r\n        validation,\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[v0] Orchestrator: Error processing uploaded document:\", error)\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : \"Unknown error\",\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enrich a tender with strategic analysis\r\n   * Flow: Strategist Engine (competitiveness + recommendations)\r\n   */\r\n  async enrichTenderWithStrategy(\r\n    tenderId: string,\r\n    tenderType: \"custom\" | \"scraped\",\r\n    userId: string,\r\n  ): Promise<StrategyEnrichmentResult> {\r\n    try {\r\n      console.log(`[v0] Orchestrator: Enriching tender ${tenderId} with strategy for user ${userId}`)\r\n\r\n      // Step 1: Calculate competitiveness score\r\n      console.log(\"[v0] Orchestrator: Step 1 - Calculating competitiveness...\")\r\n      const competitiveness = await CompetitivenessService.calculateScore({\r\n        userId,\r\n        tenderId,\r\n        tenderType,\r\n      })\r\n\r\n      // Step 2: Generate recommendations\r\n      console.log(\"[v0] Orchestrator: Step 2 - Generating strategic recommendations...\")\r\n      const recommendations = await StrategistService.generateRecommendations({\r\n        userId,\r\n        tenderId,\r\n        tenderType,\r\n        competitiveness,\r\n      })\r\n\r\n      // Step 3: Find related opportunities\r\n      console.log(\"[v0] Orchestrator: Step 3 - Finding related opportunities...\")\r\n      const opportunities = await OpportunityService.findSimilar({\r\n        userId,\r\n        tenderId,\r\n        tenderType,\r\n      })\r\n\r\n      return {\r\n        success: true,\r\n        competitiveness,\r\n        opportunities,\r\n        recommendations,\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[v0] Orchestrator: Error enriching tender with strategy:\", error)\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : \"Unknown error\",\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const engineOrchestrator = new EngineOrchestrator()\r\n","import { createClient } from \"@supabase/supabase-js\"\r\nimport { ScraperFactory } from \"../scrapers/scraper-factory\"\r\nimport type { ScrapedTender } from \"../scrapers/base-scraper\"\r\nimport { DocumentService } from \"./document-service\"\r\nimport { engineOrchestrator } from \"../engines/orchestrator\"\r\n\r\ninterface PostScrapeHook {\r\n  name: string\r\n  execute: (tenders: any[], supabase: any) => Promise<void>\r\n}\r\n\r\nexport class ScrapingService {\r\n  private supabase\r\n  private documentService\r\n  private postScrapeHooks: PostScrapeHook[] = []\r\n\r\n  constructor() {\r\n    this.supabase = createClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.SUPABASE_SERVICE_ROLE_KEY!)\r\n    this.documentService = new DocumentService()\r\n\r\n    this.registerHooks()\r\n  }\r\n\r\n  private registerHooks() {\r\n    // Hook 1: Generate opportunities for users based on new tenders\r\n    this.postScrapeHooks.push({\r\n      name: \"opportunity_matcher\",\r\n      execute: async (tenders, supabase) => {\r\n        if (tenders.length === 0) return\r\n\r\n        console.log(`[ScrapingService] Running opportunity matcher for ${tenders.length} tenders`)\r\n\r\n        // Get all users with preferences\r\n        const { data: users } = await supabase\r\n          .from(\"strategist_user_preferences\")\r\n          .select(\"user_id, provinces, industries, experience_level, annual_turnover\")\r\n          .eq(\"onboarding_completed\", true)\r\n\r\n        if (!users || users.length === 0) return\r\n\r\n        for (const user of users) {\r\n          for (const tender of tenders) {\r\n            const matchScore = this.calculateMatchScore(tender, user)\r\n\r\n            if (matchScore >= 0.3) {\r\n              // Create opportunity record\r\n              await supabase.from(\"strategist_opportunities\").upsert(\r\n                {\r\n                  user_id: user.user_id,\r\n                  scraped_tender_id: tender.id,\r\n                  match_score: matchScore,\r\n                  match_reasons: this.getMatchReasons(tender, user),\r\n                  opportunity_type: matchScore >= 0.7 ? \"high_margin\" : matchScore >= 0.5 ? \"strategic\" : \"growth\",\r\n                  is_viewed: false,\r\n                  is_saved: false,\r\n                  is_dismissed: false,\r\n                  expires_at: tender.close_date,\r\n                },\r\n                { onConflict: \"user_id, scraped_tender_id\" },\r\n              )\r\n            }\r\n          }\r\n        }\r\n\r\n        console.log(`[ScrapingService] Opportunity matching complete`)\r\n      },\r\n    })\r\n\r\n    // Hook 2: Create alerts for high-match opportunities\r\n    this.postScrapeHooks.push({\r\n      name: \"alert_generator\",\r\n      execute: async (tenders, supabase) => {\r\n        if (tenders.length === 0) return\r\n\r\n        console.log(`[ScrapingService] Checking for alert-worthy tenders`)\r\n\r\n        // Get users with notification preferences enabled\r\n        const { data: users } = await supabase\r\n          .from(\"strategist_user_preferences\")\r\n          .select(\"user_id, notification_preferences\")\r\n          .eq(\"onboarding_completed\", true)\r\n\r\n        if (!users) return\r\n\r\n        for (const user of users) {\r\n          const prefs = user.notification_preferences || {}\r\n          if (!prefs.new_opportunities) continue\r\n\r\n          // Get high-match opportunities created in this batch\r\n          const { data: opportunities } = await supabase\r\n            .from(\"strategist_opportunities\")\r\n            .select(\"id, match_score, scraped_tender_id\")\r\n            .eq(\"user_id\", user.user_id)\r\n            .gte(\"match_score\", 0.6)\r\n            .in(\r\n              \"scraped_tender_id\",\r\n              tenders.map((t) => t.id),\r\n            )\r\n\r\n          if (opportunities && opportunities.length > 0) {\r\n            await supabase.from(\"strategist_alerts\").insert({\r\n              user_id: user.user_id,\r\n              alert_type: \"new_opportunity\",\r\n              title: `${opportunities.length} New Matching Tenders`,\r\n              message: `We found ${opportunities.length} new tender${opportunities.length > 1 ? \"s\" : \"\"} that match your profile. Check them out!`,\r\n              priority: opportunities.some((o: any) => o.match_score >= 0.8) ? \"high\" : \"medium\",\r\n              action_url: \"/dashboard/strategist?tab=opportunities\",\r\n              action_label: \"View Opportunities\",\r\n            })\r\n          }\r\n        }\r\n      },\r\n    })\r\n\r\n    // Hook 3: Log scraping stats for analytics\r\n    this.postScrapeHooks.push({\r\n      name: \"stats_logger\",\r\n      execute: async (tenders, supabase) => {\r\n        await supabase.from(\"scraping_usage_logs\").insert({\r\n          tenders_found: tenders.length,\r\n          success: true,\r\n          scrape_type: \"batch\",\r\n          api_credits_used: 1,\r\n        })\r\n      },\r\n    })\r\n  }\r\n\r\n  private calculateMatchScore(tender: any, userPrefs: any): number {\r\n    let score = 0\r\n\r\n    // Province match (25%)\r\n    if (userPrefs.provinces?.length && tender.source_province) {\r\n      const provinceMatch = userPrefs.provinces.some((p: string) =>\r\n        tender.source_province?.toLowerCase().includes(p.toLowerCase()),\r\n      )\r\n      if (provinceMatch) score += 0.25\r\n    }\r\n\r\n    // Industry match (30%)\r\n    if (userPrefs.industries?.length && tender.category) {\r\n      const categoryLower = tender.category.toLowerCase()\r\n      const industryMatch = userPrefs.industries.some(\r\n        (ind: string) => categoryLower.includes(ind.toLowerCase()) || ind.toLowerCase().includes(categoryLower),\r\n      )\r\n      if (industryMatch) score += 0.3\r\n    }\r\n\r\n    // Value match (20%)\r\n    if (userPrefs.annual_turnover && tender.estimated_value) {\r\n      score += 0.2\r\n    }\r\n\r\n    // Deadline proximity (25%)\r\n    if (tender.close_date) {\r\n      const daysUntilClose = Math.ceil((new Date(tender.close_date).getTime() - Date.now()) / (1000 * 60 * 60 * 24))\r\n      if (daysUntilClose > 14) score += 0.25\r\n      else if (daysUntilClose > 7) score += 0.15\r\n      else score += 0.05\r\n    }\r\n\r\n    return Math.min(score, 1)\r\n  }\r\n\r\n  private getMatchReasons(tender: any, userPrefs: any): string[] {\r\n    const reasons: string[] = []\r\n\r\n    if (userPrefs.provinces?.some((p: string) => tender.source_province?.toLowerCase().includes(p.toLowerCase()))) {\r\n      reasons.push(\"Matches your preferred province\")\r\n    }\r\n\r\n    if (userPrefs.industries?.some((ind: string) => tender.category?.toLowerCase().includes(ind.toLowerCase()))) {\r\n      reasons.push(\"Matches your industry focus\")\r\n    }\r\n\r\n    if (tender.close_date) {\r\n      const daysUntilClose = Math.ceil((new Date(tender.close_date).getTime() - Date.now()) / (1000 * 60 * 60 * 24))\r\n      if (daysUntilClose > 14) reasons.push(\"Good preparation time available\")\r\n      else if (daysUntilClose > 7) reasons.push(\"Adequate preparation time\")\r\n    }\r\n\r\n    return reasons\r\n  }\r\n\r\n  async scrapeSource(sourceId: number) {\r\n    try {\r\n      console.log(`[ScrapingService] Starting scrape for source ${sourceId}`)\r\n\r\n      const { data: source, error: sourceError } = await this.supabase\r\n        .from(\"tender_sources\")\r\n        .select(\"*\")\r\n        .eq(\"id\", sourceId)\r\n        .single()\r\n\r\n      if (sourceError || !source) {\r\n        throw new Error(`Source not found: ${sourceId}`)\r\n      }\r\n\r\n      if (!source.is_active || !source.scraping_enabled) {\r\n        console.log(`[ScrapingService] Source ${sourceId} is not active or scraping is disabled`)\r\n        return {\r\n          success: false,\r\n          message: \"Source is not active or scraping is disabled\",\r\n        }\r\n      }\r\n\r\n      const scraper = ScraperFactory.createScraper(source)\r\n      const result = await scraper.scrape()\r\n\r\n      let savedTenders: any[] = []\r\n      if (result.success && result.tenders.length > 0) {\r\n        console.log(`[ScrapingService] Saving ${result.tenders.length} tenders to database`)\r\n        savedTenders = await this.saveTenders(sourceId, source, result.tenders)\r\n\r\n        if (savedTenders && savedTenders.length > 0) {\r\n          console.log(`[ScrapingService] Starting document download for ${savedTenders.length} tenders`)\r\n          await this.downloadTenderDocuments(savedTenders)\r\n        }\r\n\r\n        console.log(`[ScrapingService] Running ${this.postScrapeHooks.length} post-scrape hooks`)\r\n        for (const hook of this.postScrapeHooks) {\r\n          try {\r\n            await hook.execute(savedTenders, this.supabase)\r\n          } catch (hookError) {\r\n            console.error(`[ScrapingService] Hook ${hook.name} failed:`, hookError)\r\n          }\r\n        }\r\n      }\r\n\r\n      await this.updateSourceStats(sourceId, result)\r\n\r\n      return {\r\n        success: result.success,\r\n        scrapedCount: result.scrapedCount,\r\n        savedCount: savedTenders.length,\r\n        error: result.error,\r\n      }\r\n    } catch (error) {\r\n      console.error(`[ScrapingService] Error scraping source ${sourceId}:`, error)\r\n\r\n      await this.supabase\r\n        .from(\"tender_sources\")\r\n        .update({\r\n          last_scrape_status: \"failed\",\r\n          last_scrape_error: error instanceof Error ? error.message : \"Unknown error\",\r\n        })\r\n        .eq(\"id\", sourceId)\r\n\r\n      // Log failed scrape\r\n      await this.supabase.from(\"scraping_usage_logs\").insert({\r\n        source_id: sourceId,\r\n        tenders_found: 0,\r\n        success: false,\r\n        scrape_type: \"single\",\r\n        error_message: error instanceof Error ? error.message : \"Unknown error\",\r\n      })\r\n\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : \"Unknown error\",\r\n      }\r\n    }\r\n  }\r\n\r\n  private async saveTenders(sourceId: number, source: any, tenders: ScrapedTender[]) {\r\n    console.log(`[v0] ScrapingService: Processing ${tenders.length} tenders through engine orchestrator`)\r\n\r\n    console.log(`[v0] ScrapingService: ==================== DETAILED TENDER ANALYSIS ====================`)\r\n    console.log(`[v0] ScrapingService: Source: ${source.name}`)\r\n    console.log(`[v0] ScrapingService: Found ${tenders.length} raw tender(s) to validate`)\r\n\r\n    const validatedTenders: any[] = []\r\n\r\n    for (let i = 0; i < tenders.length; i++) {\r\n      const tender = tenders[i]\r\n      console.log(`\\n[v0] ScrapingService: ========== Tender ${i + 1}/${tenders.length} ==========`)\r\n      console.log(`[v0] ScrapingService: Title: ${tender.title}`)\r\n\r\n      const result = await engineOrchestrator.processScrapedTender(tender)\r\n\r\n      if (result.tender) {\r\n        console.log(\r\n          `[v0] ScrapingService: ✓ Tender ACCEPTED - ${result.tender.title} (${result.validation?.grade}, ${(result.validation?.completeness ?? 0) * 100}% complete)`,\r\n        )\r\n        validatedTenders.push({\r\n          source_id: sourceId,\r\n          source_name: source.name,\r\n          source_url: source.tender_page_url,\r\n          source_level: source.level,\r\n          source_province: source.province,\r\n          ...result.tender,\r\n          is_active: true,\r\n          quality_score: result.validation?.completeness || 0,\r\n          quality_grade: result.validation?.grade || \"C\",\r\n        })\r\n      } else {\r\n        console.warn(`[v0] ScrapingService: ⚠️ Warning - Could not process tender: ${tender.title}`)\r\n        console.warn(`[v0] ScrapingService:   Error: ${result.error || \"Unknown error\"}`)\r\n      }\r\n    }\r\n\r\n    console.log(`\\n[v0] ScrapingService: ==================== VALIDATION SUMMARY ====================`)\r\n    console.log(`[v0] ScrapingService: Total scraped: ${tenders.length}`)\r\n    console.log(`[v0] ScrapingService: Processed: ${validatedTenders.length}`)\r\n    console.log(`[v0] ScrapingService: Failed to process: ${tenders.length - validatedTenders.length}`)\r\n\r\n    if (validatedTenders.length === 0) {\r\n      console.log(\"[v0] ScrapingService: ⚠️ WARNING: NO TENDERS COULD BE PROCESSED!\")\r\n      return []\r\n    }\r\n\r\n    console.log(`[v0] ScrapingService: Saving ${validatedTenders.length} tenders to database`)\r\n\r\n    const savedTenders: any[] = []\r\n\r\n    for (const tender of validatedTenders) {\r\n      try {\r\n        const { data: existing } = await this.supabase\r\n          .from(\"scraped_tenders\")\r\n          .select(\"id, title\")\r\n          .eq(\"source_id\", tender.source_id)\r\n          .ilike(\"title\", tender.title)\r\n          .maybeSingle()\r\n\r\n        if (existing) {\r\n          console.log(`[v0] ScrapingService: Tender already exists (ID: ${existing.id}): ${tender.title}`)\r\n          savedTenders.push(existing)\r\n          continue\r\n        }\r\n\r\n        const { data, error } = await this.supabase.from(\"scraped_tenders\").insert(tender).select().single()\r\n\r\n        if (error) {\r\n          console.error(`[v0] ScrapingService: ❌ Error saving tender \"${tender.title}\":`, error.message)\r\n          console.error(`[v0] ScrapingService: Error details:`, JSON.stringify(error, null, 2))\r\n          continue\r\n        }\r\n\r\n        if (data) {\r\n          console.log(`[v0] ScrapingService: ✓ Successfully saved new tender (ID: ${data.id}): ${tender.title}`)\r\n          savedTenders.push(data)\r\n        }\r\n      } catch (error) {\r\n        console.error(`[v0] ScrapingService: ❌ Exception saving tender \"${tender.title}\":`, error)\r\n      }\r\n    }\r\n\r\n    console.log(`\\n[v0] ScrapingService: ==================== SAVE SUMMARY ====================`)\r\n    console.log(`[v0] ScrapingService: Attempted to save: ${validatedTenders.length}`)\r\n    console.log(`[v0] ScrapingService: Successfully saved: ${savedTenders.filter((t) => !t.title).length} new tenders`)\r\n    console.log(`[v0] ScrapingService: Duplicates skipped: ${savedTenders.filter((t) => t.title).length}`)\r\n    console.log(`[v0] ScrapingService: Failed: ${validatedTenders.length - savedTenders.length}`)\r\n\r\n    return savedTenders\r\n  }\r\n\r\n  private async downloadTenderDocuments(tenders: any[]) {\r\n    const scraperApiKey = process.env.SCRAPING_API_KEY\r\n\r\n    for (const tender of tenders) {\r\n      if (tender.document_urls && Array.isArray(tender.document_urls) && tender.document_urls.length > 0) {\r\n        console.log(\r\n          `[ScrapingService] Downloading ${tender.document_urls.length} documents for tender: ${tender.title}`,\r\n        )\r\n\r\n        try {\r\n          const urls = tender.document_urls.map((doc: any) => (typeof doc === \"string\" ? doc : doc.url)).filter(Boolean)\r\n\r\n          if (urls.length > 0) {\r\n            await this.documentService.downloadTenderDocuments(urls, tender.id, scraperApiKey)\r\n          }\r\n        } catch (error) {\r\n          console.error(`[ScrapingService] Error downloading documents for tender ${tender.id}:`, error)\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private async updateSourceStats(sourceId: number, result: any) {\r\n    const { data: currentSource } = await this.supabase\r\n      .from(\"tender_sources\")\r\n      .select(\"total_tenders_scraped\")\r\n      .eq(\"id\", sourceId)\r\n      .single()\r\n\r\n    const newCount = (currentSource?.total_tenders_scraped || 0) + (result.scrapedCount || 0)\r\n\r\n    await this.supabase\r\n      .from(\"tender_sources\")\r\n      .update({\r\n        last_scraped_at: new Date().toISOString(),\r\n        last_scrape_status: result.success ? \"success\" : \"failed\",\r\n        last_scrape_error: result.error || null,\r\n        total_tenders_scraped: result.success ? newCount : currentSource?.total_tenders_scraped || 0,\r\n      })\r\n      .eq(\"id\", sourceId)\r\n  }\r\n\r\n  async scrapeAllActiveSources(progressId?: string) {\r\n    console.log(\"[v0] ScrapingService: Starting scrape for all active sources\")\r\n\r\n    const { data: sources, error } = await this.supabase\r\n      .from(\"tender_sources\")\r\n      .select(\"id, name, tender_page_url, scraping_enabled, is_active\")\r\n      .eq(\"is_active\", true)\r\n      .eq(\"scraping_enabled\", true)\r\n\r\n    if (error || !sources) {\r\n      console.error(\"[v0] ScrapingService: Error fetching active sources:\", error)\r\n      if (progressId) {\r\n        await this.supabase\r\n          .from(\"scraping_progress\")\r\n          .update({ status: \"failed\", error_message: \"Failed to fetch active sources\" })\r\n          .eq(\"id\", progressId)\r\n      }\r\n      return { success: false, error: \"Failed to fetch active sources\" }\r\n    }\r\n\r\n    console.log(`[v0] ScrapingService: Found ${sources.length} active sources to scrape`)\r\n\r\n    if (sources.length === 0) {\r\n      console.warn(\"[v0] ScrapingService: ⚠️ WARNING - NO ACTIVE SOURCES FOUND!\")\r\n      console.warn(\"[v0] ScrapingService: Please check the tender_sources table:\")\r\n      console.warn(\"[v0] ScrapingService: - Ensure rows exist in the table\")\r\n      console.warn(\"[v0] ScrapingService: - Ensure is_active = true\")\r\n      console.warn(\"[v0] ScrapingService: - Ensure scraping_enabled = true\")\r\n\r\n      if (progressId) {\r\n        await this.supabase\r\n          .from(\"scraping_progress\")\r\n          .update({ status: \"completed\", completed_sources: 0, total_sources: 0 })\r\n          .eq(\"id\", progressId)\r\n      }\r\n    } else {\r\n      sources.forEach((source, index) => {\r\n        console.log(`[v0] ScrapingService: Source ${index + 1}: ${source.name} - ${source.tender_page_url}`)\r\n      })\r\n\r\n      if (progressId) {\r\n        await this.supabase.from(\"scraping_progress\").update({ total_sources: sources.length }).eq(\"id\", progressId)\r\n      }\r\n    }\r\n\r\n    if (sources.length === 0) {\r\n      return {\r\n        success: true,\r\n        results: [],\r\n        totalScraped: 0,\r\n        sourcesScraped: 0,\r\n        successfulSources: 0,\r\n        message: \"No active sources available to scrape\",\r\n      }\r\n    }\r\n\r\n    const results = []\r\n    for (let i = 0; i < sources.length; i++) {\r\n      const source = sources[i]\r\n      console.log(`[v0] ScrapingService: Scraping source ${i + 1}/${sources.length}: ${source.name}`)\r\n\r\n      if (progressId) {\r\n        await this.supabase\r\n          .from(\"scraping_progress\")\r\n          .update({\r\n            current_source: source.name,\r\n            current_source_id: source.id,\r\n            completed_sources: i,\r\n          })\r\n          .eq(\"id\", progressId)\r\n      }\r\n\r\n      const result = await this.scrapeSource(source.id)\r\n      results.push({ sourceId: source.id, sourceName: source.name, ...result })\r\n\r\n      if (progressId && result.scrapedCount) {\r\n        const { data: currentProgress } = await this.supabase\r\n          .from(\"scraping_progress\")\r\n          .select(\"total_tenders\")\r\n          .eq(\"id\", progressId)\r\n          .single()\r\n\r\n        await this.supabase\r\n          .from(\"scraping_progress\")\r\n          .update({\r\n            total_tenders: (currentProgress?.total_tenders || 0) + result.scrapedCount,\r\n          })\r\n          .eq(\"id\", progressId)\r\n      }\r\n\r\n      await new Promise((resolve) => setTimeout(resolve, 2000))\r\n    }\r\n\r\n    const totalScraped = results.reduce((sum, r) => sum + (r.scrapedCount || 0), 0)\r\n    const successCount = results.filter((r) => r.success).length\r\n\r\n    if (progressId) {\r\n      await this.supabase\r\n        .from(\"scraping_progress\")\r\n        .update({\r\n          status: \"completed\",\r\n          completed_sources: sources.length,\r\n          current_source: null,\r\n        })\r\n        .eq(\"id\", progressId)\r\n    }\r\n\r\n    console.log(`[v0] ScrapingService: Completed scraping ${sources.length} sources, total tenders: ${totalScraped}`)\r\n\r\n    return {\r\n      success: true,\r\n      results,\r\n      totalScraped,\r\n      sourcesScraped: sources.length,\r\n      successfulSources: successCount,\r\n    }\r\n  }\r\n}\r\n","import { put } from \"@vercel/blob\"\r\nimport { createClient } from \"@supabase/supabase-js\"\r\n\r\nexport interface TenderDocument {\r\n  id?: string\r\n  tender_id: string\r\n  document_name: string\r\n  document_type: string\r\n  original_url: string\r\n  blob_url: string\r\n  file_size?: number\r\n}\r\n\r\nexport class DocumentService {\r\n  private supabase\r\n\r\n  constructor() {\r\n    this.supabase = createClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.SUPABASE_SERVICE_ROLE_KEY!)\r\n  }\r\n\r\n  /**\r\n   * Download a document from a URL and upload it to Vercel Blob\r\n   */\r\n  async downloadAndStoreDocument(\r\n    url: string,\r\n    tenderId: string,\r\n    scraperApiKey?: string,\r\n  ): Promise<TenderDocument | null> {\r\n    try {\r\n      console.log(\"[DocumentService] Downloading document:\", url)\r\n\r\n      // Construct the fetch URL (use ScraperAPI if available)\r\n      const fetchUrl = scraperApiKey\r\n        ? `http://api.scraperapi.com?api_key=${scraperApiKey}&url=${encodeURIComponent(url)}`\r\n        : url\r\n\r\n      // Download the document with timeout\r\n      const controller = new AbortController()\r\n      const timeoutId = setTimeout(() => controller.abort(), 30000) // 30 second timeout\r\n\r\n      const response = await fetch(fetchUrl, {\r\n        signal: controller.signal,\r\n        headers: {\r\n          \"User-Agent\": \"BidMateAI-DocumentDownloader/1.0\",\r\n        },\r\n      })\r\n\r\n      clearTimeout(timeoutId)\r\n\r\n      if (!response.ok) {\r\n        console.error(`[DocumentService] Failed to download: ${response.status} ${response.statusText}`)\r\n        return null\r\n      }\r\n\r\n      const blob = await response.blob()\r\n      const fileSize = blob.size\r\n\r\n      // Skip files larger than 50MB\r\n      if (fileSize > 50 * 1024 * 1024) {\r\n        console.warn(`[DocumentService] File too large (${fileSize} bytes), skipping`)\r\n        return null\r\n      }\r\n\r\n      // Extract filename from URL or generate one\r\n      const urlPath = new URL(url).pathname\r\n      const filename = urlPath.split(\"/\").pop() || `document-${Date.now()}`\r\n\r\n      // Determine file type from extension or content-type\r\n      const extension = filename.split(\".\").pop()?.toLowerCase() || \"pdf\"\r\n      const contentType = response.headers.get(\"content-type\") || \"application/pdf\"\r\n\r\n      // Create a File object for Vercel Blob\r\n      const file = new File([blob], filename, { type: contentType })\r\n\r\n      // Upload to Vercel Blob with organized path\r\n      const blobResult = await put(`tenders/${tenderId}/${filename}`, file, {\r\n        access: \"public\",\r\n      })\r\n\r\n      console.log(\"[DocumentService] Document uploaded to Blob:\", blobResult.url)\r\n\r\n      // Save document metadata to database\r\n      const document: TenderDocument = {\r\n        tender_id: tenderId,\r\n        document_name: filename,\r\n        document_type: extension,\r\n        original_url: url,\r\n        blob_url: blobResult.url,\r\n        file_size: fileSize,\r\n      }\r\n\r\n      const { data, error } = await this.supabase.from(\"tender_documents\").insert(document).select().single()\r\n\r\n      if (error) {\r\n        console.error(\"[DocumentService] Error saving to database:\", error)\r\n        return null\r\n      }\r\n\r\n      console.log(\"[DocumentService] Document saved:\", data.id)\r\n      return data\r\n    } catch (error) {\r\n      if (error instanceof Error && error.name === \"AbortError\") {\r\n        console.error(\"[DocumentService] Download timed out for:\", url)\r\n      } else {\r\n        console.error(\"[DocumentService] Error downloading/storing document:\", error)\r\n      }\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Download multiple documents for a tender\r\n   * Accepts both string[] and {title: string, url: string}[] formats\r\n   */\r\n  async downloadTenderDocuments(\r\n    documentUrls: (string | { title?: string; url: string })[],\r\n    tenderId: string,\r\n    scraperApiKey?: string,\r\n  ): Promise<TenderDocument[]> {\r\n    console.log(`[DocumentService] Downloading ${documentUrls.length} documents for tender ${tenderId}`)\r\n\r\n    const documents: TenderDocument[] = []\r\n\r\n    // Normalize URLs to strings\r\n    const urls = documentUrls\r\n      .map((doc) => (typeof doc === \"string\" ? doc : doc.url))\r\n      .filter((url): url is string => Boolean(url))\r\n\r\n    // Download documents sequentially to avoid rate limiting\r\n    for (const url of urls) {\r\n      try {\r\n        const document = await this.downloadAndStoreDocument(url, tenderId, scraperApiKey)\r\n        if (document) {\r\n          documents.push(document)\r\n        }\r\n      } catch (error) {\r\n        console.error(`[DocumentService] Failed to download ${url}:`, error)\r\n      }\r\n\r\n      // Add a small delay between downloads to be respectful\r\n      await new Promise((resolve) => setTimeout(resolve, 1000))\r\n    }\r\n\r\n    console.log(`[DocumentService] Successfully downloaded ${documents.length}/${urls.length} documents`)\r\n    return documents\r\n  }\r\n\r\n  /**\r\n   * Get all documents for a tender\r\n   */\r\n  async getTenderDocuments(tenderId: string): Promise<TenderDocument[]> {\r\n    const { data, error } = await this.supabase\r\n      .from(\"tender_documents\")\r\n      .select(\"*\")\r\n      .eq(\"tender_id\", tenderId)\r\n      .order(\"created_at\", { ascending: false })\r\n\r\n    if (error) {\r\n      console.error(\"[DocumentService] Error fetching tender documents:\", error)\r\n      return []\r\n    }\r\n\r\n    return data || []\r\n  }\r\n\r\n  /**\r\n   * Check if a document already exists for a tender\r\n   */\r\n  async documentExists(tenderId: string, originalUrl: string): Promise<boolean> {\r\n    const { count } = await this.supabase\r\n      .from(\"tender_documents\")\r\n      .select(\"*\", { count: \"exact\", head: true })\r\n      .eq(\"tender_id\", tenderId)\r\n      .eq(\"original_url\", originalUrl)\r\n\r\n    return (count || 0) > 0\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}