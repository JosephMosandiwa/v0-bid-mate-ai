module.exports=[99231,e=>{"use strict";var t=e.i(248749),o=e.i(219650),r=e.i(508677),a=e.i(615159),l=e.i(548938),n=e.i(273073),i=e.i(129714),s=e.i(403736),d=e.i(817889),c=e.i(428765),u=e.i(762198),g=e.i(117109),p=e.i(590702),f=e.i(462216),h=e.i(539401),w=e.i(222695),m=e.i(193695);e.i(31514);var v=e.i(267074),b=e.i(89660);e.i(801612);var y=e.i(430497),x=e.i(747402),C=e.i(521854),R=e.i(204489),_=e.i(680717);let P=(e,t,o,r)=>{e.forEach(e=>{if("string"==typeof e){(""===e?t:E(t,e)).classGroupId=o;return}"function"==typeof e?F(e)?P(e(r),t,o,r):t.validators.push({validator:e,classGroupId:o}):Object.entries(e).forEach(([e,a])=>{P(a,E(t,e),o,r)})})},E=(e,t)=>{let o=e;return t.split("-").forEach(e=>{o.nextPart.has(e)||o.nextPart.set(e,{nextPart:new Map,validators:[]}),o=o.nextPart.get(e)}),o},F=e=>e.isThemeGetter,T=e=>{let t;if("string"==typeof e)return e;let o="";for(let r=0;r<e.length;r++)e[r]&&(t=T(e[r]))&&(o&&(o+=" "),o+=t);return o},S=new Set(["px","full","screen"]),D=new Set(["length","size","percentage"]),A=new Set(["image","url"]);async function L(e,t){try{let o,r,{id:a}=t?.params?await t.params:t?.params??t,{documentId:l,saveToBlob:n=!0}=await e.json(),i=await (0,b.createClient)();console.log("[v0] ========================================"),console.log("[v0] GENERATE FILLED EDITABLE PDF"),console.log("[v0] ========================================"),console.log("[v0] Tender ID:",a),console.log("[v0] Document ID:",l);let{data:{user:s}}=await i.auth.getUser();if(!s)return Response.json({error:"Unauthorized"},{status:401});let{data:d,error:c}=await i.from("user_custom_tenders").select("*").eq("id",a).single();if(c||!d)return Response.json({error:"Tender not found"},{status:404});let{data:u}=await i.from("user_custom_tender_analysis").select("*").eq("tender_id",a).single(),g=u?.analysis_data?.formFields||[],p=u?.analysis_data?.pdfFormFields||[];console.log("[v0] Form fields from analysis:",g.length),console.log("[v0] PDF form fields with positions:",p.length);let{data:f}=await i.from("user_custom_tender_responses").select("*").eq("tender_id",a).eq("user_id",s.id).single(),h=f?.response_data||{};console.log("[v0] Form responses:",Object.keys(h).length);let w=d.document_url;if(l){let{data:e,error:t}=await i.from("user_custom_tender_documents").select("blob_url").eq("id",l).eq("tender_id",a).single();if(t||!e)return Response.json({error:"Document not found"},{status:404});w=e.blob_url}if(!w)return Response.json({error:"No document URL found"},{status:404});console.log("[v0] Fetching original PDF...");let m=await fetch(w);if(!m.ok)throw Error("Failed to fetch original PDF");let v=await m.arrayBuffer();try{r=await y.PDFDocument.load(v,{ignoreEncryption:!0,updateMetadata:!1}),o=await y.PDFDocument.create();let e=r.getPageIndices();(await o.copyPages(r,e)).forEach(e=>{o.addPage(e)}),console.log("[v0] Created editable copy with",o.getPageCount(),"pages")}catch(e){throw console.error("[v0] Failed to copy PDF:",e),Error("Could not create editable copy of the PDF")}let P=await o.embedFont(R.StandardFonts.Helvetica),E=await o.embedFont(R.StandardFonts.HelveticaBold),F=o.getForm(),T=0,S=0,D=r.getForm().getFields(),A=new Map,L=new Map,O=10;for(let e of(console.log("[v0] Source PDF has",D.length,"form fields"),D))try{let t=e.getName(),o=e.acroField.getWidgets();if(o.length>0){let e=o[0],a=e.getRectangle(),l=0,n=e.P();if(n){let e=r.getPages();for(let t=0;t<e.length;t++)if(e[t].ref===n){l=t;break}}A.set(t.toLowerCase(),{x:a.x,y:a.y,width:a.width,height:a.height,page:l}),console.log(`[v0] Mapped field "${t}" at (${a.x}, ${a.y}) on page ${l+1}`);let i=Math.max(8,Math.min(14,.7*a.height));L.set(t.toLowerCase(),i);try{let o=e.getDefaultAppearance();if(o){let e=o.match(/(\d+(?:\.\d+)?)\s+Tf/);if(e){let o=Number.parseFloat(e[1]);o>0&&o<72&&(L.set(t.toLowerCase(),o),O=o)}}}catch(e){}}}catch(e){}for(let e of(console.log("[v0] Position map has",A.size,"entries from source PDF"),console.log("[v0] Font size map has",L.size,"entries, default size:",O),p))e.position&&!A.has(e.name.toLowerCase())&&A.set(e.name.toLowerCase(),e.position);let $=F.getFields(),k=new Set;if($.length>0)for(let e of(console.log("[v0] Filling",$.length,"existing form fields..."),$)){let t=e.getName(),o=function(e,t,o){let r=e.toLowerCase().replace(/[_\-\s]+/g,""),a=null;for(let e of o){let o=e.id,l=e.label||"",n=e.pdfFieldName||"",i=o.toLowerCase().replace(/[_\-\s]+/g,""),s=l.toLowerCase().replace(/[_\-\s]+/g,""),d=n.toLowerCase().replace(/[_\-\s]+/g,""),c=0;if(d&&r===d)c=100;else if(r===i)c=95;else if(r===s)c=90;else if(r.includes(i)||i.includes(r)||r.includes(s)||s.includes(r))c=70;else{let e=r.split(/(?=[A-Z])/).map(e=>e.toLowerCase()),t=[...i.split(/(?=[A-Z])/).map(e=>e.toLowerCase()),...s.split(/[^a-z]/).filter(Boolean)];c=15*e.filter(e=>t.some(t=>t.includes(e)||e.includes(t))).length}c>0&&void 0!==t[o]&&(!a||c>a.score)&&(a={key:o,value:t[o],score:c})}if(!a)for(let[e,o]of Object.entries(t)){let t=e.toLowerCase().replace(/[_\-\s]+/g,""),l=0;if(r===t)l=100;else if(r.includes(t)||t.includes(r))l=80;else{let e=r.split(/(?=[A-Z])/).map(e=>e.toLowerCase()),o=t.split(/(?=[A-Z])/).map(e=>e.toLowerCase());l=20*e.filter(e=>o.some(t=>t.includes(e)||e.includes(t))).length}l>0&&(!a||l>a.score)&&(a={key:e,value:o,score:l})}return a&&a.score>=40?a:null}(t,h,g);if(o)try{if(e instanceof x.PDFTextField){let r=L.get(t.toLowerCase())||O;try{e.setFontSize(r)}catch(e){}e.setText(String(o.value)),T++,k.add(t.toLowerCase()),console.log("[v0] Filled existing field:",t,"with font size:",r)}else e instanceof x.PDFCheckBox&&(!0===o.value||"true"===o.value||"yes"===o.value)&&(e.check(),T++,k.add(t.toLowerCase()))}catch(e){console.log("[v0] Could not fill field:",t)}}let N=o.getPages(),z=N.length;for(let e of g){let t=e.id,o=h[t];if(null==o||""===o)continue;let r=t.toLowerCase().replace(/[_\-\s]+/g,""),a=!1;for(let e of k){let t=e.toLowerCase().replace(/[_\-\s]+/g,"");if(t.includes(r)||r.includes(t)){a=!0;break}}if(a)continue;let l=null;if(A.has(r))l=A.get(r);else for(let[e,t]of A.entries()){let o=e.replace(/[_\-\s]+/g,"");if(o.includes(r)||r.includes(o)){l=t;break}}if(!l){console.log(`[v0] Skipping field "${t}" - no position available from source PDF`);continue}let n=Math.min(l.page,z-1),i=N[n];try{let a=`overlay_${t}_${Date.now()}_${S}`;if("checkbox"===e.type||"boolean"===e.type){let e=F.createCheckBox(a);e.addToPage(i,{x:l.x,y:l.y,width:l.width||14,height:l.height||14,borderColor:(0,C.rgb)(.4,.4,.4),backgroundColor:(0,C.rgb)(1,1,1)}),(!0===o||"true"===o||"yes"===o)&&e.check(),S++,T++,console.log(`[v0] Created checkbox at (${l.x}, ${l.y}) on page ${n+1}`)}else{let e=F.createTextField(a);e.addToPage(i,{x:l.x,y:l.y,width:l.width||200,height:l.height||20,borderColor:(0,C.rgb)(.6,.6,.6),backgroundColor:(0,C.rgb)(1,1,1),borderWidth:.5});let s=O;for(let[e,t]of L.entries()){let o=e.replace(/[_\-\s]+/g,"");if(o.includes(r)||r.includes(o)){s=t;break}}s===O&&l.height&&(s=Math.max(8,Math.min(14,.7*l.height)));try{e.setFontSize(s)}catch(e){}e.setText(String(o)),S++,T++,console.log(`[v0] Created text field "${t}" at (${l.x}, ${l.y}) on page ${n+1} with font size ${s}`)}}catch(e){console.log("[v0] Error creating overlay field:",t,e.message)}}if(0===S&&0===T&&Object.keys(h).length>0){console.log("[v0] No PDF form fields found - drawing responses directly onto PDF pages");let e={};for(let t of g){let o=h[t.id];if(null==o||""===o)continue;let r=t.section||"General";e[r]||(e[r]=[]),e[r].push({id:t.id,label:t.label||t.id,value:String(o)})}let t=o.addPage(),{width:r,height:a}=t.getSize(),l=a-50;for(let[a,n]of(t.drawText("TENDER RESPONSE SUMMARY",{x:50,y:l,size:16,font:E,color:(0,C.rgb)(0,0,0)}),l-=30,t.drawText(`Tender: ${d.title||"Untitled"}`,{x:50,y:l,size:10,font:P,color:(0,C.rgb)(.3,.3,.3)}),l-=16,t.drawText(`Generated: ${new Date().toLocaleDateString()}`,{x:50,y:l,size:10,font:P,color:(0,C.rgb)(.3,.3,.3)}),l-=25,Object.entries(e))){l<100&&(l=o.addPage().getSize().height-50);let e=o.getPages()[o.getPageCount()-1];for(let t of(e.drawText(a.toUpperCase(),{x:50,y:l,size:12,font:E,color:(0,C.rgb)(.2,.2,.2)}),l-=21,e.drawLine({start:{x:50,y:l+8},end:{x:r-50,y:l+8},thickness:.5,color:(0,C.rgb)(.7,.7,.7)}),l-=10,n)){l<80&&(l=o.addPage().getSize().height-50);let e=o.getPages()[o.getPageCount()-1],a=t.label;if(P.widthOfTextAtSize(a,10)>200){for(;P.widthOfTextAtSize(a+"...",10)>200&&a.length>10;)a=a.slice(0,-1);a+="..."}e.drawText(`${a}:`,{x:50,y:l,size:10,font:E,color:(0,C.rgb)(.3,.3,.3)});let n=r-260-50,i=t.value.split(" "),s="",d=0;for(let t of i){let o=s?`${s} ${t}`:t;if(P.widthOfTextAtSize(o,10)<n)s=o;else{if(s&&(e.drawText(s,{x:260,y:l-16*d,size:10,font:P,color:(0,C.rgb)(0,0,0)}),++d>=5)){e.drawText("...",{x:260,y:l-16*d,size:10,font:P,color:(0,C.rgb)(.5,.5,.5)});break}s=t}}s&&d<5&&(e.drawText(s,{x:260,y:l-16*d,size:10,font:P,color:(0,C.rgb)(0,0,0)}),d++),l-=Math.max(16,16*d)+8,T++}l-=15}console.log("[v0] Added response summary page with",T,"responses")}console.log("[v0] Fields created:",S),console.log("[v0] Fields filled:",T),console.log("[v0] Total pages:",o.getPageCount());let M=await o.save();console.log("[v0] PDF saved, size:",M.byteLength,"bytes");let I=null;if(n)try{let e=new Date().toISOString().replace(/[:.]/g,"-"),t=`filled_${d.title?.replace(/[^a-z0-9]/gi,"_").toLowerCase()||"tender"}_${e}.pdf`;I=(await (0,_.put)(t,M,{access:"public",contentType:"application/pdf"})).url,console.log("[v0] Saved to blob storage:",I),await i.from("user_custom_tender_documents").insert({tender_id:a,user_id:s.id,file_name:t,blob_url:I,file_type:"application/pdf",is_filled:!0,created_at:new Date().toISOString()})}catch(e){console.log("[v0] Could not save to blob storage:",e)}return new Response(M,{headers:{"Content-Type":"application/pdf","Content-Disposition":`attachment; filename="filled_tender_${d.title?.replace(/[^a-z0-9]/gi,"_").toLowerCase()||"document"}.pdf"`,"X-Fields-Created":String(S),"X-Fields-Filled":String(T),"X-Total-Pages":String(o.getPageCount()),"X-Saved-Blob-Url":I||""}})}catch(e){return console.error("[v0] Error generating filled editable PDF:",e),Response.json({error:e.message||"Failed to generate filled editable PDF"},{status:500})}}e.s(["POST",()=>L],959087);var O=e.i(959087);let $=new t.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/custom-tenders/[id]/generate-filled-editable/route",pathname:"/api/custom-tenders/[id]/generate-filled-editable",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/custom-tenders/[id]/generate-filled-editable/route.ts",nextConfigOutput:"",userland:O}),{workAsyncStorage:k,workUnitAsyncStorage:N,serverHooks:z}=$;function M(){return(0,r.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:N})}async function I(e,t,r){$.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let b="/api/custom-tenders/[id]/generate-filled-editable/route";b=b.replace(/\/index$/,"")||"/";let y=await $.prepare(e,t,{srcPage:b,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:x,params:C,nextConfig:R,parsedUrl:_,isDraftMode:P,prerenderManifest:E,routerServerContext:F,isOnDemandRevalidate:T,revalidateOnlyGenerated:S,resolvedPathname:D,clientReferenceManifest:A,serverActionsManifest:L}=y,O=(0,s.normalizeAppPath)(b),k=!!(E.dynamicRoutes[O]||E.routes[D]),N=async()=>((null==F?void 0:F.render404)?await F.render404(e,t,_,!1):t.end("This page could not be found"),null);if(k&&!P){let e=!!E.routes[D],t=E.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await N();throw new m.NoFallbackError}}let z=null;!k||$.isDev||P||(z="/index"===(z=D)?"/":z);let M=!0===$.isDev||!k,I=k&&!M;L&&A&&(0,n.setReferenceManifestsSingleton)({page:b,clientReferenceManifest:A,serverActionsManifest:L,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:L})});let U=e.method||"GET",q=(0,l.getTracer)(),H=q.getActiveScopeSpan(),j={params:C,prerenderManifest:E,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,o,r)=>$.onRequestError(e,t,r,F)},sharedContext:{buildId:x}},B=new d.NodeNextRequest(e),G=new d.NodeNextResponse(t),K=c.NextRequestAdapter.fromNodeNextRequest(B,(0,c.signalFromNodeResponse)(t));try{let n=async e=>$.handle(K,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let o=q.getRootSpanAttributes();if(!o)return;if(o.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${o.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=o.get("next.route");if(r){let t=`${U} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${b}`)}),i=!!(0,a.getRequestMeta)(e,"minimalMode"),s=async a=>{var l,s;let d=async({previousCacheEntry:o})=>{try{if(!i&&T&&S&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let l=await n(a);e.fetchMetrics=j.renderOpts.fetchMetrics;let s=j.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let d=j.renderOpts.collectedTags;if(!k)return await (0,p.sendResponse)(B,G,l,j.renderOpts.pendingWaitUntil),null;{let e=await l.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(l.headers);d&&(t[w.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let o=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,r=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:l.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:o,expire:r}}}}catch(t){throw(null==o?void 0:o.isStale)&&await $.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:I,isOnDemandRevalidate:T})},F),t}},c=await $.handleResponse({req:e,nextConfig:R,cacheKey:z,routeKind:o.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:E,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:S,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:i});if(!k)return null;if((null==c||null==(l=c.value)?void 0:l.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(s=c.value)?void 0:s.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",T?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),P&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,f.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&k||u.delete(w.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,h.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(B,G,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};H?await s(H):await q.withPropagatedContext(e.headers,()=>q.trace(u.BaseServerSpan.handleRequest,{spanName:`${U} ${b}`,kind:l.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},s))}catch(t){if(t instanceof m.NoFallbackError||await $.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:I,isOnDemandRevalidate:T})}),k)throw t;return await (0,p.sendResponse)(B,G,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>M,"routeModule",()=>$,"serverHooks",()=>z,"workAsyncStorage",()=>k,"workUnitAsyncStorage",()=>N],99231)}];

//# sourceMappingURL=38113_next_dist_esm_build_templates_app-route_ee544133.js.map