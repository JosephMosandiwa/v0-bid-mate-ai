module.exports=[464422,19863,291853,e=>{"use strict";let t={version:"1.0.0",requiredFields:["title","organization"],optionalFields:["tender_reference","close_date","description","category","location","estimated_value","publish_date","opening_date","contact_person","contact_email","contact_phone","submission_method","requirements","eligibility_criteria","payment_terms","contract_duration","compulsory_briefing","tender_type","procurement_category"],documentTypes:["Tender Document","Terms of Reference","Specifications","Pricing Schedule","SBD Forms","Declaration Forms","Technical Requirements","Contract Terms"],fields:[{name:"tender_reference",displayName:"Tender Reference Number",type:"string",required:!1,description:"Unique identifier for the tender",extractionHints:{aliases:["tender number","reference","tender no","ref no","reference number","tender id"],patterns:["\\b[A-Z]{2,}[\\/-]?\\d{2,}[\\/-]?\\d{2,}\\b","\\bT\\d{4,}\\b","\\b\\d{2,}\\/\\d{4}\\b"],context:["reference","tender","number","quotation"],priority:10}},{name:"title",displayName:"Tender Title",type:"string",required:!0,description:"The main title or subject of the tender",extractionHints:{aliases:["tender title","subject","project name","tender for"],patterns:[],context:["tender","project","supply","services","appointment"],priority:10}},{name:"organization",displayName:"Issuing Organization",type:"string",required:!0,description:"The organization issuing the tender",extractionHints:{aliases:["organization","department","municipality","entity","client","issuer"],patterns:[],context:["municipality","department","ministry","council"],priority:9}},{name:"description",displayName:"Description",type:"string",required:!1,description:"Detailed description of what is being procured",extractionHints:{aliases:["description","scope","scope of work","requirements","details"],patterns:[],context:["scope","required","must","shall","includes"],priority:8}},{name:"category",displayName:"Category",type:"string",required:!1,description:"The procurement category or sector",extractionHints:{aliases:["category","sector","type","classification"],patterns:[],context:["construction","it","services","goods","works"],priority:7}},{name:"location",displayName:"Location",type:"string",required:!1,description:"Physical location or province",extractionHints:{aliases:["location","province","region","area","place"],patterns:["Gauteng|Western Cape|Eastern Cape|KwaZulu-Natal|Free State|Limpopo|Mpumalanga|Northern Cape|North West"],context:["province","located","region"],priority:6}},{name:"estimated_value",displayName:"Estimated Value",type:"string",required:!1,description:"The estimated contract value",extractionHints:{aliases:["value","budget","amount","contract value","estimated cost"],patterns:["R\\s?[\\d,]+","ZAR\\s?[\\d,]+"],context:["value","budget","rand","amount"],priority:8}},{name:"publish_date",displayName:"Publish Date",type:"date",required:!1,description:"When the tender was published",extractionHints:{aliases:["publish date","publication date","advertised","issued date"],patterns:["\\d{1,2}[\\/-]\\d{1,2}[\\/-]\\d{2,4}","\\d{4}[\\/-]\\d{2}[\\/-]\\d{2}"],context:["published","advertised","issued"],priority:5}},{name:"close_date",displayName:"Closing Date",type:"date",required:!1,description:"Submission deadline",validationRules:{format:"ISO8601"},extractionHints:{aliases:["closing date","deadline","submission date","due date","closes"],patterns:["\\d{1,2}[\\/-]\\d{1,2}[\\/-]\\d{2,4}","\\d{4}[\\/-]\\d{2}[\\/-]\\d{2}"],context:["closing","deadline","closes","due"],priority:10}},{name:"opening_date",displayName:"Opening Date",type:"date",required:!1,description:"When bids will be opened",extractionHints:{aliases:["opening date","bid opening","tender opening"],patterns:["\\d{1,2}[\\/-]\\d{1,2}[\\/-]\\d{2,4}","\\d{4}[\\/-]\\d{2}[\\/-]\\d{2}"],context:["opening","bids will be opened"],priority:4}},{name:"contact_person",displayName:"Contact Person",type:"string",required:!1,description:"Name of contact person",extractionHints:{aliases:["contact person","contact","enquiries","contact name"],patterns:["[A-Z][a-z]+\\s+[A-Z][a-z]+"],context:["contact","enquiries","person"],priority:5}},{name:"contact_email",displayName:"Contact Email",type:"string",required:!1,description:"Email address for enquiries",validationRules:{pattern:"^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$"},extractionHints:{aliases:["email","e-mail","email address"],patterns:["[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}"],context:["email","contact","enquiries"],priority:6}},{name:"contact_phone",displayName:"Contact Phone",type:"string",required:!1,description:"Phone number for enquiries",extractionHints:{aliases:["phone","telephone","tel","contact number"],patterns:["\\+?27\\s?\\d{2}\\s?\\d{3}\\s?\\d{4}","$$?0\\d{2}$$?\\s?\\d{3}\\s?\\d{4}"],context:["phone","tel","contact","call"],priority:5}},{name:"requirements",displayName:"Requirements",type:"array",required:!1,description:"List of tender requirements",extractionHints:{aliases:["requirements","mandatory requirements","prerequisites","must have"],patterns:[],context:["required","must","mandatory","compulsory"],priority:7}},{name:"eligibility_criteria",displayName:"Eligibility Criteria",type:"array",required:!1,description:"Who can bid",extractionHints:{aliases:["eligibility","eligible","who may bid","qualification criteria"],patterns:[],context:["eligible","may bid","qualified","registration"],priority:6}},{name:"compulsory_briefing",displayName:"Compulsory Briefing",type:"string",required:!1,description:"Information about mandatory briefing sessions",extractionHints:{aliases:["compulsory briefing","mandatory briefing","site visit","pre-bid meeting"],patterns:[],context:["compulsory","mandatory","briefing","meeting","site"],priority:7}},{name:"tender_type",displayName:"Tender Type",type:"string",required:!1,description:"Type of procurement (RFQ, RFP, etc)",extractionHints:{aliases:["tender type","procurement type","bid type"],patterns:["RFQ|RFP|RFI|ITB|EOI"],context:["request for","quotation","proposal"],priority:5}}]};class r{static validate(e){let r=[],s=[],o=[];for(let s of t.requiredFields)e[s]&&""!==e[s]||(r.push({field:s,message:`Required field '${s}' is missing or empty`,severity:"error"}),o.push(s));for(let r of t.optionalFields)e[r]&&""!==e[r]||(s.push(`Optional field '${r}' is missing - tender may be incomplete`),o.push(r));let n=e.contact_email;n&&!this.isValidEmail(n)&&r.push({field:"contact_email",message:"Invalid email format",severity:"warning"});let i=t.requiredFields.length+t.optionalFields.length,a=Math.round((i-o.length)/i*100);return{isValid:0===r.filter(e=>"error"===e.severity).length,score:a,errors:r,missingFields:o,warnings:s}}static isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}static getQualityScore(e){let t=this.validate(e),r=[];100===t.score?r.push("✓ All fields populated"):t.score>=80?r.push("✓ Most important fields populated"):t.score>=60?r.push("⚠ Missing some important information"):r.push("✗ Tender data is incomplete"),t.missingFields.includes("tender_reference")&&r.push("✗ Missing tender reference number"),t.missingFields.includes("close_date")&&r.push("✗ Missing closing date"),t.missingFields.includes("contact_email")&&r.push("⚠ No contact email found"),t.missingFields.includes("estimated_value")&&r.push("⚠ No tender value information");let s=t.score>=90?"A":t.score>=80?"B":t.score>=70?"C":t.score>=60?"D":"F";return{score:t.score,grade:s,feedback:r}}}e.s(["TenderValidator",()=>r],19863);class s{static getTenderSchema(){return t}static getExtractionHints(){return t.fields.map(e=>({field:e.name,displayName:e.displayName,...e.extractionHints}))}static validateTender(e){return r.validate(e)}static getTenderQuality(e){return r.getQualityScore(e)}static normalizeScrapedData(e){let r={};for(let s of t.fields){let t=e[s.name];if(!t)for(let r of s.extractionHints.aliases){let s=Object.keys(e).find(e=>e.toLowerCase()===r.toLowerCase());if(s){t=e[s];break}}t&&(r[s.name]=t)}return r}static async extractTenderFromDocument(e){console.log("[v0] TenderService: Extracting tender data from document");let r={},s=e.pages.map(e=>e.content.full_text).join("\n");for(let e of t.fields){let t=e.extractionHints;for(let o of t.patterns){let t=RegExp(o,"i"),n=s.match(t);if(n&&n[1]){r[e.name]=n[1].trim(),console.log(`[v0] TenderService: Found ${e.name}: ${r[e.name]}`);break}}if(!r[e.name])for(let o of t.context){let t=RegExp(`${o}[:\\s]+(.*?)(?:\\n|$)`,"i"),n=s.match(t);if(n&&n[1]){r[e.name]=n[1].trim(),console.log(`[v0] TenderService: Found ${e.name} via context: ${r[e.name]}`);break}}}let o=this.validateTender(r);return o.score<20?(console.warn("[v0] TenderService: Not enough tender data found in document"),null):(console.log(`[v0] TenderService: Extracted tender data with ${o.score}% completeness`),this.normalizeScrapedData(r))}static getTenderAnalysisContext(e){this.validateTender(e);let r=this.getTenderQuality(e);return`
Tender Data Quality: ${r.grade} (${r.score}%)

Available Fields:
${t.fields.map(t=>`- ${t.displayName}: ${e[t.name]?"✓":"✗"}`).join("\n")}

Data Completeness:
${r.feedback.join("\n")}

This context helps you understand what information is available for analysis.
    `.trim()}}function o(e){return s.validateTender(e)}function n(e){return s.normalizeScrapedData(e)}e.s(["TenderService",()=>s],291853),e.s(["normalizeTenderData",()=>n,"validateTender",()=>o],464422)},367920,e=>{"use strict";var t=e.i(18444),r=e.i(464422),s=e.i(291853);e.i(754105);var o=e.i(464124),n=e.i(912130),i=e.i(161513);let a=new class{async processScrapedTender(e,s){try{console.log("[v0] Orchestrator: Processing scraped tender:",e.title),console.log("[v0] Orchestrator: Step 1 - Validating tender data...");let n=(0,r.validateTender)(e);console.log("[v0] Orchestrator: Validation result:",{score:n.score,isValid:n.isValid,errors:n.errors?.length||0}),console.log(`[v0] Orchestrator: Processing tender - Score: ${n.score}`);let i=(0,r.normalizeTenderData)(e),a=[];if(e.document_urls&&e.document_urls.length>0)for(let r of(console.log(`[v0] Orchestrator: Step 2 - Processing ${e.document_urls.length} documents...`),e.document_urls.slice(0,3)))try{let e="string"==typeof r?r:r.url,s=await fetch(e),o=await s.arrayBuffer(),n=await (0,t.processDocument)(o,"application/pdf",{extract_images:!1,ocr_enabled:!0});n.success&&n.document&&(a.push(n.document),console.log(`[v0] Orchestrator: Document processed successfully: ${e}`))}catch(e){console.error("[v0] Orchestrator: Document processing failed:",e)}let c=[];if(s){console.log("[v0] Orchestrator: Step 3 - Analyzing opportunities for user...");try{let t=await o.OpportunityService.createOpportunity({userId:s,tenderId:e.scraped_tender_id||e.tender_reference||"",tenderType:"scraped",tenderTitle:i.title,tenderData:i});t&&(c.push(t),console.log(`[v0] Orchestrator: Opportunity created with score: ${t.match_score}`))}catch(e){console.error("[v0] Orchestrator: Opportunity creation failed:",e)}}return{success:!0,tender:i,validation:n,documents:a,opportunities:c}}catch(e){return console.error("[v0] Orchestrator: Error processing scraped tender:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async processUploadedDocument(e,o,n){try{console.log("[v0] Orchestrator: Processing uploaded document"),console.log("[v0] Orchestrator: Step 1 - Extracting document content...");let n=await (0,t.processDocument)(e,o,{extract_images:!1,ocr_enabled:!0});if(!n.success||!n.document)return{success:!1,error:n.error?.message||"Document processing failed"};let i=n.document;console.log(`[v0] Orchestrator: Document processed - ${i.pages.length} pages, ${i.form_fields?.length||0} form fields`),console.log("[v0] Orchestrator: Step 2 - Extracting tender data from document...");let a=await s.TenderService.extractTenderFromDocument(i);if(!a)return console.warn("[v0] Orchestrator: Could not extract tender data from document"),{success:!0,document:i,error:"Could not identify tender fields in document"};console.log("[v0] Orchestrator: Step 3 - Validating extracted tender data...");let c=(0,r.validateTender)(a),l=(0,r.normalizeTenderData)(a);return console.log(`[v0] Orchestrator: Tender extracted - Score: ${c.score}`),{success:!0,document:i,extractedTenderData:l,validation:c}}catch(e){return console.error("[v0] Orchestrator: Error processing uploaded document:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async enrichTenderWithStrategy(e,t,r){try{console.log(`[v0] Orchestrator: Enriching tender ${e} with strategy for user ${r}`),console.log("[v0] Orchestrator: Step 1 - Calculating competitiveness...");let s=await n.CompetitivenessService.calculateScore({userId:r,tenderId:e,tenderType:t});console.log("[v0] Orchestrator: Step 2 - Generating strategic recommendations...");let a=await i.StrategistService.generateRecommendations({userId:r,tenderId:e,tenderType:t,competitiveness:s});console.log("[v0] Orchestrator: Step 3 - Finding related opportunities...");let c=await o.OpportunityService.findSimilar({userId:r,tenderId:e,tenderType:t});return{success:!0,competitiveness:s,opportunities:c,recommendations:a}}catch(e){return console.error("[v0] Orchestrator: Error enriching tender with strategy:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}};e.s(["engineOrchestrator",0,a])},951615,(e,t,r)=>{t.exports=e.x("node:buffer",()=>require("node:buffer"))},478500,(e,t,r)=>{t.exports=e.x("node:async_hooks",()=>require("node:async_hooks"))},768523,e=>{"use strict";var t=e.i(252736),r=e.i(351278),s=e.i(680717);class o{supabase;constructor(){this.supabase=(0,t.createClient)("https://xqyecqkrtaydoesxnvlw.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY)}async downloadAndStoreDocument(e,t,r){try{console.log("[DocumentService] Downloading document:",e);let o=r?`http://api.scraperapi.com?api_key=${r}&url=${encodeURIComponent(e)}`:e,n=new AbortController,i=setTimeout(()=>n.abort(),3e4),a=await fetch(o,{signal:n.signal,headers:{"User-Agent":"BidMateAI-DocumentDownloader/1.0"}});if(clearTimeout(i),!a.ok)return console.error(`[DocumentService] Failed to download: ${a.status} ${a.statusText}`),null;let c=await a.blob(),l=c.size;if(l>0x3200000)return console.warn(`[DocumentService] File too large (${l} bytes), skipping`),null;let d=new URL(e).pathname.split("/").pop()||`document-${Date.now()}`,u=d.split(".").pop()?.toLowerCase()||"pdf",p=a.headers.get("content-type")||"application/pdf",g=new File([c],d,{type:p}),m=await (0,s.put)(`tenders/${t}/${d}`,g,{access:"public"});console.log("[DocumentService] Document uploaded to Blob:",m.url);let h={tender_id:t,document_name:d,document_type:u,original_url:e,blob_url:m.url,file_size:l},{data:v,error:f}=await this.supabase.from("tender_documents").insert(h).select().single();if(f)return console.error("[DocumentService] Error saving to database:",f),null;return console.log("[DocumentService] Document saved:",v.id),v}catch(t){return t instanceof Error&&"AbortError"===t.name?console.error("[DocumentService] Download timed out for:",e):console.error("[DocumentService] Error downloading/storing document:",t),null}}async downloadTenderDocuments(e,t,r){console.log(`[DocumentService] Downloading ${e.length} documents for tender ${t}`);let s=[],o=e.map(e=>"string"==typeof e?e:e.url).filter(e=>!!e);for(let e of o){try{let o=await this.downloadAndStoreDocument(e,t,r);o&&s.push(o)}catch(t){console.error(`[DocumentService] Failed to download ${e}:`,t)}await new Promise(e=>setTimeout(e,1e3))}return console.log(`[DocumentService] Successfully downloaded ${s.length}/${o.length} documents`),s}async getTenderDocuments(e){let{data:t,error:r}=await this.supabase.from("tender_documents").select("*").eq("tender_id",e).order("created_at",{ascending:!1});return r?(console.error("[DocumentService] Error fetching tender documents:",r),[]):t||[]}async documentExists(e,t){let{count:r}=await this.supabase.from("tender_documents").select("*",{count:"exact",head:!0}).eq("tender_id",e).eq("original_url",t);return(r||0)>0}}var n=e.i(367920);class i{supabase;documentService;postScrapeHooks=[];constructor(){this.supabase=(0,t.createClient)("https://xqyecqkrtaydoesxnvlw.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),this.documentService=new o,this.registerHooks()}registerHooks(){this.postScrapeHooks.push({name:"opportunity_matcher",execute:async(e,t)=>{if(0===e.length)return;console.log(`[ScrapingService] Running opportunity matcher for ${e.length} tenders`);let{data:r}=await t.from("strategist_user_preferences").select("user_id, provinces, industries, experience_level, annual_turnover").eq("onboarding_completed",!0);if(r&&0!==r.length){for(let s of r)for(let r of e){let e=this.calculateMatchScore(r,s);e>=.3&&await t.from("strategist_opportunities").upsert({user_id:s.user_id,scraped_tender_id:r.id,match_score:e,match_reasons:this.getMatchReasons(r,s),opportunity_type:e>=.7?"high_margin":e>=.5?"strategic":"growth",is_viewed:!1,is_saved:!1,is_dismissed:!1,expires_at:r.close_date},{onConflict:"user_id, scraped_tender_id"})}console.log("[ScrapingService] Opportunity matching complete")}}}),this.postScrapeHooks.push({name:"alert_generator",execute:async(e,t)=>{if(0===e.length)return;console.log("[ScrapingService] Checking for alert-worthy tenders");let{data:r}=await t.from("strategist_user_preferences").select("user_id, notification_preferences").eq("onboarding_completed",!0);if(r)for(let s of r){if(!(s.notification_preferences||{}).new_opportunities)continue;let{data:r}=await t.from("strategist_opportunities").select("id, match_score, scraped_tender_id").eq("user_id",s.user_id).gte("match_score",.6).in("scraped_tender_id",e.map(e=>e.id));r&&r.length>0&&await t.from("strategist_alerts").insert({user_id:s.user_id,alert_type:"new_opportunity",title:`${r.length} New Matching Tenders`,message:`We found ${r.length} new tender${r.length>1?"s":""} that match your profile. Check them out!`,priority:r.some(e=>e.match_score>=.8)?"high":"medium",action_url:"/dashboard/strategist?tab=opportunities",action_label:"View Opportunities"})}}}),this.postScrapeHooks.push({name:"stats_logger",execute:async(e,t)=>{await t.from("scraping_usage_logs").insert({tenders_found:e.length,success:!0,scrape_type:"batch",api_credits_used:1})}})}calculateMatchScore(e,t){let r=0;if(t.provinces?.length&&e.source_province&&t.provinces.some(t=>e.source_province?.toLowerCase().includes(t.toLowerCase()))&&(r+=.25),t.industries?.length&&e.category){let s=e.category.toLowerCase();t.industries.some(e=>s.includes(e.toLowerCase())||e.toLowerCase().includes(s))&&(r+=.3)}if(t.annual_turnover&&e.estimated_value&&(r+=.2),e.close_date){let t=Math.ceil((new Date(e.close_date).getTime()-Date.now())/864e5);t>14?r+=.25:t>7?r+=.15:r+=.05}return Math.min(r,1)}getMatchReasons(e,t){let r=[];if(t.provinces?.some(t=>e.source_province?.toLowerCase().includes(t.toLowerCase()))&&r.push("Matches your preferred province"),t.industries?.some(t=>e.category?.toLowerCase().includes(t.toLowerCase()))&&r.push("Matches your industry focus"),e.close_date){let t=Math.ceil((new Date(e.close_date).getTime()-Date.now())/864e5);t>14?r.push("Good preparation time available"):t>7&&r.push("Adequate preparation time")}return r}async scrapeSource(e){try{console.log(`[ScrapingService] Starting scrape for source ${e}`);let{data:t,error:s}=await this.supabase.from("tender_sources").select("*").eq("id",e).single();if(s||!t)throw Error(`Source not found: ${e}`);if(!t.is_active||!t.scraping_enabled)return console.log(`[ScrapingService] Source ${e} is not active or scraping is disabled`),{success:!1,message:"Source is not active or scraping is disabled"};let o=r.ScraperFactory.createScraper(t),n=await o.scrape(),i=[];if(n.success&&n.tenders.length>0)for(let r of(console.log(`[ScrapingService] Saving ${n.tenders.length} tenders to database`),(i=await this.saveTenders(e,t,n.tenders))&&i.length>0&&(console.log(`[ScrapingService] Starting document download for ${i.length} tenders`),await this.downloadTenderDocuments(i)),console.log(`[ScrapingService] Running ${this.postScrapeHooks.length} post-scrape hooks`),this.postScrapeHooks))try{await r.execute(i,this.supabase)}catch(e){console.error(`[ScrapingService] Hook ${r.name} failed:`,e)}return await this.updateSourceStats(e,n),{success:n.success,scrapedCount:n.scrapedCount,savedCount:i.length,error:n.error}}catch(t){return console.error(`[ScrapingService] Error scraping source ${e}:`,t),await this.supabase.from("tender_sources").update({last_scrape_status:"failed",last_scrape_error:t instanceof Error?t.message:"Unknown error"}).eq("id",e),await this.supabase.from("scraping_usage_logs").insert({source_id:e,tenders_found:0,success:!1,scrape_type:"single",error_message:t instanceof Error?t.message:"Unknown error"}),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}async saveTenders(e,t,r){console.log(`[v0] ScrapingService: Processing ${r.length} tenders through engine orchestrator`),console.log("[v0] ScrapingService: ==================== DETAILED TENDER ANALYSIS ===================="),console.log(`[v0] ScrapingService: Source: ${t.name}`),console.log(`[v0] ScrapingService: Found ${r.length} raw tender(s) to validate`);let s=[];for(let o=0;o<r.length;o++){let i=r[o];console.log(`
[v0] ScrapingService: ========== Tender ${o+1}/${r.length} ==========`),console.log(`[v0] ScrapingService: Title: ${i.title}`);let a=await n.engineOrchestrator.processScrapedTender(i);a.tender?(console.log(`[v0] ScrapingService: ✓ Tender ACCEPTED - ${a.tender.title} (${a.validation?.grade}, ${(a.validation?.completeness??0)*100}% complete)`),s.push({source_id:e,source_name:t.name,source_url:t.tender_page_url,source_level:t.level,source_province:t.province,...a.tender,is_active:!0,quality_score:a.validation?.completeness||0,quality_grade:a.validation?.grade||"C"})):(console.warn(`[v0] ScrapingService: ⚠️ Warning - Could not process tender: ${i.title}`),console.warn(`[v0] ScrapingService:   Error: ${a.error||"Unknown error"}`))}if(console.log(`
[v0] ScrapingService: ==================== VALIDATION SUMMARY ====================`),console.log(`[v0] ScrapingService: Total scraped: ${r.length}`),console.log(`[v0] ScrapingService: Processed: ${s.length}`),console.log(`[v0] ScrapingService: Failed to process: ${r.length-s.length}`),0===s.length)return console.log("[v0] ScrapingService: ⚠️ WARNING: NO TENDERS COULD BE PROCESSED!"),[];console.log(`[v0] ScrapingService: Saving ${s.length} tenders to database`);let o=[];for(let e of s)try{let{data:t}=await this.supabase.from("scraped_tenders").select("id, title").eq("source_id",e.source_id).ilike("title",e.title).maybeSingle();if(t){console.log(`[v0] ScrapingService: Tender already exists (ID: ${t.id}): ${e.title}`),o.push(t);continue}let{data:r,error:s}=await this.supabase.from("scraped_tenders").insert(e).select().single();if(s){console.error(`[v0] ScrapingService: ❌ Error saving tender "${e.title}":`,s.message),console.error("[v0] ScrapingService: Error details:",JSON.stringify(s,null,2));continue}r&&(console.log(`[v0] ScrapingService: ✓ Successfully saved new tender (ID: ${r.id}): ${e.title}`),o.push(r))}catch(t){console.error(`[v0] ScrapingService: ❌ Exception saving tender "${e.title}":`,t)}return console.log(`
[v0] ScrapingService: ==================== SAVE SUMMARY ====================`),console.log(`[v0] ScrapingService: Attempted to save: ${s.length}`),console.log(`[v0] ScrapingService: Successfully saved: ${o.filter(e=>!e.title).length} new tenders`),console.log(`[v0] ScrapingService: Duplicates skipped: ${o.filter(e=>e.title).length}`),console.log(`[v0] ScrapingService: Failed: ${s.length-o.length}`),o}async downloadTenderDocuments(e){let t=process.env.SCRAPING_API_KEY;for(let r of e)if(r.document_urls&&Array.isArray(r.document_urls)&&r.document_urls.length>0){console.log(`[ScrapingService] Downloading ${r.document_urls.length} documents for tender: ${r.title}`);try{let e=r.document_urls.map(e=>"string"==typeof e?e:e.url).filter(Boolean);e.length>0&&await this.documentService.downloadTenderDocuments(e,r.id,t)}catch(e){console.error(`[ScrapingService] Error downloading documents for tender ${r.id}:`,e)}}}async updateSourceStats(e,t){let{data:r}=await this.supabase.from("tender_sources").select("total_tenders_scraped").eq("id",e).single(),s=(r?.total_tenders_scraped||0)+(t.scrapedCount||0);await this.supabase.from("tender_sources").update({last_scraped_at:new Date().toISOString(),last_scrape_status:t.success?"success":"failed",last_scrape_error:t.error||null,total_tenders_scraped:t.success?s:r?.total_tenders_scraped||0}).eq("id",e)}async scrapeAllActiveSources(e){console.log("[v0] ScrapingService: Starting scrape for all active sources");let{data:t,error:r}=await this.supabase.from("tender_sources").select("id, name, tender_page_url, scraping_enabled, is_active").eq("is_active",!0).eq("scraping_enabled",!0);if(r||!t)return console.error("[v0] ScrapingService: Error fetching active sources:",r),e&&await this.supabase.from("scraping_progress").update({status:"failed",error_message:"Failed to fetch active sources"}).eq("id",e),{success:!1,error:"Failed to fetch active sources"};if(console.log(`[v0] ScrapingService: Found ${t.length} active sources to scrape`),0===t.length?(console.warn("[v0] ScrapingService: ⚠️ WARNING - NO ACTIVE SOURCES FOUND!"),console.warn("[v0] ScrapingService: Please check the tender_sources table:"),console.warn("[v0] ScrapingService: - Ensure rows exist in the table"),console.warn("[v0] ScrapingService: - Ensure is_active = true"),console.warn("[v0] ScrapingService: - Ensure scraping_enabled = true"),e&&await this.supabase.from("scraping_progress").update({status:"completed",completed_sources:0,total_sources:0}).eq("id",e)):(t.forEach((e,t)=>{console.log(`[v0] ScrapingService: Source ${t+1}: ${e.name} - ${e.tender_page_url}`)}),e&&await this.supabase.from("scraping_progress").update({total_sources:t.length}).eq("id",e)),0===t.length)return{success:!0,results:[],totalScraped:0,sourcesScraped:0,successfulSources:0,message:"No active sources available to scrape"};let s=[];for(let r=0;r<t.length;r++){let o=t[r];console.log(`[v0] ScrapingService: Scraping source ${r+1}/${t.length}: ${o.name}`),e&&await this.supabase.from("scraping_progress").update({current_source:o.name,current_source_id:o.id,completed_sources:r}).eq("id",e);let n=await this.scrapeSource(o.id);if(s.push({sourceId:o.id,sourceName:o.name,...n}),e&&n.scrapedCount){let{data:t}=await this.supabase.from("scraping_progress").select("total_tenders").eq("id",e).single();await this.supabase.from("scraping_progress").update({total_tenders:(t?.total_tenders||0)+n.scrapedCount}).eq("id",e)}await new Promise(e=>setTimeout(e,2e3))}let o=s.reduce((e,t)=>e+(t.scrapedCount||0),0),n=s.filter(e=>e.success).length;return e&&await this.supabase.from("scraping_progress").update({status:"completed",completed_sources:t.length,current_source:null}).eq("id",e),console.log(`[v0] ScrapingService: Completed scraping ${t.length} sources, total tenders: ${o}`),{success:!0,results:s,totalScraped:o,sourcesScraped:t.length,successfulSources:n}}}e.s(["ScrapingService",()=>i],768523)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__a32bbeb1._.js.map